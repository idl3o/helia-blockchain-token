(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Libp2P = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Libp2P=(()=>{var ip=Object.create;var Ao=Object.defineProperty;var ap=Object.getOwnPropertyDescriptor;var cp=Object.getOwnPropertyNames;var lp=Object.getPrototypeOf,up=Object.prototype.hasOwnProperty;var Ir=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),Ft=(r,t)=>{for(var e in t)Ao(r,e,{get:t[e],enumerable:!0})},cu=(r,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of cp(t))!up.call(r,o)&&o!==e&&Ao(r,o,{get:()=>t[o],enumerable:!(n=ap(t,o))||n.enumerable});return r};var _o=(r,t,e)=>(e=r!=null?ip(lp(r)):{},cu(t||!r||!r.__esModule?Ao(e,"default",{value:r,enumerable:!0}):e,r)),fp=r=>cu(Ao({},"__esModule",{value:!0}),r);var wd=Ir((zE,Mc)=>{"use strict";var Hg=Object.prototype.hasOwnProperty,Ot="~";function Yn(){}Object.create&&(Yn.prototype=Object.create(null),new Yn().__proto__||(Ot=!1));function $g(r,t,e){this.fn=r,this.context=t,this.once=e||!1}function yd(r,t,e,n,o){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new $g(e,n||r,o),i=Ot?Ot+t:t;return r._events[i]?r._events[i].fn?r._events[i]=[r._events[i],s]:r._events[i].push(s):(r._events[i]=s,r._eventsCount++),r}function ls(r,t){--r._eventsCount===0?r._events=new Yn:delete r._events[t]}function Ct(){this._events=new Yn,this._eventsCount=0}Ct.prototype.eventNames=function(){var t=[],e,n;if(this._eventsCount===0)return t;for(n in e=this._events)Hg.call(e,n)&&t.push(Ot?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};Ct.prototype.listeners=function(t){var e=Ot?Ot+t:t,n=this._events[e];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,s=n.length,i=new Array(s);o<s;o++)i[o]=n[o].fn;return i};Ct.prototype.listenerCount=function(t){var e=Ot?Ot+t:t,n=this._events[e];return n?n.fn?1:n.length:0};Ct.prototype.emit=function(t,e,n,o,s,i){var a=Ot?Ot+t:t;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,o),!0;case 5:return c.fn.call(c.context,e,n,o,s),!0;case 6:return c.fn.call(c.context,e,n,o,s,i),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var d=c.length,g;for(f=0;f<d;f++)switch(c[f].once&&this.removeListener(t,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,e);break;case 3:c[f].fn.call(c[f].context,e,n);break;case 4:c[f].fn.call(c[f].context,e,n,o);break;default:if(!u)for(g=1,u=new Array(l-1);g<l;g++)u[g-1]=arguments[g];c[f].fn.apply(c[f].context,u)}}return!0};Ct.prototype.on=function(t,e,n){return yd(this,t,e,n,!1)};Ct.prototype.once=function(t,e,n){return yd(this,t,e,n,!0)};Ct.prototype.removeListener=function(t,e,n,o){var s=Ot?Ot+t:t;if(!this._events[s])return this;if(!e)return ls(this,s),this;var i=this._events[s];if(i.fn)i.fn===e&&(!o||i.once)&&(!n||i.context===n)&&ls(this,s);else{for(var a=0,c=[],l=i.length;a<l;a++)(i[a].fn!==e||o&&!i[a].once||n&&i[a].context!==n)&&c.push(i[a]);c.length?this._events[s]=c.length===1?c[0]:c:ls(this,s)}return this};Ct.prototype.removeAllListeners=function(t){var e;return t?(e=Ot?Ot+t:t,this._events[e]&&ls(this,e)):(this._events=new Yn,this._eventsCount=0),this};Ct.prototype.off=Ct.prototype.removeListener;Ct.prototype.addListener=Ct.prototype.on;Ct.prefixed=Ot;Ct.EventEmitter=Ct;typeof Mc<"u"&&(Mc.exports=Ct)});var Sd=Ir((fv,vd)=>{vd.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),n=Object.create(null);function o(s,i){e[s]=i,t++,t>=r&&(t=0,n=e,e=Object.create(null))}return{has:function(s){return e[s]!==void 0||n[s]!==void 0},remove:function(s){e[s]!==void 0&&(e[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var i=e[s];if(i!==void 0)return i;if((i=n[s])!==void 0)return o(s,i),i},set:function(s,i){e[s]!==void 0?e[s]=i:o(s,i)},clear:function(){e=Object.create(null),n=Object.create(null)}}}});var dh=Ir(lo=>{(function(){var r,t,e,n,o,s,i,a;a=function(c){var l,u,f,d;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,d=c&255,[l,u,f,d].join(".")},i=function(c){var l,u,f,d,g,p;for(l=[],f=d=0;d<=3&&c.length!==0;f=++d){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=t(c),g=p[0],u=p[1],c=c.substring(u),l.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},e=function(c){return c.charCodeAt(0)},n=e("0"),s=e("a"),o=e("A"),t=function(c){var l,u,f,d,g;for(d=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),g=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)d=d*l+(e(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")d=d*l+(10+e(c[f])-s)>>>0;else if("A"<=c[f]&&c[f]<="F")d=d*l+(10+e(c[f])-o)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");f++}if(f===g)throw new Error("empty octet");return[d,f]},r=function(){function c(l,u){var f,d,g,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(p=l.split("/",2),l=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=i(u)}catch(m){throw f=m,new Error("Invalid mask: "+u)}for(d=g=32;g>=0;d=--g)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(i(l)&this.maskLong)>>>0}catch(m){throw f=m,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(i(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,d;for(d=i(this.first),f=i(this.last),u=0;d<=f;)l(a(d),d,u),u++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),lo.ip2long=i,lo.long2ip=a,lo.Netmask=r}).call(lo)});var Kh=Ir((tI,Uh)=>{function Wt(r,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Uh.exports=Wt;Wt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Wt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Wt.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var t=new Date().getTime();if(r&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var e=this._timeouts.shift();if(e===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),e=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},e),this._options.unref&&this._timer.unref(),!0};Wt.prototype.attempt=function(r,t){this._fn=r,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var e=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){e._operationTimeoutCb()},e._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Wt.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Wt.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Wt.prototype.start=Wt.prototype.try;Wt.prototype.errors=function(){return this._errors};Wt.prototype.attempts=function(){return this._attempts};Wt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},t=null,e=0,n=0;n<this._errors.length;n++){var o=this._errors[n],s=o.message,i=(r[s]||0)+1;r[s]=i,i>=e&&(t=o,e=i)}return t}});var qh=Ir(Sr=>{var tw=Kh();Sr.operation=function(r){var t=Sr.timeouts(r);return new tw(t,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};Sr.timeouts=function(r){if(r instanceof Array)return[].concat(r);var t={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var e in r)t[e]=r[e];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],o=0;o<t.retries;o++)n.push(this.createTimeout(o,t));return r&&r.forever&&!n.length&&n.push(this.createTimeout(o,t)),n.sort(function(s,i){return s-i}),n};Sr.createTimeout=function(r,t){var e=t.randomize?Math.random()+1:1,n=Math.round(e*Math.max(t.minTimeout,1)*Math.pow(t.factor,r));return n=Math.min(n,t.maxTimeout),n};Sr.wrap=function(r,t,e){if(t instanceof Array&&(e=t,t=null),!e){e=[];for(var n in r)typeof r[n]=="function"&&e.push(n)}for(var o=0;o<e.length;o++){var s=e[o],i=r[s];r[s]=function(c){var l=Sr.operation(t),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(d){l.retry(d)||(d&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,i),r[s].options=t}}});var Vh=Ir((rI,zh)=>{zh.exports=qh()});var Tw={};Ft(Tw,{createLibp2p:()=>Pw});var lu=Symbol.for("@libp2p/connection");var Wi=Symbol.for("@libp2p/content-routing");var ji=Symbol.for("@libp2p/peer-discovery");var Io=Symbol.for("@libp2p/peer-id");function Co(r){return!!r?.[Io]}var Xi=Symbol.for("@libp2p/peer-routing");var Yi="keep-alive";var Bw=Symbol.for("@libp2p/transport");var $e;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})($e||($e={}));var Xt=class extends Error{static name="AbortError";constructor(t="The operation was aborted"){super(t),this.name="AbortError"}};var M=class extends Error{static name="InvalidParametersError";constructor(t="Invalid parameters"){super(t),this.name="InvalidParametersError"}},Cr=class extends Error{static name="InvalidPublicKeyError";constructor(t="Invalid public key"){super(t),this.name="InvalidPublicKeyError"}},gn=class extends Error{static name="InvalidPrivateKeyError";constructor(t="Invalid private key"){super(t),this.name="InvalidPrivateKeyError"}};var Po=class extends Error{static name="ConnectionClosingError";constructor(t="The connection is closing"){super(t),this.name="ConnectionClosingError"}},Pr=class extends Error{static name="ConnectionClosedError";constructor(t="The connection is closed"){super(t),this.name="ConnectionClosedError"}};var Ge=class extends Error{static name="NotFoundError";constructor(t="Not found"){super(t),this.name="NotFoundError"}},Tr=class extends Error{static name="InvalidPeerIdError";constructor(t="Invalid PeerID"){super(t),this.name="InvalidPeerIdError"}},Te=class extends Error{static name="InvalidMultiaddrError";constructor(t="Invalid multiaddr"){super(t),this.name="InvalidMultiaddrError"}},To=class extends Error{static name="InvalidCIDError";constructor(t="Invalid CID"){super(t),this.name="InvalidCIDError"}},Lo=class extends Error{static name="InvalidMultihashError";constructor(t="Invalid Multihash"){super(t),this.name="InvalidMultihashError"}},yn=class extends Error{static name="UnsupportedProtocolError";constructor(t="Unsupported protocol error"){super(t),this.name="UnsupportedProtocolError"}},Do=class extends Error{static name="InvalidMessageError";constructor(t="Invalid message"){super(t),this.name="InvalidMessageError"}};var ko=class extends Error{static name="TimeoutError";constructor(t="Timed out"){super(t),this.name="TimeoutError"}},de=class extends Error{static name="NotStartedError";constructor(t="Not started"){super(t),this.name="NotStartedError"}};var Lr=class extends Error{static name="DialError";constructor(t="Dial error"){super(t),this.name="DialError"}};var Dr=class extends Error{static name="LimitedConnectionError";constructor(t="Limited connection"){super(t),this.name="LimitedConnectionError"}},Mo=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(t="Too many inbound protocol streams"){super(t),this.name="TooManyInboundProtocolStreamsError"}},Ro=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(t="Too many outbound protocol streams"){super(t),this.name="TooManyOutboundProtocolStreamsError"}},Le=class extends Error{static name="UnsupportedKeyTypeError";constructor(t="Unsupported key type"){super(t),this.name="UnsupportedKeyTypeError"}};var he=class extends EventTarget{#t=new Map;constructor(){super()}listenerCount(t){let e=this.#t.get(t);return e==null?0:e.length}addEventListener(t,e,n){super.addEventListener(t,e,n);let o=this.#t.get(t);o==null&&(o=[],this.#t.set(t,o)),o.push({callback:e,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(t,e,n){super.removeEventListener(t.toString(),e??null,n);let o=this.#t.get(t);o!=null&&(o=o.filter(({callback:s})=>s!==e),this.#t.set(t,o))}dispatchEvent(t){let e=super.dispatchEvent(t),n=this.#t.get(t.type);return n==null||(n=n.filter(({once:o})=>!o),this.#t.set(t.type,n)),e}safeDispatchEvent(t,e={}){return this.dispatchEvent(new CustomEvent(t,e))}};function No(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function uu(...r){let t=[];for(let e of r)No(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function fu(...r){let t=[];for(let e of r)No(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}var wn=Symbol.for("@libp2p/service-capabilities"),Zi=Symbol.for("@libp2p/service-dependencies");var ra={};Ft(ra,{base58btc:()=>G,base58flickr:()=>wp});var ub=new Uint8Array(0);function du(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}function pe(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function hu(r){return new TextEncoder().encode(r)}function pu(r){return new TextDecoder().decode(r)}function dp(r,t){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),n=0;n<e.length;n++)e[n]=255;for(var o=0;o<r.length;o++){var s=r.charAt(o),i=s.charCodeAt(0);if(e[i]!==255)throw new TypeError(s+" is ambiguous");e[i]=o}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,w=0,v=0,C=p.length;v!==C&&p[v]===0;)v++,m++;for(var x=(C-v)*u+1>>>0,h=new Uint8Array(x);v!==C;){for(var b=p[v],P=0,T=x-1;(b!==0||P<w)&&T!==-1;T--,P++)b+=256*h[T]>>>0,h[T]=b%a>>>0,b=b/a>>>0;if(b!==0)throw new Error("Non-zero carry");w=P,v++}for(var D=x-w;D!==x&&h[D]===0;)D++;for(var F=c.repeat(m);D<x;++D)F+=r.charAt(h[D]);return F}function d(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var w=0,v=0;p[m]===c;)w++,m++;for(var C=(p.length-m)*l+1>>>0,x=new Uint8Array(C);p[m];){var h=e[p.charCodeAt(m)];if(h===255)return;for(var b=0,P=C-1;(h!==0||b<v)&&P!==-1;P--,b++)h+=a*x[P]>>>0,x[P]=h%256>>>0,h=h/256>>>0;if(h!==0)throw new Error("Non-zero carry");v=b,m++}if(p[m]!==" "){for(var T=C-v;T!==C&&x[T]===0;)T++;for(var D=new Uint8Array(w+(C-T)),F=w;T!==C;)D[F++]=x[T++];return D}}}function g(p){var m=d(p);if(m)return m;throw new Error(`Non-${t} character`)}return{encode:f,decodeUnsafe:d,decode:g}}var hp=dp,pp=hp,gu=pp;var Qi=class{name;prefix;baseEncode;constructor(t,e,n){this.name=t,this.prefix=e,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},Ji=class{name;prefix;baseDecode;prefixCodePoint;constructor(t,e,n){this.name=t,this.prefix=e;let o=e.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return yu(this,t)}},ta=class{decoders;constructor(t){this.decoders=t}or(t){return yu(this,t)}decode(t){let e=t[0],n=this.decoders[e];if(n!=null)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function yu(r,t){return new ta({...r.decoders??{[r.prefix]:r},...t.decoders??{[t.prefix]:t}})}var ea=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(t,e,n,o){this.name=t,this.prefix=e,this.baseEncode=n,this.baseDecode=o,this.encoder=new Qi(t,e,n),this.decoder=new Ji(t,e,o)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}};function kr({name:r,prefix:t,encode:e,decode:n}){return new ea(r,t,e,n)}function De({name:r,prefix:t,alphabet:e}){let{encode:n,decode:o}=gu(e,r);return kr({prefix:t,name:r,encode:n,decode:s=>pe(o(s))})}function mp(r,t,e,n){let o=r.length;for(;r[o-1]==="=";)--o;let s=new Uint8Array(o*e/8|0),i=0,a=0,c=0;for(let l=0;l<o;++l){let u=t[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<e|u,i+=e,i>=8&&(i-=8,s[c++]=255&a>>i)}if(i>=e||(255&a<<8-i)!==0)throw new SyntaxError("Unexpected end of data");return s}function gp(r,t,e){let n=t[t.length-1]==="=",o=(1<<e)-1,s="",i=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],i+=8;i>e;)i-=e,s+=t[o&a>>i];if(i!==0&&(s+=t[o&a<<e-i]),n)for(;(s.length*e&7)!==0;)s+="=";return s}function yp(r){let t={};for(let e=0;e<r.length;++e)t[r[e]]=e;return t}function at({name:r,prefix:t,bitsPerChar:e,alphabet:n}){let o=yp(n);return kr({prefix:t,name:r,encode(s){return gp(s,n,e)},decode(s){return mp(s,o,e,r)}})}var G=De({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),wp=De({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var na={};Ft(na,{base32:()=>qt,base32hex:()=>vp,base32hexpad:()=>Ap,base32hexpadupper:()=>_p,base32hexupper:()=>Sp,base32pad:()=>xp,base32padupper:()=>Ep,base32upper:()=>bp,base32z:()=>Ip});var qt=at({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),bp=at({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),xp=at({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ep=at({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),vp=at({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Sp=at({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ap=at({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),_p=at({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Ip=at({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var oa={};Ft(oa,{base36:()=>bn,base36upper:()=>Cp});var bn=De({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Cp=De({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Pp=xu,wu=128,Tp=127,Lp=~Tp,Dp=Math.pow(2,31);function xu(r,t,e){t=t||[],e=e||0;for(var n=e;r>=Dp;)t[e++]=r&255|wu,r/=128;for(;r&Lp;)t[e++]=r&255|wu,r>>>=7;return t[e]=r|0,xu.bytes=e-n+1,t}var kp=sa,Mp=128,bu=127;function sa(r,n){var e=0,n=n||0,o=0,s=n,i,a=r.length;do{if(s>=a)throw sa.bytes=0,new RangeError("Could not decode varint");i=r[s++],e+=o<28?(i&bu)<<o:(i&bu)*Math.pow(2,o),o+=7}while(i>=Mp);return sa.bytes=s-n,e}var Rp=Math.pow(2,7),Np=Math.pow(2,14),Op=Math.pow(2,21),Bp=Math.pow(2,28),Fp=Math.pow(2,35),Up=Math.pow(2,42),Kp=Math.pow(2,49),qp=Math.pow(2,56),zp=Math.pow(2,63),Vp=function(r){return r<Rp?1:r<Np?2:r<Op?3:r<Bp?4:r<Fp?5:r<Up?6:r<Kp?7:r<qp?8:r<zp?9:10},Hp={encode:Pp,decode:kp,encodingLength:Vp},$p=Hp,xn=$p;function En(r,t=0){return[xn.decode(r,t),xn.decode.bytes]}function Mr(r,t,e=0){return xn.encode(r,t,e),t}function Rr(r){return xn.encodingLength(r)}function Yt(r,t){let e=t.byteLength,n=Rr(r),o=n+Rr(e),s=new Uint8Array(o+e);return Mr(r,s,0),Mr(e,s,n),s.set(t,o),new Nr(r,e,t,s)}function zt(r){let t=pe(r),[e,n]=En(t),[o,s]=En(t.subarray(n)),i=t.subarray(n+s);if(i.byteLength!==o)throw new Error("Incorrect length");return new Nr(e,o,i,t)}function Eu(r,t){if(r===t)return!0;{let e=t;return r.code===e.code&&r.size===e.size&&e.bytes instanceof Uint8Array&&du(r.bytes,e.bytes)}}var Nr=class{code;size;digest;bytes;constructor(t,e,n,o){this.code=t,this.size=e,this.digest=n,this.bytes=o}};function vu(r,t){let{bytes:e,version:n}=r;switch(n){case 0:return Wp(e,ia(r),t??G.encoder);default:return jp(e,ia(r),t??qt.encoder)}}var Su=new WeakMap;function ia(r){let t=Su.get(r);if(t==null){let e=new Map;return Su.set(r,e),e}return t}var it=class r{code;version;multihash;bytes;"/";constructor(t,e,n,o){this.code=e,this.version=t,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:e}=this;if(t!==vn)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==Xp)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:e}=this.multihash,n=Yt(t,e);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return r.equals(this,t)}static equals(t,e){let n=e;return n!=null&&t.code===n.code&&t.version===n.version&&Eu(t.multihash,n.multihash)}toString(t){return vu(this,t)}toJSON(){return{"/":vu(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let e=t;if(e instanceof r)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){let{version:n,code:o,multihash:s,bytes:i}=e;return new r(n,o,s,i??Au(n,o,s.bytes))}else if(e[Yp]===!0){let{version:n,multihash:o,code:s}=e,i=zt(o);return r.create(n,s,i)}else return null}static create(t,e,n){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==vn)throw new Error(`Version 0 CID must use dag-pb (code: ${vn}) block encoding`);return new r(t,e,n,n.bytes)}case 1:{let o=Au(t,e,n.bytes);return new r(t,e,n,o)}default:throw new Error("Invalid version")}}static createV0(t){return r.create(0,vn,t)}static createV1(t,e){return r.create(1,t,e)}static decode(t){let[e,n]=r.decodeFirst(t);if(n.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){let e=r.inspectBytes(t),n=e.size-e.multihashSize,o=pe(t.subarray(n,n+e.multihashSize));if(o.byteLength!==e.multihashSize)throw new Error("Incorrect length");let s=o.subarray(e.multihashSize-e.digestSize),i=new Nr(e.multihashCode,e.digestSize,s,o);return[e.version===0?r.createV0(i):r.createV1(e.codec,i),t.subarray(e.size)]}static inspectBytes(t){let e=0,n=()=>{let[f,d]=En(t.subarray(e));return e+=d,f},o=n(),s=vn;if(o===18?(o=0,e=0):s=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let i=e,a=n(),c=n(),l=e+c,u=l-i;return{version:o,codec:s,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(t,e){let[n,o]=Gp(t,e),s=r.decode(o);if(s.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return ia(s).set(n,t),s}};function Gp(r,t){switch(r[0]){case"Q":{let e=t??G;return[G.prefix,e.decode(`${G.prefix}${r}`)]}case G.prefix:{let e=t??G;return[G.prefix,e.decode(r)]}case qt.prefix:{let e=t??qt;return[qt.prefix,e.decode(r)]}case bn.prefix:{let e=t??bn;return[bn.prefix,e.decode(r)]}default:{if(t==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],t.decode(r)]}}}function Wp(r,t,e){let{prefix:n}=e;if(n!==G.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);let o=t.get(n);if(o==null){let s=e.encode(r).slice(1);return t.set(n,s),s}else return o}function jp(r,t,e){let{prefix:n}=e,o=t.get(n);if(o==null){let s=e.encode(r);return t.set(n,s),s}else return o}var vn=112,Xp=18;function Au(r,t,e){let n=Rr(r),o=n+Rr(t),s=new Uint8Array(o+e.byteLength);return Mr(r,s,0),Mr(t,s,n),s.set(e,o),s}var Yp=Symbol.for("@ipld/js-cid/CID");var aa={};Ft(aa,{identity:()=>Zt});var _u=0,Zp="identity",Iu=pe;function Qp(r){return Yt(_u,Iu(r))}var Zt={code:_u,name:Zp,encode:Iu,digest:Qp};function tt(r,t){if(r===t)return!0;if(r.byteLength!==t.byteLength)return!1;for(let e=0;e<r.byteLength;e++)if(r[e]!==t[e])return!1;return!0}function ct(r=0){return new Uint8Array(r)}function St(r=0){return new Uint8Array(r)}function Tt(r,t){t==null&&(t=r.reduce((o,s)=>o+s.length,0));let e=St(t),n=0;for(let o of r)e.set(o,n),n+=o.length;return e}var Pu=Symbol.for("@achingbrain/uint8arraylist");function Cu(r,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(let n of r){let o=e+n.byteLength;if(t<o)return{buf:n,index:t-e};e=o}throw new RangeError("index is out of bounds")}function Bo(r){return!!r?.[Pu]}var Y=class r{bufs;length;[Pu]=!0;constructor(...t){this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(let n of t)if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.push(n);else if(Bo(n))e+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(let n of t.reverse())if(n instanceof Uint8Array)e+=n.byteLength,this.bufs.unshift(n);else if(Bo(n))e+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){let e=Cu(this.bufs,t);return e.buf[e.index]}set(t,e){let n=Cu(this.bufs,t);n.buf[n.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let n=0;n<t.length;n++)this.set(e+n,t[n]);else if(Bo(t))for(let n=0;n<t.length;n++)this.set(e+n,t.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){let{bufs:n,length:o}=this._subList(t,e);return Tt(n,o)}subarray(t,e){let{bufs:n,length:o}=this._subList(t,e);return n.length===1?n[0]:Tt(n,o)}sublist(t,e){let{bufs:n,length:o}=this._subList(t,e),s=new r;return s.length=o,s.bufs=[...n],s}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let s=0;s<this.bufs.length;s++){let i=this.bufs[s],a=o,c=a+i.byteLength;if(o=c,t>=c)continue;let l=t>=a&&t<c,u=e>a&&e<=c;if(l&&u){if(t===a&&e===c){n.push(i);break}let f=t-a;n.push(i.subarray(f,f+(e-t)));break}if(l){if(t===0){n.push(i);continue}n.push(i.subarray(t-a));continue}if(u){if(e===c){n.push(i);break}n.push(i.subarray(0,e-a));break}n.push(i)}return{bufs:n,length:e-t}}indexOf(t,e=0){if(!Bo(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let s=256,i=new Int32Array(s);for(let f=0;f<s;f++)i[f]=-1;for(let f=0;f<o;f++)i[n[f]]=f;let a=i,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=e;f<=c;f+=u){u=0;for(let d=l;d>=0;d--){let g=this.get(f+d);if(n[d]!==g){u=Math.max(1,d-a[g]);break}}if(u===0)return f}return-1}getInt8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){let n=St(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,e),this.write(n,t)}getInt16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,e)}setInt16(t,e,n){let o=ct(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,e,n),this.write(o,t)}getInt32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,e)}setInt32(t,e,n){let o=ct(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,e,n),this.write(o,t)}getBigInt64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,e)}setBigInt64(t,e,n){let o=ct(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,e,n),this.write(o,t)}getUint8(t){let e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){let n=St(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,e),this.write(n,t)}getUint16(t,e){let n=this.subarray(t,t+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,e)}setUint16(t,e,n){let o=ct(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,e,n),this.write(o,t)}getUint32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,e)}setUint32(t,e,n){let o=ct(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,e,n),this.write(o,t)}getBigUint64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,e)}setBigUint64(t,e,n){let o=ct(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,e,n),this.write(o,t)}getFloat32(t,e){let n=this.subarray(t,t+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,e)}setFloat32(t,e,n){let o=ct(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,e,n),this.write(o,t)}getFloat64(t,e){let n=this.subarray(t,t+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,e)}setFloat64(t,e,n){let o=ct(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,e,n),this.write(o,t)}equals(t){if(t==null||!(t instanceof r)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!tt(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){let n=new r;return n.bufs=t,e==null&&(e=t.reduce((o,s)=>o+s.byteLength,0)),n.length=e,n}};var ca={};Ft(ca,{base10:()=>Jp});var Jp=De({prefix:"9",name:"base10",alphabet:"0123456789"});var la={};Ft(la,{base16:()=>tm,base16upper:()=>em});var tm=at({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),em=at({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ua={};Ft(ua,{base2:()=>rm});var rm=at({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var fa={};Ft(fa,{base256emoji:()=>am});var Tu=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),nm=Tu.reduce((r,t,e)=>(r[e]=t,r),[]),om=Tu.reduce((r,t,e)=>{let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);return r[n]=e,r},[]);function sm(r){return r.reduce((t,e)=>(t+=nm[e],t),"")}function im(r){let t=[];for(let e of r){let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);let o=om[n];if(o==null)throw new Error(`Non-base256emoji character: ${e}`);t.push(o)}return new Uint8Array(t)}var am=kr({prefix:"\u{1F680}",name:"base256emoji",encode:sm,decode:im});var pa={};Ft(pa,{base64:()=>da,base64pad:()=>cm,base64url:()=>ha,base64urlpad:()=>lm});var da=at({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),cm=at({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ha=at({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),lm=at({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var ma={};Ft(ma,{base8:()=>um});var um=at({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ga={};Ft(ga,{identity:()=>fm});var fm=kr({prefix:"\0",name:"identity",encode:r=>pu(r),decode:r=>hu(r)});var Wb=new TextEncoder,jb=new TextDecoder;var ba={};Ft(ba,{sha256:()=>Or,sha512:()=>pm});function wa({name:r,code:t,encode:e}){return new ya(r,t,e)}var ya=class{name;code;encode;constructor(t,e,n){this.name=t,this.code=e,this.encode=n}digest(t){if(t instanceof Uint8Array){let e=this.encode(t);return e instanceof Uint8Array?Yt(this.code,e):e.then(n=>Yt(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Du(r){return async t=>new Uint8Array(await crypto.subtle.digest(r,t))}var Or=wa({name:"sha2-256",code:18,encode:Du("SHA-256")}),pm=wa({name:"sha2-512",code:19,encode:Du("SHA-512")});var Sn={...ga,...ua,...ma,...ca,...la,...na,...oa,...ra,...pa,...fa},ix={...ba,...aa};function Mu(r,t,e,n){return{name:r,prefix:t,encoder:{name:r,prefix:t,encode:e},decoder:{decode:n}}}var ku=Mu("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),xa=Mu("ascii","a",r=>{let t="a";for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return t},r=>{r=r.substring(1);let t=St(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}),mm={utf8:ku,"utf-8":ku,hex:Sn.base16,latin1:xa,ascii:xa,binary:xa,...Sn},Fo=mm;function L(r,t="utf8"){let e=Fo[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${r}`)}function B(r,t="utf8"){let e=Fo[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(r).substring(1)}var gm=parseInt("11111",2),Ea=parseInt("10000000",2),ym=parseInt("01111111",2),Ru={0:An,1:An,2:wm,3:Em,4:vm,5:xm,6:bm,16:An,22:An,48:An};function me(r,t={offset:0}){let e=r[t.offset]&gm;if(t.offset++,Ru[e]!=null)return Ru[e](r,t);throw new Error("No decoder for tag "+e)}function _n(r,t){let e=0;if((r[t.offset]&Ea)===Ea){let n=r[t.offset]&ym,o="0x";t.offset++;for(let s=0;s<n;s++,t.offset++)o+=r[t.offset].toString(16).padStart(2,"0");e=parseInt(o,16)}else e=r[t.offset],t.offset++;return e}function An(r,t){_n(r,t);let e=[];for(;!(t.offset>=r.byteLength);){let n=me(r,t);if(n===null)break;e.push(n)}return e}function wm(r,t){let e=_n(r,t),n=t.offset,o=t.offset+e,s=[];for(let i=n;i<o;i++)i===n&&r[i]===0||s.push(r[i]);return t.offset+=e,Uint8Array.from(s)}function bm(r,t){let e=_n(r,t),n=t.offset+e,o=r[t.offset];t.offset++;let s=0,i=0;o<40?(s=0,i=o):o<80?(s=1,i=o-40):(s=2,i=o-80);let a=`${s}.${i}`,c=[];for(;t.offset<n;){let l=r[t.offset];if(t.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let f=0;f<c.length;f++)u+=c[f]<<f*7;a+=`.${u}`,c=[]}}return a}function xm(r,t){return t.offset++,null}function Em(r,t){let e=_n(r,t),n=r[t.offset];t.offset++;let o=r.subarray(t.offset,t.offset+e-1);if(t.offset+=e,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function vm(r,t){let e=_n(r,t),n=r.subarray(t.offset,t.offset+e);return t.offset+=e,n}function Sm(r){let t=r.toString(16);t.length%2===1&&(t="0"+t);let e=new Y;for(let n=0;n<t.length;n+=2)e.append(Uint8Array.from([parseInt(`${t[n]}${t[n+1]}`,16)]));return e}function Uo(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let t=Sm(r.byteLength);return new Y(Uint8Array.from([t.byteLength|Ea]),t)}function Lt(r){let t=new Y,e=128;return(r.subarray()[0]&e)===e&&t.append(Uint8Array.from([0])),t.append(r),new Y(Uint8Array.from([2]),Uo(t),t)}function In(r){let t=Uint8Array.from([0]),e=new Y(t,r);return new Y(Uint8Array.from([3]),Uo(e),e)}function Nu(r){return new Y(Uint8Array.from([4]),Uo(r),r)}function Qt(r,t=48){let e=new Y;for(let n of r)e.append(n);return new Y(Uint8Array.from([t]),Uo(e),e)}async function Ou(r="P-256"){let t=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",t.publicKey),privateKey:await crypto.subtle.exportKey("jwk",t.privateKey)}}async function Bu(r,t){let e=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]),n=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},e,t.subarray());return new Uint8Array(n,0,n.byteLength)}async function Fu(r,t,e){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);return crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},n,t,e.subarray())}var Am=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),_m=Uint8Array.from([6,5,43,129,4,0,34]),Im=Uint8Array.from([6,5,43,129,4,0,35]),Cm={ext:!0,kty:"EC",crv:"P-256"},Pm={ext:!0,kty:"EC",crv:"P-384"},Tm={ext:!0,kty:"EC",crv:"P-521"},va=32,Sa=48,Aa=66;function _a(r){let t=me(r);return Uu(t)}function Uu(r){let t=r[1][1][0],e=1,n,o;if(t.byteLength===va*2+1)return n=B(t.subarray(e,e+va),"base64url"),o=B(t.subarray(e+va),"base64url"),new We({...Cm,key_ops:["verify"],x:n,y:o});if(t.byteLength===Sa*2+1)return n=B(t.subarray(e,e+Sa),"base64url"),o=B(t.subarray(e+Sa),"base64url"),new We({...Pm,key_ops:["verify"],x:n,y:o});if(t.byteLength===Aa*2+1)return n=B(t.subarray(e,e+Aa),"base64url"),o=B(t.subarray(e+Aa),"base64url"),new We({...Tm,key_ops:["verify"],x:n,y:o});throw new M(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}function Ku(r){return Qt([Lt(Uint8Array.from([1])),Nu(L(r.d??"","base64url")),Qt([zu(r.crv)],160),Qt([In(new Y(Uint8Array.from([4]),L(r.x??"","base64url"),L(r.y??"","base64url")))],161)]).subarray()}function qu(r){return Qt([Lt(Uint8Array.from([1])),Qt([zu(r.crv)],160),Qt([In(new Y(Uint8Array.from([4]),L(r.x??"","base64url"),L(r.y??"","base64url")))],161)]).subarray()}function zu(r){if(r==="P-256")return Am;if(r==="P-384")return _m;if(r==="P-521")return Im;throw new M(`Invalid curve ${r}`)}async function Vu(r="P-256"){let t=await Ou(r);return new Ko(t.privateKey)}var We=class{type="ECDSA";jwk;_raw;constructor(t){this.jwk=t}get raw(){return this._raw==null&&(this._raw=qu(this.jwk)),this._raw}toMultihash(){return Zt.digest(Gt(this))}toCID(){return it.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}async verify(t,e){return Fu(this.jwk,e,t)}},Ko=class{type="ECDSA";jwk;publicKey;_raw;constructor(t){this.jwk=t,this.publicKey=new We({crv:t.crv,ext:t.ext,key_ops:["verify"],kty:"EC",x:t.x,y:t.y})}get raw(){return this._raw==null&&(this._raw=Ku(this.jwk)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}async sign(t){return Bu(this.jwk,t)}};var je=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Lm(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function qo(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Xe(r,...t){if(!Lm(r))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(r.length))throw new Error("Uint8Array expected of length "+t+", got length="+r.length)}function Hu(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");qo(r.outputLen),qo(r.blockLen)}function Fr(r,t=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(t&&r.finished)throw new Error("Hash#digest() has already been called")}function $u(r,t){Xe(r);let e=t.outputLen;if(r.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}function ge(...r){for(let t=0;t<r.length;t++)r[t].fill(0)}function zo(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Jt(r,t){return r<<32-t|r>>>t}function Gu(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Cn(r){return typeof r=="string"&&(r=Gu(r)),Xe(r),r}function Ia(...r){let t=0;for(let n=0;n<r.length;n++){let o=r[n];Xe(o),t+=o.length}let e=new Uint8Array(t);for(let n=0,o=0;n<r.length;n++){let s=r[n];e.set(s,o),o+=s.length}return e}var Br=class{};function Ca(r){let t=n=>r().update(Cn(n)).digest(),e=r();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>r(),t}function Ur(r=32){if(je&&typeof je.getRandomValues=="function")return je.getRandomValues(new Uint8Array(r));if(je&&typeof je.randomBytes=="function")return Uint8Array.from(je.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function Dm(r,t,e,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(t,e,n);let o=BigInt(32),s=BigInt(4294967295),i=Number(e>>o&s),a=Number(e&s),c=n?4:0,l=n?0:4;r.setUint32(t+c,i,n),r.setUint32(t+l,a,n)}function Wu(r,t,e){return r&t^~r&e}function ju(r,t,e){return r&t^r&e^t&e}var Pn=class extends Br{constructor(t,e,n,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(t),this.view=zo(this.buffer)}update(t){Fr(this),t=Cn(t),Xe(t);let{view:e,buffer:n,blockLen:o}=this,s=t.length;for(let i=0;i<s;){let a=Math.min(o-this.pos,s-i);if(a===o){let c=zo(t);for(;o<=s-i;i+=o)this.process(c,i);continue}n.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===o&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Fr(this),$u(t,this),this.finished=!0;let{buffer:e,view:n,blockLen:o,isLE:s}=this,{pos:i}=this;e[i++]=128,ge(this.buffer.subarray(i)),this.padOffset>o-i&&(this.process(n,0),i=0);for(let f=i;f<o;f++)e[f]=0;Dm(n,o-8,BigInt(this.length*8),s),this.process(n,0);let a=zo(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],s)}digest(){let{buffer:t,outputLen:e}=this;this.digestInto(t);let n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());let{blockLen:e,buffer:n,length:o,finished:s,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=s,t.length=o,t.pos=a,o%e&&t.buffer.set(n),t}clone(){return this._cloneInto()}},ye=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var xt=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var Vo=BigInt(4294967295),Xu=BigInt(32);function km(r,t=!1){return t?{h:Number(r&Vo),l:Number(r>>Xu&Vo)}:{h:Number(r>>Xu&Vo)|0,l:Number(r&Vo)|0}}function Yu(r,t=!1){let e=r.length,n=new Uint32Array(e),o=new Uint32Array(e);for(let s=0;s<e;s++){let{h:i,l:a}=km(r[s],t);[n[s],o[s]]=[i,a]}return[n,o]}var Pa=(r,t,e)=>r>>>e,Ta=(r,t,e)=>r<<32-e|t>>>e,Ye=(r,t,e)=>r>>>e|t<<32-e,Ze=(r,t,e)=>r<<32-e|t>>>e,Tn=(r,t,e)=>r<<64-e|t>>>e-32,Ln=(r,t,e)=>r>>>e-32|t<<64-e;function ae(r,t,e,n){let o=(t>>>0)+(n>>>0);return{h:r+e+(o/2**32|0)|0,l:o|0}}var Zu=(r,t,e)=>(r>>>0)+(t>>>0)+(e>>>0),Qu=(r,t,e,n)=>t+e+n+(r/2**32|0)|0,Ju=(r,t,e,n)=>(r>>>0)+(t>>>0)+(e>>>0)+(n>>>0),tf=(r,t,e,n,o)=>t+e+n+o+(r/2**32|0)|0,ef=(r,t,e,n,o)=>(r>>>0)+(t>>>0)+(e>>>0)+(n>>>0)+(o>>>0),rf=(r,t,e,n,o,s)=>t+e+n+o+s+(r/2**32|0)|0;var Rm=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ke=new Uint32Array(64),Ho=class extends Pn{constructor(t=32){super(64,t,8,!1),this.A=ye[0]|0,this.B=ye[1]|0,this.C=ye[2]|0,this.D=ye[3]|0,this.E=ye[4]|0,this.F=ye[5]|0,this.G=ye[6]|0,this.H=ye[7]|0}get(){let{A:t,B:e,C:n,D:o,E:s,F:i,G:a,H:c}=this;return[t,e,n,o,s,i,a,c]}set(t,e,n,o,s,i,a,c){this.A=t|0,this.B=e|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,e){for(let f=0;f<16;f++,e+=4)ke[f]=t.getUint32(e,!1);for(let f=16;f<64;f++){let d=ke[f-15],g=ke[f-2],p=Jt(d,7)^Jt(d,18)^d>>>3,m=Jt(g,17)^Jt(g,19)^g>>>10;ke[f]=m+ke[f-7]+p+ke[f-16]|0}let{A:n,B:o,C:s,D:i,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let d=Jt(a,6)^Jt(a,11)^Jt(a,25),g=u+d+Wu(a,c,l)+Rm[f]+ke[f]|0,m=(Jt(n,2)^Jt(n,13)^Jt(n,22))+ju(n,o,s)|0;u=l,l=c,c=a,a=i+g|0,i=s,s=o,o=n,n=g+m|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,o,s,i,a,c,l,u)}roundClean(){ge(ke)}destroy(){this.set(0,0,0,0,0,0,0,0),ge(this.buffer)}};var nf=Yu(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Nm=nf[0],Om=nf[1],Me=new Uint32Array(80),Re=new Uint32Array(80),La=class extends Pn{constructor(t=64){super(128,t,16,!1),this.Ah=xt[0]|0,this.Al=xt[1]|0,this.Bh=xt[2]|0,this.Bl=xt[3]|0,this.Ch=xt[4]|0,this.Cl=xt[5]|0,this.Dh=xt[6]|0,this.Dl=xt[7]|0,this.Eh=xt[8]|0,this.El=xt[9]|0,this.Fh=xt[10]|0,this.Fl=xt[11]|0,this.Gh=xt[12]|0,this.Gl=xt[13]|0,this.Hh=xt[14]|0,this.Hl=xt[15]|0}get(){let{Ah:t,Al:e,Bh:n,Bl:o,Ch:s,Cl:i,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:d,Gh:g,Gl:p,Hh:m,Hl:w}=this;return[t,e,n,o,s,i,a,c,l,u,f,d,g,p,m,w]}set(t,e,n,o,s,i,a,c,l,u,f,d,g,p,m,w){this.Ah=t|0,this.Al=e|0,this.Bh=n|0,this.Bl=o|0,this.Ch=s|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=d|0,this.Gh=g|0,this.Gl=p|0,this.Hh=m|0,this.Hl=w|0}process(t,e){for(let x=0;x<16;x++,e+=4)Me[x]=t.getUint32(e),Re[x]=t.getUint32(e+=4);for(let x=16;x<80;x++){let h=Me[x-15]|0,b=Re[x-15]|0,P=Ye(h,b,1)^Ye(h,b,8)^Pa(h,b,7),T=Ze(h,b,1)^Ze(h,b,8)^Ta(h,b,7),D=Me[x-2]|0,F=Re[x-2]|0,q=Ye(D,F,19)^Tn(D,F,61)^Pa(D,F,6),R=Ze(D,F,19)^Ln(D,F,61)^Ta(D,F,6),U=Ju(T,R,Re[x-7],Re[x-16]),O=tf(U,P,q,Me[x-7],Me[x-16]);Me[x]=O|0,Re[x]=U|0}let{Ah:n,Al:o,Bh:s,Bl:i,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:d,Fh:g,Fl:p,Gh:m,Gl:w,Hh:v,Hl:C}=this;for(let x=0;x<80;x++){let h=Ye(f,d,14)^Ye(f,d,18)^Tn(f,d,41),b=Ze(f,d,14)^Ze(f,d,18)^Ln(f,d,41),P=f&g^~f&m,T=d&p^~d&w,D=ef(C,b,T,Om[x],Re[x]),F=rf(D,v,h,P,Nm[x],Me[x]),q=D|0,R=Ye(n,o,28)^Tn(n,o,34)^Tn(n,o,39),U=Ze(n,o,28)^Ln(n,o,34)^Ln(n,o,39),O=n&s^n&a^s&a,ht=o&i^o&c^i&c;v=m|0,C=w|0,m=g|0,w=p|0,g=f|0,p=d|0,{h:f,l:d}=ae(l|0,u|0,F|0,q|0),l=a|0,u=c|0,a=s|0,c=i|0,s=n|0,i=o|0;let _=Zu(q,U,ht);n=Qu(_,F,R,O),o=_|0}({h:n,l:o}=ae(this.Ah|0,this.Al|0,n|0,o|0)),{h:s,l:i}=ae(this.Bh|0,this.Bl|0,s|0,i|0),{h:a,l:c}=ae(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=ae(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:d}=ae(this.Eh|0,this.El|0,f|0,d|0),{h:g,l:p}=ae(this.Fh|0,this.Fl|0,g|0,p|0),{h:m,l:w}=ae(this.Gh|0,this.Gl|0,m|0,w|0),{h:v,l:C}=ae(this.Hh|0,this.Hl|0,v|0,C|0),this.set(n,o,s,i,a,c,l,u,f,d,g,p,m,w,v,C)}roundClean(){ge(Me,Re)}destroy(){ge(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var $o=Ca(()=>new Ho);var of=Ca(()=>new La);var Ra=BigInt(0),Ma=BigInt(1);function Kr(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Na(r){if(!Kr(r))throw new Error("Uint8Array expected")}function ce(r,t){if(typeof t!="boolean")throw new Error(r+" boolean expected, got "+t)}function Dn(r){let t=r.toString(16);return t.length&1?"0"+t:t}function cf(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Ra:BigInt("0x"+r)}var lf=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Bm=Array.from({length:256},(r,t)=>t.toString(16).padStart(2,"0"));function Ne(r){if(Na(r),lf)return r.toHex();let t="";for(let e=0;e<r.length;e++)t+=Bm[r[e]];return t}var we={_0:48,_9:57,A:65,F:70,a:97,f:102};function sf(r){if(r>=we._0&&r<=we._9)return r-we._0;if(r>=we.A&&r<=we.F)return r-(we.A-10);if(r>=we.a&&r<=we.f)return r-(we.a-10)}function kn(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(lf)return Uint8Array.fromHex(r);let t=r.length,e=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let n=new Uint8Array(e);for(let o=0,s=0;o<e;o++,s+=2){let i=sf(r.charCodeAt(s)),a=sf(r.charCodeAt(s+1));if(i===void 0||a===void 0){let c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[o]=i*16+a}return n}function be(r){return cf(Ne(r))}function Qe(r){return Na(r),cf(Ne(Uint8Array.from(r).reverse()))}function Je(r,t){return kn(r.toString(16).padStart(t*2,"0"))}function qr(r,t){return Je(r,t).reverse()}function nt(r,t,e){let n;if(typeof t=="string")try{n=kn(t)}catch(s){throw new Error(r+" must be hex string or Uint8Array, cause: "+s)}else if(Kr(t))n=Uint8Array.from(t);else throw new Error(r+" must be hex string or Uint8Array");let o=n.length;if(typeof e=="number"&&o!==e)throw new Error(r+" of length "+e+" expected, got "+o);return n}function Oe(...r){let t=0;for(let n=0;n<r.length;n++){let o=r[n];Na(o),t+=o.length}let e=new Uint8Array(t);for(let n=0,o=0;n<r.length;n++){let s=r[n];e.set(s,o),o+=s.length}return e}var Da=r=>typeof r=="bigint"&&Ra<=r;function Go(r,t,e){return Da(r)&&Da(t)&&Da(e)&&t<=r&&r<e}function Vt(r,t,e,n){if(!Go(t,e,n))throw new Error("expected valid "+r+": "+e+" <= n < "+n+", got "+t)}function uf(r){let t;for(t=0;r>Ra;r>>=Ma,t+=1);return t}var tr=r=>(Ma<<BigInt(r))-Ma,ka=r=>new Uint8Array(r),af=r=>Uint8Array.from(r);function ff(r,t,e){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let n=ka(r),o=ka(r),s=0,i=()=>{n.fill(1),o.fill(0),s=0},a=(...f)=>e(o,n,...f),c=(f=ka(0))=>{o=a(af([0]),f),n=a(),f.length!==0&&(o=a(af([1]),f),n=a())},l=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let f=0,d=[];for(;f<t;){n=a();let g=n.slice();d.push(g),f+=n.length}return Oe(...d)};return(f,d)=>{i(),c(f);let g;for(;!(g=d(l()));)c();return i(),g}}var Fm={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||Kr(r),isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,t)=>t.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function xe(r,t,e={}){let n=(o,s,i)=>{let a=Fm[s];if(typeof a!="function")throw new Error("invalid validator function");let c=r[o];if(!(i&&c===void 0)&&!a(c,r))throw new Error("param "+String(o)+" is invalid. Expected "+s+", got "+c)};for(let[o,s]of Object.entries(t))n(o,s,!1);for(let[o,s]of Object.entries(e))n(o,s,!0);return r}function zr(r){let t=new WeakMap;return(e,...n)=>{let o=t.get(e);if(o!==void 0)return o;let s=r(e,...n);return t.set(e,s),s}}var Dt=BigInt(0),yt=BigInt(1),er=BigInt(2),Um=BigInt(3),hf=BigInt(4),pf=BigInt(5),mf=BigInt(8);function rt(r,t){let e=r%t;return e>=Dt?e:t+e}function ot(r,t,e){let n=r;for(;t-- >Dt;)n*=n,n%=e;return n}function Wo(r,t){if(r===Dt)throw new Error("invert: expected non-zero number");if(t<=Dt)throw new Error("invert: expected positive modulus, got "+t);let e=rt(r,t),n=t,o=Dt,s=yt,i=yt,a=Dt;for(;e!==Dt;){let l=n/e,u=n%e,f=o-i*l,d=s-a*l;n=e,e=u,o=i,s=a,i=f,a=d}if(n!==yt)throw new Error("invert: does not exist");return rt(o,t)}function gf(r,t){let e=(r.ORDER+yt)/hf,n=r.pow(t,e);if(!r.eql(r.sqr(n),t))throw new Error("Cannot find square root");return n}function Km(r,t){let e=(r.ORDER-pf)/mf,n=r.mul(t,er),o=r.pow(n,e),s=r.mul(t,o),i=r.mul(r.mul(s,er),o),a=r.mul(s,r.sub(i,r.ONE));if(!r.eql(r.sqr(a),t))throw new Error("Cannot find square root");return a}function qm(r){if(r<BigInt(3))throw new Error("sqrt is not defined for small field");let t=r-yt,e=0;for(;t%er===Dt;)t/=er,e++;let n=er,o=Ee(r);for(;df(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(e===1)return gf;let s=o.pow(n,t),i=(t+yt)/er;return function(c,l){if(c.is0(l))return l;if(df(c,l)!==1)throw new Error("Cannot find square root");let u=e,f=c.mul(c.ONE,s),d=c.pow(l,t),g=c.pow(l,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let p=1,m=c.sqr(d);for(;!c.eql(m,c.ONE);)if(p++,m=c.sqr(m),p===u)throw new Error("Cannot find square root");let w=yt<<BigInt(u-p-1),v=c.pow(f,w);u=p,f=c.sqr(v),d=c.mul(d,f),g=c.mul(g,v)}return g}}function zm(r){return r%hf===Um?gf:r%mf===pf?Km:qm(r)}var yf=(r,t)=>(rt(r,t)&yt)===yt,Vm=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Oa(r){let t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},e=Vm.reduce((n,o)=>(n[o]="function",n),t);return xe(r,e)}function Hm(r,t,e){if(e<Dt)throw new Error("invalid exponent, negatives unsupported");if(e===Dt)return r.ONE;if(e===yt)return t;let n=r.ONE,o=t;for(;e>Dt;)e&yt&&(n=r.mul(n,o)),o=r.sqr(o),e>>=yt;return n}function Vr(r,t,e=!1){let n=new Array(t.length).fill(e?r.ZERO:void 0),o=t.reduce((i,a,c)=>r.is0(a)?i:(n[c]=i,r.mul(i,a)),r.ONE),s=r.inv(o);return t.reduceRight((i,a,c)=>r.is0(a)?i:(n[c]=r.mul(i,n[c]),r.mul(i,a)),s),n}function df(r,t){let e=(r.ORDER-yt)/er,n=r.pow(t,e),o=r.eql(n,r.ONE),s=r.eql(n,r.ZERO),i=r.eql(n,r.neg(r.ONE));if(!o&&!s&&!i)throw new Error("invalid Legendre symbol result");return o?1:s?0:-1}function Ba(r,t){t!==void 0&&qo(t);let e=t!==void 0?t:r.toString(2).length,n=Math.ceil(e/8);return{nBitLength:e,nByteLength:n}}function Ee(r,t,e=!1,n={}){if(r<=Dt)throw new Error("invalid field: expected ORDER > 0, got "+r);let{nBitLength:o,nByteLength:s}=Ba(r,t);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let i,a=Object.freeze({ORDER:r,isLE:e,BITS:o,BYTES:s,MASK:tr(o),ZERO:Dt,ONE:yt,create:c=>rt(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return Dt<=c&&c<r},is0:c=>c===Dt,isOdd:c=>(c&yt)===yt,neg:c=>rt(-c,r),eql:(c,l)=>c===l,sqr:c=>rt(c*c,r),add:(c,l)=>rt(c+l,r),sub:(c,l)=>rt(c-l,r),mul:(c,l)=>rt(c*l,r),pow:(c,l)=>Hm(a,c,l),div:(c,l)=>rt(c*Wo(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>Wo(c,r),sqrt:n.sqrt||(c=>(i||(i=zm(r)),i(a,c))),toBytes:c=>e?qr(c,s):Je(c,s),fromBytes:c=>{if(c.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+c.length);return e?Qe(c):be(c)},invertBatch:c=>Vr(a,c),cmov:(c,l,u)=>u?l:c});return Object.freeze(a)}function wf(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let t=r.toString(2).length;return Math.ceil(t/8)}function Fa(r){let t=wf(r);return t+Math.ceil(t/2)}function bf(r,t,e=!1){let n=r.length,o=wf(t),s=Fa(t);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);let i=e?Qe(r):be(r),a=rt(i,t-yt)+yt;return e?qr(a,o):Je(a,o)}var xf=BigInt(0),Va=BigInt(1);function Ua(r,t){let e=t.negate();return r?e:t}function vf(r,t){if(!Number.isSafeInteger(r)||r<=0||r>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+r)}function Ka(r,t){vf(r,t);let e=Math.ceil(t/r)+1,n=2**(r-1),o=2**r,s=tr(r),i=BigInt(r);return{windows:e,windowSize:n,mask:s,maxNumber:o,shiftBy:i}}function Ef(r,t,e){let{windowSize:n,mask:o,maxNumber:s,shiftBy:i}=e,a=Number(r&o),c=r>>i;a>n&&(a-=s,c+=Va);let l=t*n,u=l+Math.abs(a)-1,f=a===0,d=a<0,g=t%2!==0;return{nextN:c,offset:u,isZero:f,isNeg:d,isNegF:g,offsetF:l}}function $m(r,t){if(!Array.isArray(r))throw new Error("array expected");r.forEach((e,n)=>{if(!(e instanceof t))throw new Error("invalid point at index "+n)})}function Gm(r,t){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((e,n)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+n)})}var qa=new WeakMap,Sf=new WeakMap;function za(r){return Sf.get(r)||1}function jo(r,t){return{constTimeNegate:Ua,hasPrecomputes(e){return za(e)!==1},unsafeLadder(e,n,o=r.ZERO){let s=e;for(;n>xf;)n&Va&&(o=o.add(s)),s=s.double(),n>>=Va;return o},precomputeWindow(e,n){let{windows:o,windowSize:s}=Ka(n,t),i=[],a=e,c=a;for(let l=0;l<o;l++){c=a,i.push(c);for(let u=1;u<s;u++)c=c.add(a),i.push(c);a=c.double()}return i},wNAF(e,n,o){let s=r.ZERO,i=r.BASE,a=Ka(e,t);for(let c=0;c<a.windows;c++){let{nextN:l,offset:u,isZero:f,isNeg:d,isNegF:g,offsetF:p}=Ef(o,c,a);o=l,f?i=i.add(Ua(g,n[p])):s=s.add(Ua(d,n[u]))}return{p:s,f:i}},wNAFUnsafe(e,n,o,s=r.ZERO){let i=Ka(e,t);for(let a=0;a<i.windows&&o!==xf;a++){let{nextN:c,offset:l,isZero:u,isNeg:f}=Ef(o,a,i);if(o=c,!u){let d=n[l];s=s.add(f?d.negate():d)}}return s},getPrecomputes(e,n,o){let s=qa.get(n);return s||(s=this.precomputeWindow(n,e),e!==1&&qa.set(n,o(s))),s},wNAFCached(e,n,o){let s=za(e);return this.wNAF(s,this.getPrecomputes(s,e,o),n)},wNAFCachedUnsafe(e,n,o,s){let i=za(e);return i===1?this.unsafeLadder(e,n,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,o),n,s)},setWindowSize(e,n){vf(n,t),Sf.set(e,n),qa.delete(e)}}}function Xo(r,t,e,n){$m(e,r),Gm(n,t);let o=e.length,s=n.length;if(o!==s)throw new Error("arrays of points and scalars must have equal length");let i=r.ZERO,a=uf(BigInt(o)),c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);let l=tr(c),u=new Array(Number(l)+1).fill(i),f=Math.floor((t.BITS-1)/c)*c,d=i;for(let g=f;g>=0;g-=c){u.fill(i);for(let m=0;m<s;m++){let w=n[m],v=Number(w>>BigInt(g)&l);u[v]=u[v].add(e[m])}let p=i;for(let m=u.length-1,w=i;m>0;m--)w=w.add(u[m]),p=p.add(w);if(d=d.add(p),g!==0)for(let m=0;m<c;m++)d=d.double()}return d}function Mn(r){return Oa(r.Fp),xe(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...Ba(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}var le=BigInt(0),kt=BigInt(1),Af=BigInt(2),Wm=BigInt(8),jm={zip215:!0};function Xm(r){let t=Mn(r);return xe(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}function _f(r){let t=Xm(r),{Fp:e,n,prehash:o,hash:s,randomBytes:i,nByteLength:a,h:c}=t,l=Af<<BigInt(a*8)-kt,u=e.create,f=Ee(t.n,t.nBitLength);function d(S,y){let E=e.sqr(S),I=e.sqr(y),N=e.add(e.mul(t.a,E),I),K=e.add(e.ONE,e.mul(t.d,e.mul(E,I)));return e.eql(N,K)}if(!d(t.Gx,t.Gy))throw new Error("bad curve params: generator point");let g=t.uvRatio||((S,y)=>{try{return{isValid:!0,value:e.sqrt(S*e.inv(y))}}catch{return{isValid:!1,value:le}}}),p=t.adjustScalarBytes||(S=>S),m=t.domain||((S,y,E)=>{if(ce("phflag",E),y.length||E)throw new Error("Contexts/pre-hash are not supported");return S});function w(S,y,E=!1){let I=E?kt:le;Vt("coordinate "+S,y,I,l)}function v(S){if(!(S instanceof h))throw new Error("ExtendedPoint expected")}let C=zr((S,y)=>{let{ex:E,ey:I,ez:N}=S,K=S.is0();y==null&&(y=K?Wm:e.inv(N));let V=u(E*y),$=u(I*y),X=u(N*y);if(K)return{x:le,y:kt};if(X!==kt)throw new Error("invZ was invalid");return{x:V,y:$}}),x=zr(S=>{let{a:y,d:E}=t;if(S.is0())throw new Error("bad point: ZERO");let{ex:I,ey:N,ez:K,et:V}=S,$=u(I*I),X=u(N*N),J=u(K*K),pt=u(J*J),ut=u($*y),bt=u(J*u(ut+X)),Bt=u(pt+u(E*u($*X)));if(bt!==Bt)throw new Error("bad point: equation left != right (1)");let gt=u(I*N),vt=u(K*V);if(gt!==vt)throw new Error("bad point: equation left != right (2)");return!0});class h{constructor(y,E,I,N){w("x",y),w("y",E),w("z",I,!0),w("t",N),this.ex=y,this.ey=E,this.ez=I,this.et=N,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(y){if(y instanceof h)throw new Error("extended point not allowed");let{x:E,y:I}=y||{};return w("x",E),w("y",I),new h(E,I,kt,u(E*I))}static normalizeZ(y){let E=Vr(e,y.map(I=>I.ez));return y.map((I,N)=>I.toAffine(E[N])).map(h.fromAffine)}static msm(y,E){return Xo(h,f,y,E)}_setWindowSize(y){T.setWindowSize(this,y)}assertValidity(){x(this)}equals(y){v(y);let{ex:E,ey:I,ez:N}=this,{ex:K,ey:V,ez:$}=y,X=u(E*$),J=u(K*N),pt=u(I*$),ut=u(V*N);return X===J&&pt===ut}is0(){return this.equals(h.ZERO)}negate(){return new h(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:y}=t,{ex:E,ey:I,ez:N}=this,K=u(E*E),V=u(I*I),$=u(Af*u(N*N)),X=u(y*K),J=E+I,pt=u(u(J*J)-K-V),ut=X+V,bt=ut-$,Bt=X-V,gt=u(pt*bt),vt=u(ut*Bt),Kt=u(pt*Bt),jt=u(bt*ut);return new h(gt,vt,jt,Kt)}add(y){v(y);let{a:E,d:I}=t,{ex:N,ey:K,ez:V,et:$}=this,{ex:X,ey:J,ez:pt,et:ut}=y,bt=u(N*X),Bt=u(K*J),gt=u($*I*ut),vt=u(V*pt),Kt=u((N+K)*(X+J)-bt-Bt),jt=vt-gt,mn=vt+gt,au=u(Bt-E*bt),rp=u(Kt*jt),np=u(mn*au),op=u(Kt*au),sp=u(jt*mn);return new h(rp,np,sp,op)}subtract(y){return this.add(y.negate())}wNAF(y){return T.wNAFCached(this,y,h.normalizeZ)}multiply(y){let E=y;Vt("scalar",E,kt,n);let{p:I,f:N}=this.wNAF(E);return h.normalizeZ([I,N])[0]}multiplyUnsafe(y,E=h.ZERO){let I=y;return Vt("scalar",I,le,n),I===le?P:this.is0()||I===kt?this:T.wNAFCachedUnsafe(this,I,h.normalizeZ,E)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return T.unsafeLadder(this,n).is0()}toAffine(y){return C(this,y)}clearCofactor(){let{h:y}=t;return y===kt?this:this.multiplyUnsafe(y)}static fromHex(y,E=!1){let{d:I,a:N}=t,K=e.BYTES;y=nt("pointHex",y,K),ce("zip215",E);let V=y.slice(),$=y[K-1];V[K-1]=$&-129;let X=Qe(V),J=E?l:e.ORDER;Vt("pointHex.y",X,le,J);let pt=u(X*X),ut=u(pt-kt),bt=u(I*pt-N),{isValid:Bt,value:gt}=g(ut,bt);if(!Bt)throw new Error("Point.fromHex: invalid y coordinate");let vt=(gt&kt)===kt,Kt=($&128)!==0;if(!E&&gt===le&&Kt)throw new Error("Point.fromHex: x=0 and x_0=1");return Kt!==vt&&(gt=u(-gt)),h.fromAffine({x:gt,y:X})}static fromPrivateKey(y){let{scalar:E}=q(y);return b.multiply(E)}toRawBytes(){let{x:y,y:E}=this.toAffine(),I=qr(E,e.BYTES);return I[I.length-1]|=y&kt?128:0,I}toHex(){return Ne(this.toRawBytes())}}h.BASE=new h(t.Gx,t.Gy,kt,u(t.Gx*t.Gy)),h.ZERO=new h(le,kt,kt,le);let{BASE:b,ZERO:P}=h,T=jo(h,a*8);function D(S){return rt(S,n)}function F(S){return D(Qe(S))}function q(S){let y=e.BYTES;S=nt("private key",S,y);let E=nt("hashed private key",s(S),2*y),I=p(E.slice(0,y)),N=E.slice(y,2*y),K=F(I);return{head:I,prefix:N,scalar:K}}function R(S){let{head:y,prefix:E,scalar:I}=q(S),N=b.multiply(I),K=N.toRawBytes();return{head:y,prefix:E,scalar:I,point:N,pointBytes:K}}function U(S){return R(S).pointBytes}function O(S=Uint8Array.of(),...y){let E=Oe(...y);return F(s(m(E,nt("context",S),!!o)))}function ht(S,y,E={}){S=nt("message",S),o&&(S=o(S));let{prefix:I,scalar:N,pointBytes:K}=R(y),V=O(E.context,I,S),$=b.multiply(V).toRawBytes(),X=O(E.context,$,K,S),J=D(V+X*N);Vt("signature.s",J,le,n);let pt=Oe($,qr(J,e.BYTES));return nt("result",pt,e.BYTES*2)}let _=jm;function A(S,y,E,I=_){let{context:N,zip215:K}=I,V=e.BYTES;S=nt("signature",S,2*V),y=nt("message",y),E=nt("publicKey",E,V),K!==void 0&&ce("zip215",K),o&&(y=o(y));let $=Qe(S.slice(V,2*V)),X,J,pt;try{X=h.fromHex(E,K),J=h.fromHex(S.slice(0,V),K),pt=b.multiplyUnsafe($)}catch{return!1}if(!K&&X.isSmallOrder())return!1;let ut=O(N,J.toRawBytes(),X.toRawBytes(),y);return J.add(X.multiplyUnsafe(ut)).subtract(pt).clearCofactor().equals(h.ZERO)}return b._setWindowSize(8),{CURVE:t,getPublicKey:U,sign:ht,verify:A,ExtendedPoint:h,utils:{getExtendedPublicKey:R,randomPrivateKey:()=>i(e.BYTES),precompute(S=8,y=h.BASE){return y._setWindowSize(S),y.multiply(BigInt(3)),y}}}}var Ha=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),If=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),i1=BigInt(0),Ym=BigInt(1),Cf=BigInt(2),a1=BigInt(3),Zm=BigInt(5),Qm=BigInt(8);function Jm(r){let t=BigInt(10),e=BigInt(20),n=BigInt(40),o=BigInt(80),s=Ha,a=r*r%s*r%s,c=ot(a,Cf,s)*a%s,l=ot(c,Ym,s)*r%s,u=ot(l,Zm,s)*l%s,f=ot(u,t,s)*u%s,d=ot(f,e,s)*f%s,g=ot(d,n,s)*d%s,p=ot(g,o,s)*g%s,m=ot(p,o,s)*g%s,w=ot(m,t,s)*u%s;return{pow_p_5_8:ot(w,Cf,s)*r%s,b2:a}}function tg(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function eg(r,t){let e=Ha,n=rt(t*t*t,e),o=rt(n*n*t,e),s=Jm(r*o).pow_p_5_8,i=rt(r*n*s,e),a=rt(t*i*i,e),c=i,l=rt(i*If,e),u=a===r,f=a===rt(-r,e),d=a===rt(-r*If,e);return u&&(i=c),(f||d)&&(i=l),yf(i,e)&&(i=rt(-i,e)),{isValid:u||f,value:i}}var Pf=Ee(Ha,void 0,!0),rg={a:Pf.create(BigInt(-1)),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:Pf,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:Qm,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:of,randomBytes:Ur,adjustScalarBytes:tg,uvRatio:eg},Rn=_f(rg);var Yo=32,Zo=64,$a=32;function Tf(){let r=Rn.utils.randomPrivateKey(),t=Rn.getPublicKey(r);return{privateKey:ng(r,t),publicKey:t}}function Lf(r,t){let e=r.subarray(0,$a);return Rn.sign(t instanceof Uint8Array?t:t.subarray(),e)}function Df(r,t,e){return Rn.verify(t,e instanceof Uint8Array?e:e.subarray(),r)}function ng(r,t){let e=new Uint8Array(Zo);for(let n=0;n<$a;n++)e[n]=r[n],e[$a+n]=t[n];return e}var Nn=class{type="Ed25519";raw;constructor(t){this.raw=Jo(t,Yo)}toMultihash(){return Zt.digest(Gt(this))}toCID(){return it.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}verify(t,e){return Df(this.raw,e,t)}},Qo=class{type="Ed25519";raw;publicKey;constructor(t,e){this.raw=Jo(t,Zo),this.publicKey=new Nn(e)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}sign(t){return Lf(this.raw,t)}};function Ga(r){return r=Jo(r,Yo),new Nn(r)}async function Mf(){let{privateKey:r,publicKey:t}=Tf();return new Qo(r,t)}function Jo(r,t){if(r=Uint8Array.from(r??[]),r.length!==t)throw new M(`Key must be a Uint8Array of length ${t}, got ${r.length}`);return r}var og=Math.pow(2,7),sg=Math.pow(2,14),ig=Math.pow(2,21),Wa=Math.pow(2,28),ja=Math.pow(2,35),Xa=Math.pow(2,42),Ya=Math.pow(2,49),Q=128,At=127;function mt(r){if(r<og)return 1;if(r<sg)return 2;if(r<ig)return 3;if(r<Wa)return 4;if(r<ja)return 5;if(r<Xa)return 6;if(r<Ya)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Za(r,t,e=0){switch(mt(r)){case 8:t[e++]=r&255|Q,r/=128;case 7:t[e++]=r&255|Q,r/=128;case 6:t[e++]=r&255|Q,r/=128;case 5:t[e++]=r&255|Q,r/=128;case 4:t[e++]=r&255|Q,r>>>=7;case 3:t[e++]=r&255|Q,r>>>=7;case 2:t[e++]=r&255|Q,r>>>=7;case 1:{t[e++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return t}function ag(r,t,e=0){switch(mt(r)){case 8:t.set(e++,r&255|Q),r/=128;case 7:t.set(e++,r&255|Q),r/=128;case 6:t.set(e++,r&255|Q),r/=128;case 5:t.set(e++,r&255|Q),r/=128;case 4:t.set(e++,r&255|Q),r>>>=7;case 3:t.set(e++,r&255|Q),r>>>=7;case 2:t.set(e++,r&255|Q),r>>>=7;case 1:{t.set(e++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return t}function Qa(r,t){let e=r[t],n=0;if(n+=e&At,e<Q||(e=r[t+1],n+=(e&At)<<7,e<Q)||(e=r[t+2],n+=(e&At)<<14,e<Q)||(e=r[t+3],n+=(e&At)<<21,e<Q)||(e=r[t+4],n+=(e&At)*Wa,e<Q)||(e=r[t+5],n+=(e&At)*ja,e<Q)||(e=r[t+6],n+=(e&At)*Xa,e<Q)||(e=r[t+7],n+=(e&At)*Ya,e<Q))return n;throw new RangeError("Could not decode varint")}function cg(r,t){let e=r.get(t),n=0;if(n+=e&At,e<Q||(e=r.get(t+1),n+=(e&At)<<7,e<Q)||(e=r.get(t+2),n+=(e&At)<<14,e<Q)||(e=r.get(t+3),n+=(e&At)<<21,e<Q)||(e=r.get(t+4),n+=(e&At)*Wa,e<Q)||(e=r.get(t+5),n+=(e&At)*ja,e<Q)||(e=r.get(t+6),n+=(e&At)*Xa,e<Q)||(e=r.get(t+7),n+=(e&At)*Ya,e<Q))return n;throw new RangeError("Could not decode varint")}function _t(r,t,e=0){return t==null&&(t=St(mt(r))),t instanceof Uint8Array?Za(r,t,e):ag(r,t,e)}function te(r,t=0){return r instanceof Uint8Array?Qa(r,t):cg(r,t)}var Ja=new Float32Array([-0]),Be=new Uint8Array(Ja.buffer);function Rf(r,t,e){Ja[0]=r,t[e]=Be[0],t[e+1]=Be[1],t[e+2]=Be[2],t[e+3]=Be[3]}function Nf(r,t){return Be[0]=r[t],Be[1]=r[t+1],Be[2]=r[t+2],Be[3]=r[t+3],Ja[0]}var tc=new Float64Array([-0]),It=new Uint8Array(tc.buffer);function Of(r,t,e){tc[0]=r,t[e]=It[0],t[e+1]=It[1],t[e+2]=It[2],t[e+3]=It[3],t[e+4]=It[4],t[e+5]=It[5],t[e+6]=It[6],t[e+7]=It[7]}function Bf(r,t){return It[0]=r[t],It[1]=r[t+1],It[2]=r[t+2],It[3]=r[t+3],It[4]=r[t+4],It[5]=r[t+5],It[6]=r[t+6],It[7]=r[t+7],tc[0]}var lg=BigInt(Number.MAX_SAFE_INTEGER),ug=BigInt(Number.MIN_SAFE_INTEGER),Ht=class r{lo;hi;constructor(t,e){this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){let e=~this.lo+1>>>0,n=~this.hi>>>0;return e===0&&(n=n+1>>>0),-(e+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let e=~this.lo+1>>>0,n=~this.hi>>>0;return e===0&&(n=n+1>>>0),-(BigInt(e)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){let t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){let t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){let t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:n<128?9:10}static fromBigInt(t){if(t===0n)return nr;if(t<lg&&t>ug)return this.fromNumber(Number(t));let e=t<0n;e&&(t=-t);let n=t>>32n,o=t-(n<<32n);return e&&(n=~n|0n,o=~o|0n,++o>Ff&&(o=0n,++n>Ff&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(t){if(t===0)return nr;let e=t<0;e&&(t=-t);let n=t>>>0,o=(t-n)/4294967296>>>0;return e&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(t){return typeof t=="number"?r.fromNumber(t):typeof t=="bigint"?r.fromBigInt(t):typeof t=="string"?r.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new r(t.low>>>0,t.high>>>0):nr}},nr=new Ht(0,0);nr.toBigInt=function(){return 0n};nr.zzEncode=nr.zzDecode=function(){return this};nr.length=function(){return 1};var Ff=4294967296n;function Uf(r){let t=0,e=0;for(let n=0;n<r.length;++n)e=r.charCodeAt(n),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,t+=4):t+=3;return t}function Kf(r,t,e){if(e-t<1)return"";let o,s=[],i=0,a;for(;t<e;)a=r[t++],a<128?s[i++]=a:a>191&&a<224?s[i++]=(a&31)<<6|r[t++]&63:a>239&&a<365?(a=((a&7)<<18|(r[t++]&63)<<12|(r[t++]&63)<<6|r[t++]&63)-65536,s[i++]=55296+(a>>10),s[i++]=56320+(a&1023)):s[i++]=(a&15)<<12|(r[t++]&63)<<6|r[t++]&63,i>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,s)),i=0);return o!=null?(i>0&&o.push(String.fromCharCode.apply(String,s.slice(0,i))),o.join("")):String.fromCharCode.apply(String,s.slice(0,i))}function ec(r,t,e){let n=e,o,s;for(let i=0;i<r.length;++i)o=r.charCodeAt(i),o<128?t[e++]=o:o<2048?(t[e++]=o>>6|192,t[e++]=o&63|128):(o&64512)===55296&&((s=r.charCodeAt(i+1))&64512)===56320?(o=65536+((o&1023)<<10)+(s&1023),++i,t[e++]=o>>18|240,t[e++]=o>>12&63|128,t[e++]=o>>6&63|128,t[e++]=o&63|128):(t[e++]=o>>12|224,t[e++]=o>>6&63|128,t[e++]=o&63|128);return e-n}function ee(r,t){return RangeError(`index out of range: ${r.pos} + ${t??1} > ${r.len}`)}function ts(r,t){return(r[t-4]|r[t-3]<<8|r[t-2]<<16|r[t-1]<<24)>>>0}var rc=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(t){this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,ee(this,10);return t}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw ee(this,4);return ts(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw ee(this,4);return ts(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw ee(this,4);let t=Nf(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw ee(this,4);let t=Bf(this.buf,this.pos);return this.pos+=8,t}bytes(){let t=this.uint32(),e=this.pos,n=this.pos+t;if(n>this.len)throw ee(this,t);return this.pos+=t,e===n?new Uint8Array(0):this.buf.subarray(e,n)}string(){let t=this.bytes();return Kf(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw ee(this,t);this.pos+=t}else do if(this.pos>=this.len)throw ee(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){let t=new Ht(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw ee(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw ee(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw ee(this,8);let t=ts(this.buf,this.pos+=4),e=ts(this.buf,this.pos+=4);return new Ht(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let t=Qa(this.buf,this.pos);return this.pos+=mt(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function nc(r){return new rc(r instanceof Uint8Array?r:r.subarray())}function Mt(r,t,e){let n=nc(r);return t.decode(n,void 0,e)}function oc(r){let t=r??8192,e=t>>>1,n,o=t;return function(i){if(i<1||i>e)return St(i);o+i>t&&(n=St(t),o=0);let a=n.subarray(o,o+=i);return(o&7)!==0&&(o=(o|7)+1),a}}var or=class{fn;len;next;val;constructor(t,e,n){this.fn=t,this.len=e,this.next=void 0,this.val=n}};function sc(){}var ac=class{head;tail;len;next;constructor(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}},fg=oc();function dg(r){return globalThis.Buffer!=null?St(r):fg(r)}var Bn=class{len;head;tail;states;constructor(){this.len=0,this.head=new or(sc,0,0),this.tail=this.head,this.states=null}_push(t,e,n){return this.tail=this.tail.next=new or(t,e,n),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new cc((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(es,10,Ht.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){let e=Ht.fromBigInt(t);return this._push(es,e.length(),e)}uint64Number(t){return this._push(Za,mt(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){let e=Ht.fromBigInt(t).zzEncode();return this._push(es,e.length(),e)}sint64Number(t){let e=Ht.fromNumber(t).zzEncode();return this._push(es,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(ic,1,t?1:0)}fixed32(t){return this._push(On,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){let e=Ht.fromBigInt(t);return this._push(On,4,e.lo)._push(On,4,e.hi)}fixed64Number(t){let e=Ht.fromNumber(t);return this._push(On,4,e.lo)._push(On,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(Rf,4,t)}double(t){return this._push(Of,8,t)}bytes(t){let e=t.length>>>0;return e===0?this._push(ic,1,0):this.uint32(e)._push(pg,e,t)}string(t){let e=Uf(t);return e!==0?this.uint32(e)._push(ec,e,t):this._push(ic,1,0)}fork(){return this.states=new ac(this),this.head=this.tail=new or(sc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new or(sc,0,0),this.len=0),this}ldelim(){let t=this.head,e=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=t.next,this.tail=e,this.len+=n),this}finish(){let t=this.head.next,e=dg(this.len),n=0;for(;t!=null;)t.fn(t.val,e,n),n+=t.len,t=t.next;return e}};function ic(r,t,e){t[e]=r&255}function hg(r,t,e){for(;r>127;)t[e++]=r&127|128,r>>>=7;t[e]=r}var cc=class extends or{next;constructor(t,e){super(hg,t,e),this.next=void 0}};function es(r,t,e){for(;r.hi!==0;)t[e++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)t[e++]=r.lo&127|128,r.lo=r.lo>>>7;t[e++]=r.lo}function On(r,t,e){t[e]=r&255,t[e+1]=r>>>8&255,t[e+2]=r>>>16&255,t[e+3]=r>>>24}function pg(r,t,e){t.set(r,e)}globalThis.Buffer!=null&&(Bn.prototype.bytes=function(r){let t=r.length>>>0;return this.uint32(t),t>0&&this._push(mg,t,r),this},Bn.prototype.string=function(r){let t=globalThis.Buffer.byteLength(r);return this.uint32(t),t>0&&this._push(gg,t,r),this});function mg(r,t,e){t.set(r,e)}function gg(r,t,e){r.length<40?ec(r,t,e):t.utf8Write!=null?t.utf8Write(r,e):t.set(L(r),e)}function lc(){return new Bn}function Rt(r,t){let e=lc();return t.encode(r,e,{lengthDelimited:!1}),e.finish()}var Hr;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Hr||(Hr={}));function rs(r,t,e,n){return{name:r,type:t,encode:e,decode:n}}function uc(r){function t(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let e=function(s,i){let a=t(s);i.int32(a)},n=function(s){let i=s.int32();return t(i)};return rs("enum",Hr.VARINT,e,n)}function Nt(r,t){return rs("message",Hr.LENGTH_DELIMITED,r,t)}var sr=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Fn=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var ft;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(ft||(ft={}));var fc;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(fc||(fc={}));(function(r){r.codec=()=>uc(fc)})(ft||(ft={}));var ue;(function(r){let t;r.codec=()=>(t==null&&(t=Nt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.Type!=null&&(n.uint32(8),ft.codec().encode(e.Type,n)),e.Data!=null&&(n.uint32(18),n.bytes(e.Data)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.Type=ft.codec().decode(e);break}case 2:{s.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Rt(e,r.codec()),r.decode=(e,n)=>Mt(e,r.codec(),n)})(ue||(ue={}));var dc;(function(r){let t;r.codec=()=>(t==null&&(t=Nt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.Type!=null&&(n.uint32(8),ft.codec().encode(e.Type,n)),e.Data!=null&&(n.uint32(18),n.bytes(e.Data)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.Type=ft.codec().decode(e);break}case 2:{s.Data=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Rt(e,r.codec()),r.decode=(e,n)=>Mt(e,r.codec(),n)})(dc||(dc={}));function $r(r){if(isNaN(r)||r<=0)throw new M("random bytes length must be a Number bigger than 0");return Ur(r)}var Un=class extends Error{constructor(t="An error occurred while signing a message"){super(t),this.name="SigningError"}},Kn=class extends Error{constructor(t="An error occurred while verifying a message"){super(t),this.name="VerificationError"}},ns=class extends Error{constructor(t="Missing Web Crypto API"){super(t),this.name="WebCryptoMissingError"}};var Vf={get(r=globalThis){let t=r.crypto;if(t?.subtle==null)throw new ns("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};var Fe=Vf;var zn={};Ft(zn,{MAX_RSA_KEY_SIZE:()=>hc,generateRSAKeyPair:()=>vc,jwkToJWKKeyPair:()=>Wf,jwkToPkcs1:()=>xg,jwkToPkix:()=>yc,jwkToRSAPrivateKey:()=>Ec,pkcs1MessageToJwk:()=>mc,pkcs1MessageToRSAPrivateKey:()=>wc,pkcs1ToJwk:()=>bg,pkcs1ToRSAPrivateKey:()=>Gf,pkixMessageToJwk:()=>gc,pkixMessageToRSAPublicKey:()=>xc,pkixToJwk:()=>Eg,pkixToRSAPublicKey:()=>bc});var os=$o;var Gr=class{type="RSA";jwk;_raw;_multihash;constructor(t,e){this.jwk=t,this._multihash=e}get raw(){return this._raw==null&&(this._raw=zn.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return it.createV1(114,this._multihash)}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}verify(t,e){return $f(this.jwk,e,t)}},qn=class{type="RSA";jwk;_raw;publicKey;constructor(t,e){this.jwk=t,this.publicKey=e}get raw(){return this._raw==null&&(this._raw=zn.jwkToPkcs1(this.jwk)),this._raw}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}sign(t){return Hf(this.jwk,t)}};var hc=8192,pc=18,yg=1062,wg=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function bg(r){let t=me(r);return mc(t)}function mc(r){return{n:B(r[1],"base64url"),e:B(r[2],"base64url"),d:B(r[3],"base64url"),p:B(r[4],"base64url"),q:B(r[5],"base64url"),dp:B(r[6],"base64url"),dq:B(r[7],"base64url"),qi:B(r[8],"base64url"),kty:"RSA"}}function xg(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new M("JWK was missing components");return Qt([Lt(Uint8Array.from([0])),Lt(L(r.n,"base64url")),Lt(L(r.e,"base64url")),Lt(L(r.d,"base64url")),Lt(L(r.p,"base64url")),Lt(L(r.q,"base64url")),Lt(L(r.dp,"base64url")),Lt(L(r.dq,"base64url")),Lt(L(r.qi,"base64url"))]).subarray()}function Eg(r){let t=me(r,{offset:0});return gc(t)}function gc(r){let t=me(r[1],{offset:0});return{kty:"RSA",n:B(t[0],"base64url"),e:B(t[1],"base64url")}}function yc(r){if(r.n==null||r.e==null)throw new M("JWK was missing components");return Qt([wg,In(Qt([Lt(L(r.n,"base64url")),Lt(L(r.e,"base64url"))]))]).subarray()}function Gf(r){let t=me(r);return wc(t)}function wc(r){let t=mc(r);return Ec(t)}function bc(r,t){if(r.byteLength>=yg)throw new Cr("Key size is too large");let e=me(r,{offset:0});return xc(e,r,t)}function xc(r,t,e){let n=gc(r);if(e==null){let o=os(ue.encode({Type:ft.RSA,Data:t}));e=Yt(pc,o)}return new Gr(n,e)}function Ec(r){if(Xf(r)>hc)throw new M("Key size is too large");let t=Wf(r),e=os(ue.encode({Type:ft.RSA,Data:yc(t.publicKey)})),n=Yt(pc,e);return new qn(t.privateKey,new Gr(t.publicKey,n))}async function vc(r){if(r>hc)throw new M("Key size is too large");let t=await jf(r),e=os(ue.encode({Type:ft.RSA,Data:yc(t.publicKey)})),n=Yt(pc,e);return new qn(t.privateKey,new Gr(t.publicKey,n))}function Wf(r){if(r==null)throw new M("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function jf(r){let t=await Fe.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),e=await vg(t);return{privateKey:e[0],publicKey:e[1]}}async function Hf(r,t){let e=await Fe.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Fe.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(n,0,n.byteLength)}async function $f(r,t,e){let n=await Fe.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Fe.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,t,e instanceof Uint8Array?e:e.subarray())}async function vg(r){if(r.privateKey==null||r.publicKey==null)throw new M("Private and public key are required");return Promise.all([Fe.get().subtle.exportKey("jwk",r.privateKey),Fe.get().subtle.exportKey("jwk",r.publicKey)])}function Xf(r){if(r.kty!=="RSA")throw new M("invalid key type");if(r.n==null)throw new M("invalid key modulus");return L(r.n,"base64url").length*8}var ss=class extends Br{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,Hu(t);let n=Cn(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let o=this.blockLen,s=new Uint8Array(o);s.set(n.length>o?t.create().update(n).digest():n);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=t.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),ge(s)}update(t){return Fr(this),this.iHash.update(t),this}digestInto(t){Fr(this),Xe(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:e,iHash:n,finished:o,destroyed:s,blockLen:i,outputLen:a}=this;return t=t,t.finished=o,t.destroyed=s,t.blockLen=i,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=n._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Sc=(r,t,e)=>new ss(r,t).update(e).digest();Sc.create=(r,t)=>new ss(r,t);function Yf(r){r.lowS!==void 0&&ce("lowS",r.lowS),r.prehash!==void 0&&ce("prehash",r.prehash)}function Sg(r){let t=Mn(r);xe(t,{a:"field",b:"field"},{allowInfinityPoint:"boolean",allowedPrivateKeyLengths:"array",clearCofactor:"function",fromBytes:"function",isTorsionFree:"function",toBytes:"function",wrapPrivateKey:"boolean"});let{endo:e,Fp:n,a:o}=t;if(e){if(!n.eql(o,n.ZERO))throw new Error("invalid endo: CURVE.a must be 0");if(typeof e!="object"||typeof e.beta!="bigint"||typeof e.splitScalar!="function")throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function')}return Object.freeze({...t})}var Ic=class extends Error{constructor(t=""){super(t)}},ve={Err:Ic,_tlv:{encode:(r,t)=>{let{Err:e}=ve;if(r<0||r>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");let n=t.length/2,o=Dn(n);if(o.length/2&128)throw new e("tlv.encode: long form length too big");let s=n>127?Dn(o.length/2|128):"";return Dn(r)+s+o+t},decode(r,t){let{Err:e}=ve,n=0;if(r<0||r>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[n++]!==r)throw new e("tlv.decode: wrong tlv");let o=t[n++],s=!!(o&128),i=0;if(!s)i=o;else{let c=o&127;if(!c)throw new e("tlv.decode(long): indefinite length not supported");if(c>4)throw new e("tlv.decode(long): byte length is too big");let l=t.subarray(n,n+c);if(l.length!==c)throw new e("tlv.decode: length bytes not complete");if(l[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(let u of l)i=i<<8|u;if(n+=c,i<128)throw new e("tlv.decode(long): not minimal encoding")}let a=t.subarray(n,n+i);if(a.length!==i)throw new e("tlv.decode: wrong value length");return{v:a,l:t.subarray(n+i)}}},_int:{encode(r){let{Err:t}=ve;if(r<Se)throw new t("integer: negative integers are not allowed");let e=Dn(r);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return e},decode(r){let{Err:t}=ve;if(r[0]&128)throw new t("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return be(r)}},toSig(r){let{Err:t,_int:e,_tlv:n}=ve,o=nt("signature",r),{v:s,l:i}=n.decode(48,o);if(i.length)throw new t("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,s),{v:l,l:u}=n.decode(2,c);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:e.decode(a),s:e.decode(l)}},hexFromSig(r){let{_tlv:t,_int:e}=ve,n=t.encode(2,e.encode(r.r)),o=t.encode(2,e.encode(r.s)),s=n+o;return t.encode(48,s)}};function Ac(r,t){return Ne(Je(r,t))}var Se=BigInt(0),wt=BigInt(1),R2=BigInt(2),_c=BigInt(3),Ag=BigInt(4);function _g(r){let t=Sg(r),{Fp:e}=t,n=Ee(t.n,t.nBitLength),o=t.toBytes||((x,h,b)=>{let P=h.toAffine();return Oe(Uint8Array.from([4]),e.toBytes(P.x),e.toBytes(P.y))}),s=t.fromBytes||(x=>{let h=x.subarray(1),b=e.fromBytes(h.subarray(0,e.BYTES)),P=e.fromBytes(h.subarray(e.BYTES,2*e.BYTES));return{x:b,y:P}});function i(x){let{a:h,b}=t,P=e.sqr(x),T=e.mul(P,x);return e.add(e.add(T,e.mul(x,h)),b)}function a(x,h){let b=e.sqr(h),P=i(x);return e.eql(b,P)}if(!a(t.Gx,t.Gy))throw new Error("bad curve params: generator point");let c=e.mul(e.pow(t.a,_c),Ag),l=e.mul(e.sqr(t.b),BigInt(27));if(e.is0(e.add(c,l)))throw new Error("bad curve params: a or b");function u(x){return Go(x,wt,t.n)}function f(x){let{allowedPrivateKeyLengths:h,nByteLength:b,wrapPrivateKey:P,n:T}=t;if(h&&typeof x!="bigint"){if(Kr(x)&&(x=Ne(x)),typeof x!="string"||!h.includes(x.length))throw new Error("invalid private key");x=x.padStart(b*2,"0")}let D;try{D=typeof x=="bigint"?x:be(nt("private key",x,b))}catch{throw new Error("invalid private key, expected hex or "+b+" bytes, got "+typeof x)}return P&&(D=rt(D,T)),Vt("private key",D,wt,T),D}function d(x){if(!(x instanceof m))throw new Error("ProjectivePoint expected")}let g=zr((x,h)=>{let{px:b,py:P,pz:T}=x;if(e.eql(T,e.ONE))return{x:b,y:P};let D=x.is0();h==null&&(h=D?e.ONE:e.inv(T));let F=e.mul(b,h),q=e.mul(P,h),R=e.mul(T,h);if(D)return{x:e.ZERO,y:e.ZERO};if(!e.eql(R,e.ONE))throw new Error("invZ was invalid");return{x:F,y:q}}),p=zr(x=>{if(x.is0()){if(t.allowInfinityPoint&&!e.is0(x.py))return;throw new Error("bad point: ZERO")}let{x:h,y:b}=x.toAffine();if(!e.isValid(h)||!e.isValid(b))throw new Error("bad point: x or y not FE");if(!a(h,b))throw new Error("bad point: equation left != right");if(!x.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class m{constructor(h,b,P){if(h==null||!e.isValid(h))throw new Error("x required");if(b==null||!e.isValid(b)||e.is0(b))throw new Error("y required");if(P==null||!e.isValid(P))throw new Error("z required");this.px=h,this.py=b,this.pz=P,Object.freeze(this)}static fromAffine(h){let{x:b,y:P}=h||{};if(!h||!e.isValid(b)||!e.isValid(P))throw new Error("invalid affine point");if(h instanceof m)throw new Error("projective point not allowed");let T=D=>e.eql(D,e.ZERO);return T(b)&&T(P)?m.ZERO:new m(b,P,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(h){let b=Vr(e,h.map(P=>P.pz));return h.map((P,T)=>P.toAffine(b[T])).map(m.fromAffine)}static fromHex(h){let b=m.fromAffine(s(nt("pointHex",h)));return b.assertValidity(),b}static fromPrivateKey(h){return m.BASE.multiply(f(h))}static msm(h,b){return Xo(m,n,h,b)}_setWindowSize(h){C.setWindowSize(this,h)}assertValidity(){p(this)}hasEvenY(){let{y:h}=this.toAffine();if(e.isOdd)return!e.isOdd(h);throw new Error("Field doesn't support isOdd")}equals(h){d(h);let{px:b,py:P,pz:T}=this,{px:D,py:F,pz:q}=h,R=e.eql(e.mul(b,q),e.mul(D,T)),U=e.eql(e.mul(P,q),e.mul(F,T));return R&&U}negate(){return new m(this.px,e.neg(this.py),this.pz)}double(){let{a:h,b}=t,P=e.mul(b,_c),{px:T,py:D,pz:F}=this,q=e.ZERO,R=e.ZERO,U=e.ZERO,O=e.mul(T,T),ht=e.mul(D,D),_=e.mul(F,F),A=e.mul(T,D);return A=e.add(A,A),U=e.mul(T,F),U=e.add(U,U),q=e.mul(h,U),R=e.mul(P,_),R=e.add(q,R),q=e.sub(ht,R),R=e.add(ht,R),R=e.mul(q,R),q=e.mul(A,q),U=e.mul(P,U),_=e.mul(h,_),A=e.sub(O,_),A=e.mul(h,A),A=e.add(A,U),U=e.add(O,O),O=e.add(U,O),O=e.add(O,_),O=e.mul(O,A),R=e.add(R,O),_=e.mul(D,F),_=e.add(_,_),O=e.mul(_,A),q=e.sub(q,O),U=e.mul(_,ht),U=e.add(U,U),U=e.add(U,U),new m(q,R,U)}add(h){d(h);let{px:b,py:P,pz:T}=this,{px:D,py:F,pz:q}=h,R=e.ZERO,U=e.ZERO,O=e.ZERO,ht=t.a,_=e.mul(t.b,_c),A=e.mul(b,D),k=e.mul(P,F),S=e.mul(T,q),y=e.add(b,P),E=e.add(D,F);y=e.mul(y,E),E=e.add(A,k),y=e.sub(y,E),E=e.add(b,T);let I=e.add(D,q);return E=e.mul(E,I),I=e.add(A,S),E=e.sub(E,I),I=e.add(P,T),R=e.add(F,q),I=e.mul(I,R),R=e.add(k,S),I=e.sub(I,R),O=e.mul(ht,E),R=e.mul(_,S),O=e.add(R,O),R=e.sub(k,O),O=e.add(k,O),U=e.mul(R,O),k=e.add(A,A),k=e.add(k,A),S=e.mul(ht,S),E=e.mul(_,E),k=e.add(k,S),S=e.sub(A,S),S=e.mul(ht,S),E=e.add(E,S),A=e.mul(k,E),U=e.add(U,A),A=e.mul(I,E),R=e.mul(y,R),R=e.sub(R,A),A=e.mul(y,k),O=e.mul(I,O),O=e.add(O,A),new m(R,U,O)}subtract(h){return this.add(h.negate())}is0(){return this.equals(m.ZERO)}wNAF(h){return C.wNAFCached(this,h,m.normalizeZ)}multiplyUnsafe(h){let{endo:b,n:P}=t;Vt("scalar",h,Se,P);let T=m.ZERO;if(h===Se)return T;if(this.is0()||h===wt)return this;if(!b||C.hasPrecomputes(this))return C.wNAFCachedUnsafe(this,h,m.normalizeZ);let{k1neg:D,k1:F,k2neg:q,k2:R}=b.splitScalar(h),U=T,O=T,ht=this;for(;F>Se||R>Se;)F&wt&&(U=U.add(ht)),R&wt&&(O=O.add(ht)),ht=ht.double(),F>>=wt,R>>=wt;return D&&(U=U.negate()),q&&(O=O.negate()),O=new m(e.mul(O.px,b.beta),O.py,O.pz),U.add(O)}multiply(h){let{endo:b,n:P}=t;Vt("scalar",h,wt,P);let T,D;if(b){let{k1neg:F,k1:q,k2neg:R,k2:U}=b.splitScalar(h),{p:O,f:ht}=this.wNAF(q),{p:_,f:A}=this.wNAF(U);O=C.constTimeNegate(F,O),_=C.constTimeNegate(R,_),_=new m(e.mul(_.px,b.beta),_.py,_.pz),T=O.add(_),D=ht.add(A)}else{let{p:F,f:q}=this.wNAF(h);T=F,D=q}return m.normalizeZ([T,D])[0]}multiplyAndAddUnsafe(h,b,P){let T=m.BASE,D=(q,R)=>R===Se||R===wt||!q.equals(T)?q.multiplyUnsafe(R):q.multiply(R),F=D(this,b).add(D(h,P));return F.is0()?void 0:F}toAffine(h){return g(this,h)}isTorsionFree(){let{h,isTorsionFree:b}=t;if(h===wt)return!0;if(b)return b(m,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h,clearCofactor:b}=t;return h===wt?this:b?b(m,this):this.multiplyUnsafe(t.h)}toRawBytes(h=!0){return ce("isCompressed",h),this.assertValidity(),o(m,this,h)}toHex(h=!0){return ce("isCompressed",h),Ne(this.toRawBytes(h))}}m.BASE=new m(t.Gx,t.Gy,e.ONE),m.ZERO=new m(e.ZERO,e.ONE,e.ZERO);let{endo:w,nBitLength:v}=t,C=jo(m,w?Math.ceil(v/2):v);return{CURVE:t,ProjectivePoint:m,normPrivateKeyToScalar:f,weierstrassEquation:i,isWithinCurveOrder:u}}function Ig(r){let t=Mn(r);return xe(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function Zf(r){let t=Ig(r),{Fp:e,n,nByteLength:o,nBitLength:s}=t,i=e.BYTES+1,a=2*e.BYTES+1;function c(_){return rt(_,n)}function l(_){return Wo(_,n)}let{ProjectivePoint:u,normPrivateKeyToScalar:f,weierstrassEquation:d,isWithinCurveOrder:g}=_g({...t,toBytes(_,A,k){let S=A.toAffine(),y=e.toBytes(S.x),E=Oe;return ce("isCompressed",k),k?E(Uint8Array.from([A.hasEvenY()?2:3]),y):E(Uint8Array.from([4]),y,e.toBytes(S.y))},fromBytes(_){let A=_.length,k=_[0],S=_.subarray(1);if(A===i&&(k===2||k===3)){let y=be(S);if(!Go(y,wt,e.ORDER))throw new Error("Point is not on curve");let E=d(y),I;try{I=e.sqrt(E)}catch(V){let $=V instanceof Error?": "+V.message:"";throw new Error("Point is not on curve"+$)}let N=(I&wt)===wt;return(k&1)===1!==N&&(I=e.neg(I)),{x:y,y:I}}else if(A===a&&k===4){let y=e.fromBytes(S.subarray(0,e.BYTES)),E=e.fromBytes(S.subarray(e.BYTES,2*e.BYTES));return{x:y,y:E}}else{let y=i,E=a;throw new Error("invalid Point, expected length of "+y+", or uncompressed "+E+", got "+A)}}});function p(_){let A=n>>wt;return _>A}function m(_){return p(_)?c(-_):_}let w=(_,A,k)=>be(_.slice(A,k));class v{constructor(A,k,S){Vt("r",A,wt,n),Vt("s",k,wt,n),this.r=A,this.s=k,S!=null&&(this.recovery=S),Object.freeze(this)}static fromCompact(A){let k=o;return A=nt("compactSignature",A,k*2),new v(w(A,0,k),w(A,k,2*k))}static fromDER(A){let{r:k,s:S}=ve.toSig(nt("DER",A));return new v(k,S)}assertValidity(){}addRecoveryBit(A){return new v(this.r,this.s,A)}recoverPublicKey(A){let{r:k,s:S,recovery:y}=this,E=T(nt("msgHash",A));if(y==null||![0,1,2,3].includes(y))throw new Error("recovery id invalid");let I=y===2||y===3?k+t.n:k;if(I>=e.ORDER)throw new Error("recovery id 2 or 3 invalid");let N=(y&1)===0?"02":"03",K=u.fromHex(N+Ac(I,e.BYTES)),V=l(I),$=c(-E*V),X=c(S*V),J=u.BASE.multiplyAndAddUnsafe(K,$,X);if(!J)throw new Error("point at infinify");return J.assertValidity(),J}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new v(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return kn(this.toDERHex())}toDERHex(){return ve.hexFromSig(this)}toCompactRawBytes(){return kn(this.toCompactHex())}toCompactHex(){let A=o;return Ac(this.r,A)+Ac(this.s,A)}}let C={isValidPrivateKey(_){try{return f(_),!0}catch{return!1}},normPrivateKeyToScalar:f,randomPrivateKey:()=>{let _=Fa(t.n);return bf(t.randomBytes(_),t.n)},precompute(_=8,A=u.BASE){return A._setWindowSize(_),A.multiply(BigInt(3)),A}};function x(_,A=!0){return u.fromPrivateKey(_).toRawBytes(A)}function h(_){if(typeof _=="bigint")return!1;if(_ instanceof u)return!0;let k=nt("key",_).length,S=e.BYTES,y=S+1,E=2*S+1;if(!(t.allowedPrivateKeyLengths||o===y))return k===y||k===E}function b(_,A,k=!0){if(h(_)===!0)throw new Error("first arg must be private key");if(h(A)===!1)throw new Error("second arg must be public key");return u.fromHex(A).multiply(f(_)).toRawBytes(k)}let P=t.bits2int||function(_){if(_.length>8192)throw new Error("input is too large");let A=be(_),k=_.length*8-s;return k>0?A>>BigInt(k):A},T=t.bits2int_modN||function(_){return c(P(_))},D=tr(s);function F(_){return Vt("num < 2^"+s,_,Se,D),Je(_,o)}function q(_,A,k=R){if(["recovered","canonical"].some(ut=>ut in k))throw new Error("sign() legacy options not supported");let{hash:S,randomBytes:y}=t,{lowS:E,prehash:I,extraEntropy:N}=k;E==null&&(E=!0),_=nt("msgHash",_),Yf(k),I&&(_=nt("prehashed msgHash",S(_)));let K=T(_),V=f(A),$=[F(V),F(K)];if(N!=null&&N!==!1){let ut=N===!0?y(e.BYTES):N;$.push(nt("extraEntropy",ut))}let X=Oe(...$),J=K;function pt(ut){let bt=P(ut);if(!g(bt))return;let Bt=l(bt),gt=u.BASE.multiply(bt).toAffine(),vt=c(gt.x);if(vt===Se)return;let Kt=c(Bt*c(J+vt*V));if(Kt===Se)return;let jt=(gt.x===vt?0:2)|Number(gt.y&wt),mn=Kt;return E&&p(Kt)&&(mn=m(Kt),jt^=1),new v(vt,mn,jt)}return{seed:X,k2sig:pt}}let R={lowS:t.lowS,prehash:!1},U={lowS:t.lowS,prehash:!1};function O(_,A,k=R){let{seed:S,k2sig:y}=q(_,A,k),E=t;return ff(E.hash.outputLen,E.nByteLength,E.hmac)(S,y)}u.BASE._setWindowSize(8);function ht(_,A,k,S=U){let y=_;A=nt("msgHash",A),k=nt("publicKey",k);let{lowS:E,prehash:I,format:N}=S;if(Yf(S),"strict"in S)throw new Error("options.strict was renamed to lowS");if(N!==void 0&&N!=="compact"&&N!=="der")throw new Error("format must be compact or der");let K=typeof y=="string"||Kr(y),V=!K&&!N&&typeof y=="object"&&y!==null&&typeof y.r=="bigint"&&typeof y.s=="bigint";if(!K&&!V)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let $,X;try{if(V&&($=new v(y.r,y.s)),K){try{N!=="compact"&&($=v.fromDER(y))}catch(jt){if(!(jt instanceof ve.Err))throw jt}!$&&N!=="der"&&($=v.fromCompact(y))}X=u.fromHex(k)}catch{return!1}if(!$||E&&$.hasHighS())return!1;I&&(A=t.hash(A));let{r:J,s:pt}=$,ut=T(A),bt=l(pt),Bt=c(ut*bt),gt=c(J*bt),vt=u.BASE.multiplyAndAddUnsafe(X,Bt,gt)?.toAffine();return vt?c(vt.x)===J:!1}return{CURVE:t,getPublicKey:x,getSharedSecret:b,sign:O,verify:ht,ProjectivePoint:u,Signature:v,utils:C}}function Cg(r){return{hash:r,hmac:(t,...e)=>Sc(r,t,Ia(...e)),randomBytes:Ur}}function Qf(r,t){let e=n=>Zf({...r,...Cg(n)});return{...e(t),create:e}}var ed=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Jf=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Pg=BigInt(0),Tg=BigInt(1),Cc=BigInt(2),td=(r,t)=>(r+t/Cc)/t;function Lg(r){let t=ed,e=BigInt(3),n=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%t,u=l*l*r%t,f=ot(u,e,t)*u%t,d=ot(f,e,t)*u%t,g=ot(d,Cc,t)*l%t,p=ot(g,o,t)*g%t,m=ot(p,s,t)*p%t,w=ot(m,a,t)*m%t,v=ot(w,c,t)*w%t,C=ot(v,a,t)*m%t,x=ot(C,e,t)*u%t,h=ot(x,i,t)*p%t,b=ot(h,n,t)*l%t,P=ot(b,Cc,t);if(!Pc.eql(Pc.sqr(P),r))throw new Error("Cannot find square root");return P}var Pc=Ee(ed,void 0,void 0,{sqrt:Lg}),re=Qf({a:Pg,b:BigInt(7),Fp:Pc,n:Jf,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let t=Jf,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Tg*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),o=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=e,i=BigInt("0x100000000000000000000000000000000"),a=td(s*r,t),c=td(-n*r,t),l=rt(r-a*e-c*o,t),u=rt(-a*n-c*s,t),f=l>i,d=u>i;if(f&&(l=t-l),d&&(u=t-u),l>i||u>i)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:d,k2:u}}}},$o);function Tc(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function rd(r,t){let e=Or.digest(t instanceof Uint8Array?t:t.subarray());if(Tc(e))return e.then(({digest:n})=>re.sign(n,r).toDERRawBytes()).catch(n=>{throw new Un(String(n))});try{return re.sign(e.digest,r).toDERRawBytes()}catch(n){throw new Un(String(n))}}function nd(r,t,e){let n=Or.digest(e instanceof Uint8Array?e:e.subarray());if(Tc(n))return n.then(({digest:o})=>re.verify(t,o,r)).catch(o=>{throw new Kn(String(o))});try{return re.verify(t,n.digest,r)}catch(o){throw new Kn(String(o))}}var Vn=class{type="secp256k1";raw;_key;constructor(t){this._key=id(t),this.raw=od(this._key)}toMultihash(){return Zt.digest(Gt(this))}toCID(){return it.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}verify(t,e){return nd(this._key,e,t)}},is=class{type="secp256k1";raw;publicKey;constructor(t,e){this.raw=sd(t),this.publicKey=new Vn(e??ad(t))}equals(t){return t==null||!(t.raw instanceof Uint8Array)?!1:tt(this.raw,t.raw)}sign(t){return rd(this.raw,t)}};function Lc(r){return new Vn(r)}async function cd(){let r=Dg();return new is(r)}function od(r){return re.ProjectivePoint.fromHex(r).toRawBytes(!0)}function sd(r){try{return re.getPublicKey(r,!0),r}catch(t){throw new gn(String(t))}}function id(r){try{return re.ProjectivePoint.fromHex(r),r}catch(t){throw new Cr(String(t))}}function ad(r){try{return re.getPublicKey(r,!0)}catch(t){throw new gn(String(t))}}function Dg(){return re.utils.randomPrivateKey()}async function ld(r,t){if(r==="Ed25519")return Mf();if(r==="secp256k1")return cd();if(r==="RSA")return vc(kg(t));if(r==="ECDSA")return Vu(Mg(t));throw new Le}function Wr(r,t){let{Type:e,Data:n}=ue.decode(r),o=n??new Uint8Array;switch(e){case ft.RSA:return bc(o,t);case ft.Ed25519:return Ga(o);case ft.secp256k1:return Lc(o);case ft.ECDSA:return _a(o);default:throw new Le}}function ud(r){let{Type:t,Data:e}=ue.decode(r.digest),n=e??new Uint8Array;switch(t){case ft.Ed25519:return Ga(n);case ft.secp256k1:return Lc(n);case ft.ECDSA:return _a(n);default:throw new Le}}function Gt(r){return ue.encode({Type:ft[r.type],Data:r.raw})}function kg(r){return r==null?2048:parseInt(r,10)}function Mg(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new M("Unsupported curve, should be P-256, P-384 or P-521")}var fd=Symbol.for("nodejs.util.inspect.custom"),Rg=114,Hn=class{type;multihash;publicKey;string;constructor(t){this.type=t.type,this.multihash=t.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Io]=!0;toString(){return this.string==null&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return it.createV1(Rg,this.multihash)}toJSON(){return this.toString()}equals(t){if(t==null)return!1;if(t instanceof Uint8Array)return tt(this.multihash.bytes,t);if(typeof t=="string")return this.toString()===t;if(t?.toMultihash()?.bytes!=null)return tt(this.multihash.bytes,t.toMultihash().bytes);throw new Error("not valid Id")}[fd](){return`PeerId(${this.toString()})`}},$n=class extends Hn{type="RSA";publicKey;constructor(t){super({...t,type:"RSA"}),this.publicKey=t.publicKey}},Gn=class extends Hn{type="Ed25519";publicKey;constructor(t){super({...t,type:"Ed25519"}),this.publicKey=t.publicKey}},Wn=class extends Hn{type="secp256k1";publicKey;constructor(t){super({...t,type:"secp256k1"}),this.publicKey=t.publicKey}},Ng=2336,jn=class{type="url";multihash;publicKey;url;constructor(t){this.url=t.toString(),this.multihash=Zt.digest(L(this.url))}[fd](){return`PeerId(${this.url})`}[Io]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return it.createV1(Ng,this.toMultihash())}toJSON(){return this.toString()}equals(t){return t==null?!1:(t instanceof Uint8Array&&(t=B(t)),t.toString()===this.toString())}};var Og=114,dd=2336;function fe(r,t){let e;if(r.charAt(0)==="1"||r.charAt(0)==="Q")e=zt(G.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Xn(it.parse(r));if(t==null)throw new M('Please pass a multibase decoder for strings that do not start with "1" or "Q"');e=zt(t.decode(r))}return jr(e)}function Dc(r){if(r.type==="Ed25519")return new Gn({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new Wn({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new $n({multihash:r.toCID().multihash,publicKey:r});throw new Le}function hd(r){return Dc(r.publicKey)}function jr(r){if(Fg(r))return new $n({multihash:r});if(Bg(r))try{let t=ud(r);if(t.type==="Ed25519")return new Gn({multihash:r,publicKey:t});if(t.type==="secp256k1")return new Wn({multihash:r,publicKey:t})}catch{let e=B(r.digest);return new jn(new URL(e))}throw new Lo("Supplied PeerID Multihash is invalid")}function Xn(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==Og&&r.code!==dd)throw new To("Supplied PeerID CID is invalid");if(r.code===dd){let t=B(r.multihash.digest);return new jn(new URL(t))}return jr(r.multihash)}function Bg(r){return r.code===Zt.code}function Fg(r){return r.code===Or.code}function Xr(r){if(typeof r!="object"||r===null)return!1;let t=Object.getPrototypeOf(r);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}var{hasOwnProperty:md}=Object.prototype,{propertyIsEnumerable:Ug}=Object,Yr=(r,t,e)=>{Object.defineProperty(r,t,{value:e,writable:!0,enumerable:!0,configurable:!0})},Kg=void 0,pd={concatArrays:!1,ignoreUndefined:!1},as=r=>{let t=[];for(let e in r)md.call(r,e)&&t.push(e);if(Object.getOwnPropertySymbols){let e=Object.getOwnPropertySymbols(r);for(let n of e)Ug.call(r,n)&&t.push(n)}return t};function Zr(r){return Array.isArray(r)?qg(r):Xr(r)?zg(r):r}function qg(r){let t=r.slice(0,0);return as(r).forEach(e=>{Yr(t,e,Zr(r[e]))}),t}function zg(r){let t=Object.getPrototypeOf(r)===null?Object.create(null):{};return as(r).forEach(e=>{Yr(t,e,Zr(r[e]))}),t}var gd=(r,t,e,n)=>(e.forEach(o=>{typeof t[o]>"u"&&n.ignoreUndefined||(o in r&&r[o]!==Object.getPrototypeOf(r)?Yr(r,o,kc(r[o],t[o],n)):Yr(r,o,Zr(t[o])))}),r),Vg=(r,t,e)=>{let n=r.slice(0,0),o=0;return[r,t].forEach(s=>{let i=[];for(let a=0;a<s.length;a++)md.call(s,a)&&(i.push(String(a)),s===r?Yr(n,o++,s[a]):Yr(n,o++,Zr(s[a])));n=gd(n,s,as(s).filter(a=>!i.includes(a)),e)}),n};function kc(r,t,e){return e.concatArrays&&Array.isArray(r)&&Array.isArray(t)?Vg(r,t,e):!Xr(t)||!Xr(r)?Zr(t):gd(r,t,as(t),e)}function cs(...r){let t=kc(Zr(pd),this!==Kg&&this||{},pd),e={_:{}};for(let n of r)if(n!==void 0){if(!Xr(n))throw new TypeError("`"+n+"` is not an Option Object");e=kc(e,{_:n},t)}return e._}var dt=class extends Event{type;detail;constructor(t,e){super(t),this.type=t,this.detail=e}};var Rc=_o(wd(),1);var Zn=class extends Error{constructor(t){super(t),this.name="TimeoutError"}},Nc=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}},bd=r=>globalThis.DOMException===void 0?new Nc(r):new DOMException(r),xd=r=>{let t=r.reason===void 0?bd("This operation was aborted."):r.reason;return t instanceof Error?t:bd(t)};function Qn(r,t){let{milliseconds:e,fallback:n,message:o,customTimers:s={setTimeout,clearTimeout}}=t,i,a,l=new Promise((u,f)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){let{signal:g}=t;g.aborted&&f(xd(g)),a=()=>{f(xd(g))},g.addEventListener("abort",a,{once:!0})}if(e===Number.POSITIVE_INFINITY){r.then(u,f);return}let d=new Zn;i=s.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(g){f(g)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?u():o instanceof Error?f(o):(d.message=o??`Promise timed out after ${e} milliseconds`,f(d))},e),(async()=>{try{u(await r)}catch(g){f(g)}})()}).finally(()=>{l.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,i),i=void 0},l}function Oc(r,t,e){let n=0,o=r.length;for(;o>0;){let s=Math.trunc(o/2),i=n+s;e(r[i],t)<=0?(n=++i,o-=s+1):o=s}return n}var Jn=class{#t=[];enqueue(t,e){e={priority:0,...e};let n={priority:e.priority,id:e.id,run:t};if(this.size===0||this.#t[this.size-1].priority>=e.priority){this.#t.push(n);return}let o=Oc(this.#t,n,(s,i)=>i.priority-s.priority);this.#t.splice(o,0,n)}setPriority(t,e){let n=this.#t.findIndex(s=>s.id===t);if(n===-1)throw new ReferenceError(`No promise function with the id "${t}" exists in the queue.`);let[o]=this.#t.splice(n,1);this.enqueue(o.run,{priority:e,id:t})}dequeue(){return this.#t.shift()?.run}filter(t){return this.#t.filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return this.#t.length}};var Ue=class extends Rc.default{#t;#e;#r=0;#a;#c;#p=0;#o;#l;#n;#m;#s=0;#u;#i;#g;#b=1n;timeout;constructor(t){if(super(),t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Jn,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${t.intervalCap?.toString()??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${t.interval?.toString()??""}\` (${typeof t.interval})`);this.#t=t.carryoverConcurrencyCount,this.#e=t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0,this.#a=t.intervalCap,this.#c=t.interval,this.#n=new t.queueClass,this.#m=t.queueClass,this.concurrency=t.concurrency,this.timeout=t.timeout,this.#g=t.throwOnTimeout===!0,this.#i=t.autoStart===!1}get#x(){return this.#e||this.#r<this.#a}get#E(){return this.#s<this.#u}#v(){this.#s--,this.#f(),this.emit("next")}#S(){this.#w(),this.#y(),this.#l=void 0}get#A(){let t=Date.now();if(this.#o===void 0){let e=this.#p-t;if(e<0)this.#r=this.#t?this.#s:0;else return this.#l===void 0&&(this.#l=setTimeout(()=>{this.#S()},e)),!0}return!1}#f(){if(this.#n.size===0)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),this.#s===0&&this.emit("idle"),!1;if(!this.#i){let t=!this.#A;if(this.#x&&this.#E){let e=this.#n.dequeue();return e?(this.emit("active"),e(),t&&this.#y(),!0):!1}}return!1}#y(){this.#e||this.#o!==void 0||(this.#o=setInterval(()=>{this.#w()},this.#c),this.#p=Date.now()+this.#c)}#w(){this.#r===0&&this.#s===0&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#r=this.#t?this.#s:0,this.#d()}#d(){for(;this.#f(););}get concurrency(){return this.#u}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);this.#u=t,this.#d()}async#_(t){return new Promise((e,n)=>{t.addEventListener("abort",()=>{n(t.reason)},{once:!0})})}setPriority(t,e){this.#n.setPriority(t,e)}async add(t,e={}){return e.id??=(this.#b++).toString(),e={timeout:this.timeout,throwOnTimeout:this.#g,...e},new Promise((n,o)=>{this.#n.enqueue(async()=>{this.#s++,this.#r++;try{e.signal?.throwIfAborted();let s=t({signal:e.signal});e.timeout&&(s=Qn(Promise.resolve(s),{milliseconds:e.timeout})),e.signal&&(s=Promise.race([s,this.#_(e.signal)]));let i=await s;n(i),this.emit("completed",i)}catch(s){if(s instanceof Zn&&!e.throwOnTimeout){n();return}o(s),this.emit("error",s)}finally{this.#v()}},e),this.emit("add"),this.#f()})}async addAll(t,e){return Promise.all(t.map(async n=>this.add(n,e)))}start(){return this.#i?(this.#i=!1,this.#d(),this):this}pause(){this.#i=!0}clear(){this.#n=new this.#m}async onEmpty(){this.#n.size!==0&&await this.#h("empty")}async onSizeLessThan(t){this.#n.size<t||await this.#h("next",()=>this.#n.size<t)}async onIdle(){this.#s===0&&this.#n.size===0||await this.#h("idle")}async#h(t,e){return new Promise(n=>{let o=()=>{e&&!e()||(this.off(t,o),n())};this.on(t,o)})}get size(){return this.#n.size}sizeBy(t){return this.#n.filter(t).length}get pending(){return this.#s}get isPaused(){return this.#i}};function us(r){let t=[$t.A];return r==null?t:Array.isArray(r)?r.length===0?t:r:[r]}var Bc=60;function fs(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(t=>({name:t.name,type:$t[t.type]})),Answer:(r.Answer??r.answers??[]).map(t=>({name:t.name,type:$t[t.type],TTL:t.TTL??t.ttl??Bc,data:t.data instanceof Uint8Array?B(t.data):t.data}))}}var Gg=4;function Fc(r,t={}){let e=new Ue({concurrency:t.queryConcurrency??Gg});return async(n,o={})=>{let s=new URLSearchParams;s.set("name",n),us(o.types).forEach(a=>{s.append("type",$t[a])}),o.onProgress?.(new dt("dns:query",{detail:n}));let i=await e.add(async()=>{let a=await fetch(`${r}?${s}`,{headers:{accept:"application/dns-json"},signal:o?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=fs(await a.json());return o.onProgress?.(new dt("dns:response",{detail:c})),c},{signal:o.signal});if(i==null)throw new Error("No DNS response received");return i}}function Ed(){return[Fc("https://cloudflare-dns.com/dns-query"),Fc("https://dns.google/resolve")]}var Ad=_o(Sd(),1);var Uc=class{lru;constructor(t){this.lru=(0,Ad.default)(t)}get(t,e){let n=!0,o=[];for(let s of e){let i=this.getAnswers(t,s);if(i.length===0){n=!1;break}o.push(...i)}if(n)return fs({answers:o})}getAnswers(t,e){let n=`${t.toLowerCase()}-${e}`,o=this.lru.get(n);if(o!=null){let s=o.filter(i=>i.expires>Date.now()).map(({expires:i,value:a})=>({...a,TTL:Math.round((i-Date.now())/1e3),type:$t[a.type]}));return s.length===0&&this.lru.remove(n),s}return[]}add(t,e){let n=`${t.toLowerCase()}-${e.type}`,o=this.lru.get(n)??[];o.push({expires:Date.now()+(e.TTL??Bc)*1e3,value:e}),this.lru.set(n,o)}remove(t,e){let n=`${t.toLowerCase()}-${e}`;this.lru.remove(n)}clear(){this.lru.clear()}};function _d(r){return new Uc(r)}var Wg=1e3,ds=class{resolvers;cache;constructor(t){this.resolvers={},this.cache=_d(t.cacheSize??Wg),Object.entries(t.resolvers??{}).forEach(([e,n])=>{Array.isArray(n)||(n=[n]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=n}),this.resolvers["."]==null&&(this.resolvers["."]=Ed())}async query(t,e={}){let n=us(e.types),o=e.cached!==!1?this.cache.get(t,n):void 0;if(o!=null)return e.onProgress?.(new dt("dns:cache",{detail:o})),o;let s=`${t.split(".").pop()}.`,i=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of i){if(e.signal?.aborted===!0)break;try{let l=await c(t,{...e,types:n});for(let u of l.Answer)this.cache.add(t,u);return l}catch(l){a.push(l),e.onProgress?.(new dt("dns:error",{detail:l}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${n} failed`)}};var $t;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})($t||($t={}));function Id(r={}){return new ds(r)}var hs=class{index=0;input="";new(t){return this.index=0,this.input=t,this}readAtomically(t){let e=this.index,n=t();return n===void 0&&(this.index=e),n}parseWith(t){let e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{let e=this.readChar();if(e===t)return e})}readSeparator(t,e,n){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return n()})}readNumber(t,e,n,o){return this.readAtomically(()=>{let s=0,i=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*o)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let d=Number.parseInt(f,t);if(!Number.isNaN(d))return d});if(u===void 0)break;if(s*=t,s+=u,s>l||(i+=1,e!==void 0&&i>e))return}if(i!==0)return!n&&c&&i>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{let t=new Uint8Array(4);for(let e=0;e<t.length;e++){let n=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;t[e]=n}return t})}readIPv6Addr(){let t=e=>{for(let n=0;n<e.length/2;n++){let o=n*2;if(n<e.length-3){let i=this.readSeparator(":",n,()=>this.readIPv4Addr());if(i!==void 0)return e[o]=i[0],e[o+1]=i[1],e[o+2]=i[2],e[o+3]=i[3],[o+4,!0]}let s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[o,!1];e[o]=s>>8,e[o+1]=s&255}return[e.length,!1]};return this.readAtomically(()=>{let e=new Uint8Array(16),[n,o]=t(e);if(n===16)return e;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let s=new Uint8Array(14),i=16-(n+2),[a]=t(s.subarray(0,i));return e.set(s.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var Cd=45,jg=15,Qr=new hs;function ps(r){if(!(r.length>jg))return Qr.new(r).parseWith(()=>Qr.readIPv4Addr())}function ms(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Cd))return Qr.new(r).parseWith(()=>Qr.readIPv6Addr())}function ir(r,t=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Cd)return;let e=Qr.new(r).parseWith(()=>Qr.readIPAddr());if(e)return t&&e.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,e[0],e[1],e[2],e[3]]):e}function Pd(r,t,e){let n=0;for(let o of r)if(!(n<t)){if(n>e)break;if(o!==255)return!1;n++}return!0}function Td(r,t,e,n){let o=0;for(let s of r)if(!(o<e)){if(o>n)break;if(s!==t[o])return!1;o++}return!0}function Kc(r){switch(r.length){case ar:return r.join(".");case cr:{let t=[];for(let e=0;e<r.length;e++)e%2===0&&t.push(r[e].toString(16).padStart(2,"0")+r[e+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw new Error("Invalid ip length")}}function Ld(r){let t=0;for(let[e,n]of r.entries()){if(n===255){t+=8;continue}for(;(n&128)!=0;)t++,n=n<<1;if((n&128)!=0)return-1;for(let o=e+1;o<r.length;o++)if(r[o]!=0)return-1;break}return t}function Dd(r){let t="0x";for(let e of r)t+=(e>>4).toString(16)+(e&15).toString(16);return t}var ar=4,cr=16,Tv=parseInt("0xFFFF",16),Xg=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function to(r,t){t.length===cr&&r.length===ar&&Pd(t,0,11)&&(t=t.slice(12)),t.length===ar&&r.length===cr&&Td(r,Xg,0,11)&&(r=r.slice(12));let e=r.length;if(e!=t.length)throw new Error("Failed to mask ip");let n=new Uint8Array(e);for(let o=0;o<e;o++)n[o]=r[o]&t[o];return n}function kd(r,t){if(typeof t=="string"&&(t=ir(t)),t==null)throw new Error("Invalid ip");if(t.length!==r.network.length)return!1;for(let e=0;e<t.length;e++)if((r.network[e]&r.mask[e])!==(t[e]&r.mask[e]))return!1;return!0}function qc(r){let[t,e]=r.split("/");if(!t||!e)throw new Error("Failed to parse given CIDR: "+r);let n=ar,o=ps(t);if(o==null&&(n=cr,o=ms(t),o==null))throw new Error("Failed to parse given CIDR: "+r);let s=parseInt(e,10);if(Number.isNaN(s)||String(s).length!==e.length||s<0||s>n*8)throw new Error("Failed to parse given CIDR: "+r);let i=zc(s,8*n);return{network:to(o,i),mask:i}}function zc(r,t){if(t!==8*ar&&t!==8*cr)throw new Error("Invalid CIDR mask");if(r<0||r>t)throw new Error("Invalid CIDR mask");let e=t/8,n=new Uint8Array(e);for(let o=0;o<e;o++){if(r>=8){n[o]=255,r-=8;continue}n[o]=255-(255>>r),r=0}return n}var Jr=class{constructor(t,e){if(e==null)({network:this.network,mask:this.mask}=qc(t));else{let n=ir(t);if(n==null)throw new Error("Failed to parse network");e=String(e);let o=parseInt(e,10);if(Number.isNaN(o)||String(o).length!==e.length||o<0||o>n.length*8){let s=ir(e);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=zc(o,8*n.length);this.network=to(n,this.mask)}}contains(t){return kd({network:this.network,mask:this.mask},t)}toString(){let t=Ld(this.mask),e=t!==-1?String(t):Dd(this.mask);return Kc(this.network)+"/"+e}};function ne(r){return!!ps(r)}function tn(r){return!!ms(r)}function gs(r){return!!ir(r)}var Md=ne,Yg=tn,Vc=function(r){let t=0;if(r=r.toString().trim(),Md(r)){let e=new Uint8Array(t+4);return r.split(/\./g).forEach(n=>{e[t++]=parseInt(n,10)&255}),e}if(Yg(r)){let e=r.split(":",8),n;for(n=0;n<e.length;n++){let s=Md(e[n]),i;s&&(i=Vc(e[n]),e[n]=B(i.slice(0,2),"base16")),i!=null&&++n<8&&e.splice(n,0,B(i.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(n=0;n<e.length&&e[n]!=="";n++);let s=[n,1];for(n=9-e.length;n>0;n--)s.push("0");e.splice.apply(e,s)}let o=new Uint8Array(t+16);for(n=0;n<e.length;n++){let s=parseInt(e[n],16);o[t++]=s>>8&255,o[t++]=s&255}return o}throw new Error("invalid ip address")},Rd=function(r,t=0,e){t=~~t,e=e??r.length-t;let n=new DataView(r.buffer);if(e===4){let o=[];for(let s=0;s<e;s++)o.push(r[t+s]);return o.join(".")}if(e===16){let o=[];for(let s=0;s<e;s+=2)o.push(n.getUint16(t+s).toString(16));return o.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var en={},Hc={},Qg=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,-1,"http-path"],[777,-1,"memory"]];Qg.forEach(r=>{let t=Jg(...r);Hc[t.code]=t,en[t.name]=t});function Jg(r,t,e,n,o){return{code:r,size:t,name:e,resolvable:!!n,path:!!o}}function W(r){if(typeof r=="number"){if(Hc[r]!=null)return Hc[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(en[r]!=null)return en[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var t0=W("ip4"),e0=W("ip6"),r0=W("ipcidr");function jc(r,t){switch(W(r).code){case 4:case 41:return o0(t);case 42:return Wc(t);case 43:return B(t,"base10");case 6:case 273:case 33:case 132:return Bd(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Wc(t);case 421:return c0(t);case 444:return Od(t);case 445:return Od(t);case 466:return a0(t);case 481:return globalThis.encodeURIComponent(Wc(t));default:return B(t,"base16")}}function Xc(r,t){switch(W(r).code){case 4:return Nd(t);case 41:return Nd(t);case 42:return Gc(t);case 43:return L(t,"base10");case 6:case 273:case 33:case 132:return Zc(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Gc(t);case 421:return s0(t);case 444:return l0(t);case 445:return u0(t);case 466:return i0(t);case 481:return Gc(globalThis.decodeURIComponent(t));default:return L(t,"base16")}}function Yc(r){let t,e;if(r.stringTuples().forEach(([n,o])=>{(n===t0.code||n===e0.code)&&(e=o),n===r0.code&&(t=o)}),t==null||e==null)throw new Error("Invalid multiaddr");return new Jr(e,t)}var $c=Object.values(Sn).map(r=>r.decoder),n0=function(){let r=$c[0].or($c[1]);return $c.slice(2).forEach(t=>r=r.or(t)),r}();function Nd(r){if(!gs(r))throw new Error("invalid ip address");return Vc(r)}function o0(r){let t=Rd(r,0,r.length);if(t==null)throw new Error("ipBuff is required");if(!gs(t))throw new Error("invalid ip address");return t}function Zc(r){let t=new ArrayBuffer(2);return new DataView(t).setUint16(0,r),new Uint8Array(t)}function Bd(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function Gc(r){let t=L(r),e=Uint8Array.from(_t(t.length));return Tt([e,t],e.length+t.length)}function Wc(r){let t=te(r);if(r=r.slice(mt(t)),r.length!==t)throw new Error("inconsistent lengths");return B(r)}function s0(r){let t;r[0]==="Q"||r[0]==="1"?t=zt(G.decode(`z${r}`)).bytes:t=it.parse(r).multihash.bytes;let e=Uint8Array.from(_t(t.length));return Tt([e,t],e.length+t.length)}function i0(r){let t=n0.decode(r),e=Uint8Array.from(_t(t.length));return Tt([e,t],e.length+t.length)}function a0(r){let t=te(r),e=r.slice(mt(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+B(e,"base64url")}function c0(r){let t=te(r),e=r.slice(mt(t));if(e.length!==t)throw new Error("inconsistent lengths");return B(e,"base58btc")}function l0(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);let e=qt.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Zc(n);return Tt([e,o],e.length+o.length)}function u0(r){let t=r.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);let e=qt.decode(`b${t[0]}`),n=parseInt(t[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=Zc(n);return Tt([e,o],e.length+o.length)}function Od(r){let t=r.slice(0,r.length-2),e=r.slice(r.length-2),n=B(t,"base32"),o=Bd(e);return`${n}:${o}`}function Fd(r){r=Qc(r);let t=[],e=[],n=null,o=r.split("/").slice(1);if(o.length===1&&o[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<o.length;s++){let i=o[s],a=W(i);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(s++,s>=o.length)throw new ys("invalid address: "+r);if(a.path===!0){n=Qc(o.slice(s).join("/")),t.push([a.code,Xc(a.code,n)]),e.push([a.code,n]);break}let c=Xc(a.code,o[s]);t.push([a.code,c]),e.push([a.code,jc(a.code,c)])}return{string:Ud(e),bytes:ws(t),tuples:t,stringTuples:e,path:n}}function Jc(r){let t=[],e=[],n=null,o=0;for(;o<r.length;){let s=te(r,o),i=mt(s),a=W(s),c=f0(a,r.slice(o+i));if(c===0){t.push([s]),e.push([s]),o+=i;continue}let l=r.slice(o+i,o+i+c);if(o+=c+i,o>r.length)throw new ys("Invalid address Uint8Array: "+B(r,"base16"));t.push([s,l]);let u=jc(s,l);if(e.push([s,u]),a.path===!0){n=u;break}}return{bytes:Uint8Array.from(r),string:Ud(e),tuples:t,stringTuples:e,path:n}}function Ud(r){let t=[];return r.map(e=>{let n=W(e[0]);return t.push(n.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),Qc(t.join("/"))}function ws(r){return Tt(r.map(t=>{let e=W(t[0]),n=Uint8Array.from(_t(e.code));return t.length>1&&t[1]!=null&&(n=Tt([n,t[1]])),n}))}function f0(r,t){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let e=te(t instanceof Uint8Array?t:Uint8Array.from(t));return e+mt(e)}}function Qc(r){return"/"+r.trim().split("/").filter(t=>t).join("/")}var ys=class extends Error{static name="ParseError";name="ParseError";constructor(t){super(`Error parsing address: ${t}`)}};var d0=Symbol.for("nodejs.util.inspect.custom"),el=Symbol.for("@multiformats/js-multiaddr/multiaddr"),h0=[W("dns").code,W("dns4").code,W("dns6").code,W("dnsaddr").code],tl=class extends Error{constructor(t="No available resolver"){super(t),this.name="NoAvailableResolverError"}},bs=class r{bytes;#t;#e;#r;#a;[el]=!0;constructor(t){t==null&&(t="");let e;if(t instanceof Uint8Array)e=Jc(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=Fd(t)}else if(Ke(t))e=Jc(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,this.#t=e.string,this.#e=e.tuples,this.#r=e.stringTuples,this.#a=e.path}toString(){return this.#t}toJSON(){return this.toString()}toOptions(){let t,e,n,o,s="",i=W("tcp"),a=W("udp"),c=W("ip4"),l=W("ip6"),u=W("dns6"),f=W("ip6zone");for(let[g,p]of this.stringTuples())g===f.code&&(s=`%${p??""}`),h0.includes(g)&&(e=i.name==="tcp"?"tcp":"udp",o=443,n=`${p??""}${s}`,t=g===u.code?6:4),(g===i.code||g===a.code)&&(e=W(g).name==="tcp"?"tcp":"udp",o=parseInt(p??"")),(g===c.code||g===l.code)&&(e=W(g).name==="tcp"?"tcp":"udp",n=`${p??""}${s}`,t=g===l.code?6:4);if(t==null||e==null||n==null||o==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:n,transport:e,port:o}}protos(){return this.#e.map(([t])=>Object.assign({},W(t)))}protoCodes(){return this.#e.map(([t])=>t)}protoNames(){return this.#e.map(([t])=>W(t).name)}tuples(){return this.#e.map(([t,e])=>e==null?[t]:[t,e])}stringTuples(){return this.#r.map(([t,e])=>e==null?[t]:[t,e])}encapsulate(t){return t=new r(t),new r(this.toString()+t.toString())}decapsulate(t){let e=t.toString(),n=this.toString(),o=n.lastIndexOf(e);if(o<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new r(n.slice(0,o))}decapsulateCode(t){let e=this.tuples();for(let n=e.length-1;n>=0;n--)if(e[n][0]===t)return new r(ws(e.slice(0,n)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([n,o])=>{n===en.p2p.code&&t.push([n,o]),n===en["p2p-circuit"].code&&(t=[])});let e=t.pop();if(e?.[1]!=null){let n=e[1];return n[0]==="Q"||n[0]==="1"?B(G.decode(`z${n}`),"base58btc"):B(it.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#a}equals(t){return tt(this.bytes,t.bytes)}async resolve(t){let e=this.protos().find(s=>s.resolvable);if(e==null)return[this];let n=rn.get(e.name);if(n==null)throw new tl(`no available resolver for ${e.name}`);return(await n(this,t)).map(s=>j(s))}nodeAddress(){let t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){let e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[d0](){return`Multiaddr(${this.#t})`}};var rn=new Map;function Ke(r){return!!r?.[el]}function j(r){return new bs(r)}var p0=32,{code:m0}=W("dnsaddr"),rl=class extends Error{constructor(t="Max recursive depth reached"){super(t),this.name="RecursionLimitError"}},lr=async function(t,e={}){let n=e.maxRecursiveDepth??p0;if(n===0)throw new rl("Max recursive depth reached");let[,o]=t.stringTuples().find(([l])=>l===m0)??[],i=await(e?.dns??Id()).query(`_dnsaddr.${o}`,{signal:e?.signal,types:[$t.TXT]}),a=t.getPeerId(),c=[];for(let l of i.Answer){let u=l.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;let f=j(u);if(u.startsWith("/dnsaddr")){let d=await f.resolve({...e,maxRecursiveDepth:n-1});c.push(...d.map(g=>g.toString()))}else c.push(f.toString())}return c};var g0={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:lr}},transportManager:{faultTolerance:$e.FATAL_ALL}};async function Kd(r){let t=cs(g0,r);if(t.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new M("Private network is enforced, but no protector was provided");return t}function y0(r,t){try{if(typeof r=="string"&&r.length>0)return w0(r);if(typeof r=="number"&&isFinite(r))return t?.long?x0(r):b0(r);throw new Error("Value is not a string or number.")}catch(e){let n=E0(e)?`${e.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function w0(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");let t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!t)return NaN;let e=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return e*315576e5;case"weeks":case"week":case"w":return e*6048e5;case"days":case"day":case"d":return e*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return e*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return e*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return e*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}var Es=y0;function b0(r){let t=Math.abs(r);return t>=864e5?`${Math.round(r/864e5)}d`:t>=36e5?`${Math.round(r/36e5)}h`:t>=6e4?`${Math.round(r/6e4)}m`:t>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function x0(r){let t=Math.abs(r);return t>=864e5?xs(r,t,864e5,"day"):t>=36e5?xs(r,t,36e5,"hour"):t>=6e4?xs(r,t,6e4,"minute"):t>=1e3?xs(r,t,1e3,"second"):`${r} ms`}function xs(r,t,e,n){let o=t>=e*1.5;return`${Math.round(r/e)} ${n}${o?"s":""}`}function E0(r){return typeof r=="object"&&r!==null&&"message"in r}function nl(r){e.debug=e,e.default=e,e.coerce=c,e.disable=s,e.enable=o,e.enabled=i,e.humanize=Es,e.destroy=l,Object.keys(r).forEach(u=>{e[u]=r[u]}),e.names=[],e.skips=[],e.formatters={};function t(u){let f=0;for(let d=0;d<u.length;d++)f=(f<<5)-f+u.charCodeAt(d),f|=0;return e.colors[Math.abs(f)%e.colors.length]}e.selectColor=t;function e(u){let f,d=null,g,p;function m(...w){if(!m.enabled)return;let v=m,C=Number(new Date),x=C-(f||C);v.diff=x,v.prev=f,v.curr=C,f=C,w[0]=e.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let h=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(P,T)=>{if(P==="%%")return"%";h++;let D=e.formatters[T];if(typeof D=="function"){let F=w[h];P=D.call(v,F),w.splice(h,1),h--}return P}),e.formatArgs.call(v,w),(v.log||e.log).apply(v,w)}return m.namespace=u,m.useColors=e.useColors(),m.color=e.selectColor(u),m.extend=n,m.destroy=e.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(g!==e.namespaces&&(g=e.namespaces,p=e.enabled(u)),p),set:w=>{d=w}}),typeof e.init=="function"&&e.init(m),m}function n(u,f){let d=e(this.namespace+(typeof f>"u"?":":f)+u);return d.log=this.log,d}function o(u){e.save(u),e.namespaces=u,e.names=[],e.skips=[];let f,d=(typeof u=="string"?u:"").split(/[\s,]+/),g=d.length;for(f=0;f<g;f++)d[f]&&(u=d[f].replace(/\*/g,".*?"),u[0]==="-"?e.skips.push(new RegExp("^"+u.substr(1)+"$")):e.names.push(new RegExp("^"+u+"$")))}function s(){let u=[...e.names.map(a),...e.skips.map(a).map(f=>"-"+f)].join(",");return e.enable(""),u}function i(u){if(u[u.length-1]==="*")return!0;let f,d;for(f=0,d=e.skips.length;f<d;f++)if(e.skips[f].test(u))return!1;for(f=0,d=e.names.length;f<d;f++)if(e.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.setupFormatters(e.formatters),e.enable(e.load()),e}var vs=P0(),v0=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function S0(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function A0(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Es(this.diff),!this.useColors)return;let t="color: "+this.color;r.splice(1,0,t,"color: inherit");let e=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(e++,o==="%c"&&(n=e))}),r.splice(n,0,t)}var _0=console.debug??console.log??(()=>{});function I0(r){try{r?vs?.setItem("debug",r):vs?.removeItem("debug")}catch{}}function C0(){let r;try{r=vs?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function P0(){try{return localStorage}catch{}}function T0(r){r.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}var qd=nl({formatArgs:A0,save:I0,load:C0,useColors:S0,setupFormatters:T0,colors:v0,storage:vs,log:_0});var Ut=qd;Ut.formatters.b=r=>r==null?"undefined":G.baseEncode(r);Ut.formatters.t=r=>r==null?"undefined":qt.baseEncode(r);Ut.formatters.m=r=>r==null?"undefined":da.baseEncode(r);Ut.formatters.p=r=>r==null?"undefined":r.toString();Ut.formatters.c=r=>r==null?"undefined":r.toString();Ut.formatters.k=r=>r==null?"undefined":r.toString();Ut.formatters.a=r=>r==null?"undefined":r.toString();Ut.formatters.e=r=>r==null?"undefined":zd(r.stack)??zd(r.message)??r.toString();function L0(r){let t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=r,t.destroy=()=>!0,t.extend=()=>t,t}function Ss(){return{forComponent(r){return D0(r)}}}function D0(r){let t=L0(`${r}:trace`);return Ut.enabled(`${r}:trace`)&&Ut.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=Ut(`${r}:trace`)),Object.assign(Ut(r),{error:Ut(`${r}:error`),trace:t})}function zd(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function ur(r,t){let e={[Symbol.iterator]:()=>e,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:t(o)}}};return e}function As(r){let t=zt(G.decode(`z${r}`));return jr(t)}var Ae=class{map;constructor(t){if(this.map=new Map,t!=null)for(let[e,n]of t.entries())this.map.set(e.toString(),{key:e,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return ur(this.map.entries(),t=>[t[1].key,t[1].value])}forEach(t){this.map.forEach((e,n)=>{t(e.value,e.key,this)})}get(t){return this.map.get(t.toString())?.value}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),{key:t,value:e})}keys(){return ur(this.map.values(),t=>t.key)}values(){return ur(this.map.values(),t=>t.value)}get size(){return this.map.size}};var fr=class r{set;constructor(t){if(this.set=new Set,t!=null)for(let e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return ur(this.set.entries(),t=>{let e=As(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{let n=As(e);t(n,n,this)})}has(t){return this.set.has(t.toString())}values(){return ur(this.set.values(),t=>As(t))}intersection(t){let e=new r;for(let n of t)this.has(n)&&e.add(n);return e}difference(t){let e=new r;for(let n of this)t.has(n)||e.add(n);return e}union(t){let e=new r;for(let n of t)e.add(n);for(let n of this)e.add(n);return e}};var ol={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Vd={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Hd=new globalThis.TextEncoder;function k0(r,t){let e=ol[t],n=Vd[t];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(t,n*e);return n}function M0(r,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=ol[t],o=Vd[t],s=r;for(;s.length>0;){let i=Hd.encodeInto(s,e);s=s.slice(i.read);for(let a=0;a<i.written;a++)o^=BigInt(e[a]),o=BigInt.asUintN(t,o*n)}return o}function sl(r,{size:t=32,utf8Buffer:e}={}){if(!ol[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(e)return M0(r,t,e);r=Hd.encode(r)}return k0(r,t)}var eo={hash:r=>Number(sl(r,{size:32})),hashV:(r,t)=>R0(eo.hash(r,t))};function R0(r){let t=r.toString(16);return t.length%2===1&&(t=`0${t}`),L(t,"base16")}var il=64,oe=class{fp;h;seed;constructor(t,e,n,o=2){if(o>il)throw new TypeError("Invalid Fingerprint Size");let s=e.hashV(t,n),i=ct(o);for(let a=0;a<i.length;a++)i[a]=s[a];i.length===0&&(i[0]=7),this.fp=i,this.h=e,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return t?.fp instanceof Uint8Array?tt(this.fp,t.fp):!1}};function dr(r,t){return Math.floor(Math.random()*(t-r))+r}var hr=class{contents;constructor(t){this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");let e=dr(0,this.contents.length-1),n=this.contents[e];return this.contents[e]=t,n}remove(t){if(!(t instanceof oe))throw new TypeError("Invalid Fingerprint");let e=this.contents.findIndex(n=>t.equals(n));return e>-1?(this.contents[e]=null,!0):!1}};var N0=500,ro=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(t){this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??eo,this.seed=t.seed??dr(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=L(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=(n^e.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new hr(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new hr(this.bucketSize)),this.buckets[n].add(e)||this.buckets[o].add(e))return this.count++,!0;let s=[n,o],i=s[dr(0,s.length-1)];this.buckets[i]==null&&(this.buckets[i]=new hr(this.bucketSize));for(let a=0;a<N0;a++){let c=this.buckets[i].swap(e);if(c!=null&&(i=(i^c.hash())%this.filterSize,this.buckets[i]==null&&(this.buckets[i]=new hr(this.bucketSize)),this.buckets[i].add(c)))return this.count++,!0}return!1}has(t){typeof t=="string"&&(t=L(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=this.buckets[n]?.has(e)??!1;if(o)return o;let s=(n^e.hash())%this.filterSize;return this.buckets[s]?.has(e)??!1}remove(t){typeof t=="string"&&(t=L(t));let e=new oe(t,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(t,this.seed)%this.filterSize,o=this.buckets[n]?.remove(e)??!1;if(o)return this.count--,o;let s=(n^e.hash())%this.filterSize,i=this.buckets[s]?.remove(e)??!1;return i&&this.count--,i}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},O0={1:.5,2:.84,4:.95,8:.98};function B0(r=.001){return r>.002?2:r>1e-5?4:8}function $d(r,t=.001){let e=B0(t),n=O0[e],o=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*e)),il);return{filterSize:o,bucketSize:e,fingerprintSize:s}}var _s=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(t){this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??eo,this.seed=t.seed??dr(0,Math.pow(2,10)),this.filterSeries=[new ro({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=L(t)),this.has(t))return!0;let e=this.filterSeries.find(n=>n.reliable);if(e==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new ro({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=L(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=L(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}};function no(r,t=.001,e){return new _s({...$d(r,t),...e??{}})}var oo;(function(r){let t;r.codec=()=>(t==null&&(t=Nt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(n.uint32(10),n.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(n.uint32(18),n.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(n.uint32(26),n.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(n.uint32(42),n.bytes(e.signature)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={publicKey:ct(0),payloadType:ct(0),payload:ct(0),signature:ct(0)},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.publicKey=e.bytes();break}case 2:{s.payloadType=e.bytes();break}case 3:{s.payload=e.bytes();break}case 5:{s.signature=e.bytes();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Rt(e,r.codec()),r.decode=(e,n)=>Mt(e,r.codec(),n)})(oo||(oo={}));var Is=class extends Error{constructor(t="Invalid signature"){super(t),this.name="InvalidSignatureError"}};var nn=class r{static createFromProtobuf=async t=>{let e=oo.decode(t),n=Wr(e.publicKey);return new r({publicKey:n,payloadType:e.payloadType,payload:e.payload,signature:e.signature})};static seal=async(t,e)=>{if(e==null)throw new Error("Missing private key");let n=t.domain,o=t.codec,s=t.marshal(),i=Gd(n,o,s),a=await e.sign(i.subarray());return new r({publicKey:e.publicKey,payloadType:o,payload:s,signature:a})};static openAndCertify=async(t,e)=>{let n=await r.createFromProtobuf(t);if(!await n.validate(e))throw new Is("Envelope signature is not valid for the given domain");return n};publicKey;payloadType;payload;signature;marshaled;constructor(t){let{publicKey:e,payloadType:n,payload:o,signature:s}=t;this.publicKey=e,this.payloadType=n,this.payload=o,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=oo.encode({publicKey:Gt(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return t==null?!1:tt(this.marshal(),t.marshal())}async validate(t){let e=Gd(t,this.payloadType,this.payload);return this.publicKey.verify(e.subarray(),this.signature)}},Gd=(r,t,e)=>{let n=L(r),o=_t(n.byteLength),s=_t(t.length),i=_t(e.length);return new Y(o,n,s,t,i,e)};function Wd(r,t){let e=(n,o)=>n.toString().localeCompare(o.toString());return r.length!==t.length?!1:(t.sort(e),r.sort(e).every((n,o)=>t[o].equals(n)))}var jd="libp2p-peer-record",Xd=Uint8Array.from([3,1]);var so;(function(r){let t;(function(n){let o;n.codec=()=>(o==null&&(o=Nt((s,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(s,i,a={})=>{let c={multiaddr:ct(0)},l=i==null?s.len:s.pos+i;for(;s.pos<l;){let u=s.uint32();switch(u>>>3){case 1:{c.multiaddr=s.bytes();break}default:{s.skipType(u&7);break}}}return c})),o),n.encode=s=>Rt(s,n.codec()),n.decode=(s,i)=>Mt(s,n.codec(),i)})(t=r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Nt((n,o,s={})=>{if(s.lengthDelimited!==!1&&o.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(o.uint32(10),o.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(o.uint32(16),o.uint64(n.seq)),n.addresses!=null)for(let i of n.addresses)o.uint32(26),r.AddressInfo.codec().encode(i,o);s.lengthDelimited!==!1&&o.ldelim()},(n,o,s={})=>{let i={peerId:ct(0),seq:0n,addresses:[]},a=o==null?n.len:n.pos+o;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{i.peerId=n.bytes();break}case 2:{i.seq=n.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new sr('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:s.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return i})),e),r.encode=n=>Rt(n,r.codec()),r.decode=(n,o)=>Mt(n,r.codec(),o)})(so||(so={}));var pr=class r{static createFromProtobuf=t=>{let e=so.decode(t),n=jr(zt(e.peerId)),o=(e.addresses??[]).map(i=>j(i.multiaddr)),s=e.seq;return new r({peerId:n,multiaddrs:o,seqNumber:s})};static DOMAIN=jd;static CODEC=Xd;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(t){let{peerId:e,multiaddrs:n,seqNumber:o}=t;this.peerId=e,this.multiaddrs=n??[],this.seqNumber=o??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=so.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof r)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!Wd(this.multiaddrs,t.multiaddrs))}};function F0(r){return r[Symbol.asyncIterator]!=null}function U0(r){if(F0(r))return(async()=>{let e=[];for await(let n of r)e.push(n);return e})();let t=[];for(let e of r)t.push(e);return t}var io=U0;var qe={},on=r=>{r.addEventListener("message",t=>{on.dispatchEvent("message",r,t)}),r.port!=null&&r.port.addEventListener("message",t=>{on.dispatchEvent("message",r,t)})};on.addEventListener=(r,t)=>{qe[r]==null&&(qe[r]=[]),qe[r].push(t)};on.removeEventListener=(r,t)=>{qe[r]!=null&&(qe[r]=qe[r].filter(e=>e===t))};on.dispatchEvent=function(r,t,e){qe[r]!=null&&qe[r].forEach(n=>n(t,e))};var al=on;var cl="lock:worker:request-read",ll="lock:worker:release-read",ul="lock:master:grant-read",fl="lock:worker:request-write",dl="lock:worker:release-write",hl="lock:master:grant-write";var Yd=(r=21)=>Math.random().toString().substring(2);var Zd=(r,t,e,n,o)=>(s,i)=>{if(i.data.type!==e)return;let a={type:i.data.type,name:i.data.name,identifier:i.data.identifier};r.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{s.postMessage({type:o,name:a.name,identifier:a.identifier}),await new Promise(c=>{let l=u=>{if(u?.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===n&&f.identifier===a.identifier&&(s.removeEventListener("message",l),c())};s.addEventListener("message",l)})}}}))},Qd=(r,t,e,n)=>async()=>{let o=Yd();return globalThis.postMessage({type:t,identifier:o,name:r}),new Promise(s=>{let i=a=>{if(a?.data==null)return;let c={type:a.data.type,identifier:a.data.identifier};c.type===e&&c.identifier===o&&(globalThis.removeEventListener("message",i),s(()=>{globalThis.postMessage({type:n,identifier:o,name:r})}))};globalThis.addEventListener("message",i)})},K0={singleProcess:!1},Jd=r=>{if(r=Object.assign({},K0,r),!!globalThis.document||r.singleProcess){let e=new EventTarget;return al.addEventListener("message",Zd(e,"requestReadLock",cl,ll,ul)),al.addEventListener("message",Zd(e,"requestWriteLock",fl,dl,hl)),e}return{isWorker:!0,readLock:e=>Qd(e,cl,ul,ll),writeLock:e=>Qd(e,fl,hl,dl)}};var mr={},ze;async function pl(r,t){let e,n=new Promise(o=>{e=o});return r.add(async()=>Qn((async()=>{await new Promise(o=>{e(()=>{o()})})})(),{milliseconds:t.timeout})),n}var q0=(r,t)=>{if(ze.isWorker===!0)return{readLock:ze.readLock(r,t),writeLock:ze.writeLock(r,t)};let e=new Ue({concurrency:1}),n;return{async readLock(){if(n!=null)return pl(n,t);n=new Ue({concurrency:t.concurrency,autoStart:!1});let o=n,s=pl(n,t);return e.add(async()=>{o.start(),await o.onIdle().then(()=>{n===o&&(n=null)})}),s},async writeLock(){return n=null,pl(e,t)}}},z0={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function ml(r){let t=Object.assign({},z0,r);return ze==null&&(ze=Jd(t),ze.isWorker!==!0&&(ze.addEventListener("requestReadLock",e=>{mr[e.data.name]!=null&&mr[e.data.name].readLock().then(async n=>e.data.handler().finally(()=>{n()}))}),ze.addEventListener("requestWriteLock",async e=>{mr[e.data.name]!=null&&mr[e.data.name].writeLock().then(async n=>e.data.handler().finally(()=>{n()}))}))),mr[t.name]==null&&(mr[t.name]=q0(t.name,t)),mr[t.name]}var _e;(function(r){let t;(function(o){let s;o.codec=()=>(s==null&&(s=Nt((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&i.value.byteLength>0&&(a.uint32(18),a.bytes(i.value)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let l={key:"",value:ct(0)},u=a==null?i.len:i.pos+a;for(;i.pos<u;){let f=i.uint32();switch(f>>>3){case 1:{l.key=i.string();break}case 2:{l.value=i.bytes();break}default:{i.skipType(f&7);break}}}return l})),s),o.encode=i=>Rt(i,o.codec()),o.decode=(i,a)=>Mt(i,o.codec(),a)})(t=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let e;(function(o){let s;o.codec=()=>(s==null&&(s=Nt((i,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),i.key!=null&&i.key!==""&&(a.uint32(10),a.string(i.key)),i.value!=null&&(a.uint32(18),Ps.codec().encode(i.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(i,a,c={})=>{let l={key:""},u=a==null?i.len:i.pos+a;for(;i.pos<u;){let f=i.uint32();switch(f>>>3){case 1:{l.key=i.string();break}case 2:{l.value=Ps.codec().decode(i,i.uint32(),{limits:c.limits?.value});break}default:{i.skipType(f&7);break}}}return l})),s),o.encode=i=>Rt(i,o.codec()),o.decode=(i,a)=>Mt(i,o.codec(),a)})(e=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Nt((o,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),o.addresses!=null)for(let a of o.addresses)s.uint32(10),Cs.codec().encode(a,s);if(o.protocols!=null)for(let a of o.protocols)s.uint32(18),s.string(a);if(o.publicKey!=null&&(s.uint32(34),s.bytes(o.publicKey)),o.peerRecordEnvelope!=null&&(s.uint32(42),s.bytes(o.peerRecordEnvelope)),o.metadata!=null&&o.metadata.size!==0)for(let[a,c]of o.metadata.entries())s.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},s);if(o.tags!=null&&o.tags.size!==0)for(let[a,c]of o.tags.entries())s.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},s);o.updated!=null&&(s.uint32(64),s.uint64Number(o.updated)),i.lengthDelimited!==!1&&s.ldelim()},(o,s,i={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=s==null?o.len:o.pos+s;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{if(i.limits?.addresses!=null&&a.addresses.length===i.limits.addresses)throw new sr('Decode error - map field "addresses" had too many elements');a.addresses.push(Cs.codec().decode(o,o.uint32(),{limits:i.limits?.addresses$}));break}case 2:{if(i.limits?.protocols!=null&&a.protocols.length===i.limits.protocols)throw new sr('Decode error - map field "protocols" had too many elements');a.protocols.push(o.string());break}case 4:{a.publicKey=o.bytes();break}case 5:{a.peerRecordEnvelope=o.bytes();break}case 6:{if(i.limits?.metadata!=null&&a.metadata.size===i.limits.metadata)throw new Fn('Decode error - map field "metadata" had too many elements');let u=r.Peer$metadataEntry.codec().decode(o,o.uint32());a.metadata.set(u.key,u.value);break}case 7:{if(i.limits?.tags!=null&&a.tags.size===i.limits.tags)throw new Fn('Decode error - map field "tags" had too many elements');let u=r.Peer$tagsEntry.codec().decode(o,o.uint32(),{limits:{value:i.limits?.tags$value}});a.tags.set(u.key,u.value);break}case 8:{a.updated=o.uint64Number();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Rt(o,r.codec()),r.decode=(o,s)=>Mt(o,r.codec(),s)})(_e||(_e={}));var Cs;(function(r){let t;r.codec=()=>(t==null&&(t=Nt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(e.multiaddr)),e.isCertified!=null&&(n.uint32(16),n.bool(e.isCertified)),e.observed!=null&&(n.uint32(24),n.uint64Number(e.observed)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={multiaddr:ct(0)},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.multiaddr=e.bytes();break}case 2:{s.isCertified=e.bool();break}case 3:{s.observed=e.uint64Number();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Rt(e,r.codec()),r.decode=(e,n)=>Mt(e,r.codec(),n)})(Cs||(Cs={}));var Ps;(function(r){let t;r.codec=()=>(t==null&&(t=Nt((e,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),e.value!=null&&e.value!==0&&(n.uint32(8),n.uint32(e.value)),e.expiry!=null&&(n.uint32(16),n.uint64(e.expiry)),o.lengthDelimited!==!1&&n.ldelim()},(e,n,o={})=>{let s={value:0},i=n==null?e.len:e.pos+n;for(;e.pos<i;){let a=e.uint32();switch(a>>>3){case 1:{s.value=e.uint32();break}case 2:{s.expiry=e.uint64();break}default:{e.skipType(a&7);break}}}return s})),t),r.encode=e=>Rt(e,r.codec()),r.decode=(e,n)=>Mt(e,r.codec(),n)})(Ps||(Ps={}));function V0(r,t){if(r.publicKey!=null||t.publicKey==null)return r;let e;if(r.type==="RSA"){let o=G.decode(`z${r}`);e=zt(o)}let n=Wr(t.publicKey,e);return Dc(n)}function Ts(r,t,e){let n=_e.decode(t);return Ls(r,n,e)}function Ls(r,t,e){let n=new Map,o=BigInt(Date.now());for(let[s,i]of t.tags.entries())i.expiry!=null&&i.expiry<o||n.set(s,i);return{...t,id:V0(r,t),addresses:t.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-e).map(({multiaddr:s,isCertified:i})=>({multiaddr:j(s),isCertified:i??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}function th(r,t){return H0(r.addresses,t.addresses)&&$0(r.protocols,t.protocols)&&G0(r.publicKey,t.publicKey)&&W0(r.peerRecordEnvelope,t.peerRecordEnvelope)&&j0(r.metadata,t.metadata)&&X0(r.tags,t.tags)}function H0(r,t){return rh(r,t,(e,n)=>!(e.isCertified!==n.isCertified||!tt(e.multiaddr,n.multiaddr)))}function $0(r,t){return rh(r,t,(e,n)=>e===n)}function G0(r,t){return eh(r,t)}function W0(r,t){return eh(r,t)}function j0(r,t){return nh(r,t,(e,n)=>tt(e,n))}function X0(r,t){return nh(r,t,(e,n)=>e.value===n.value&&e.expiry===n.expiry)}function eh(r,t){return r==null&&t==null?!0:r!=null&&t!=null?tt(r,t):!1}function rh(r,t,e){if(r.length!==t.length)return!1;for(let n=0;n<r.length;n++)if(!e(r[n],t[n]))return!1;return!0}function nh(r,t,e){if(r.size!==t.size)return!1;for(let[n,o]of r.entries()){let s=t.get(n);if(s==null||!e(o,s))return!1}return!0}var Ie="/",oh=new TextEncoder().encode(Ie),Ds=oh[0],gr=class r{_buf;constructor(t,e){if(typeof t=="string")this._buf=L(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Ds)throw new Error("Invalid key")}toString(t="utf8"){return B(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new r(t.join(Ie))}static random(){return new r(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new r(t):typeof t.uint8Array=="function"?new r(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=oh),this._buf[0]!==Ds){let t=new Uint8Array(this._buf.byteLength+1);t.fill(Ds,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ds;)this._buf=this._buf.subarray(0,-1)}less(t){let e=this.list(),n=t.list();for(let o=0;o<e.length;o++){if(n.length<o+1)return!1;let s=e[o],i=n[o];if(s<i)return!0;if(s>i)return!1}return e.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(Ie).slice(1)}type(){return Y0(this.baseNamespace())}name(){return Z0(this.baseNamespace())}instance(t){return new r(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(Ie)||(t+=Ie),t+=this.type(),new r(t)}parent(){let t=this.list();return t.length===1?new r(Ie):new r(t.slice(0,-1).join(Ie))}child(t){return this.toString()===Ie?t:t.toString()===Ie?this:new r(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return r.withNamespaces([...this.namespaces(),...Q0(t.map(e=>e.namespaces()))])}};function Y0(r){let t=r.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function Z0(r){let t=r.split(":");return t[t.length-1]}function Q0(r){return[].concat(...r)}var gl="/peers/";function ao(r){if(!Co(r)||r.type==null)throw new M("Invalid PeerId");let t=r.toCID().toString();return new gr(`${gl}${t}`)}async function sh(r,t,e,n){let o=new Map;for(let s of e){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=j(s.multiaddr)),!Ke(s.multiaddr))throw new M("Multiaddr was invalid");if(!await t(r,s.multiaddr))continue;let i=s.isCertified??!1,a=s.multiaddr.toString(),c=o.get(a);c!=null?s.isCertified=c.isCertified||i:o.set(a,{multiaddr:s.multiaddr,isCertified:i})}return[...o.values()].sort((s,i)=>s.multiaddr.toString().localeCompare(i.multiaddr.toString())).map(({isCertified:s,multiaddr:i})=>{let a=i.getPeerId();return r.equals(a)&&(i=i.decapsulate(j(`/p2p/${r}`))),{isCertified:s,multiaddr:i.bytes}})}async function Ms(r,t,e,n){if(t==null)throw new M("Invalid PeerData");if(t.publicKey!=null&&r.publicKey!=null&&!t.publicKey.equals(r.publicKey))throw new M("publicKey bytes do not match peer id publicKey bytes");let o=n.existingPeer?.peer;if(o!=null&&!r.equals(o.id))throw new M("peer id did not match existing peer id");let s=o?.addresses??[],i=new Set(o?.protocols??[]),a=o?.metadata??new Map,c=o?.tags??new Map,l=o?.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(s=[],t.multiaddrs!=null&&s.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&s.push(...t.addresses)),t.protocols!=null&&(i=new Set(t.protocols)),t.metadata!=null){let d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=ks(d,{validate:ih})}if(t.tags!=null){let d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);c=ks(d,{validate:ah,map:ch})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&s.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&s.push(...t.addresses),t.protocols!=null&&(i=new Set([...i,...t.protocols])),t.metadata!=null){let d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(let[g,p]of d)p==null?a.delete(g):a.set(g,p);a=ks([...a.entries()],{validate:ih})}if(t.tags!=null){let d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),g=new Map(c);for(let[p,m]of d)m==null?g.delete(p):g.set(p,m);c=ks([...g.entries()],{validate:ah,map:ch})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}let u;o?.id.publicKey!=null?u=Gt(o.id.publicKey):t.publicKey!=null?u=Gt(t.publicKey):r.publicKey!=null&&(u=Gt(r.publicKey));let f={addresses:await sh(r,n.addressFilter??(async()=>!0),s,n.existingPeer?.peerPB.addresses),protocols:[...i.values()].sort((d,g)=>d.localeCompare(g)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return f.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(g=>tt(g.multiaddr,g.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function ks(r,t){let e=new Map;for(let[n,o]of r)o!=null&&t.validate(n,o);for(let[n,o]of r.sort(([s],[i])=>s.localeCompare(i)))o!=null&&e.set(n,t.map?.(n,o)??o);return e}function ih(r,t){if(typeof r!="string")throw new M("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new M("Metadata value must be a Uint8Array")}function ah(r,t){if(typeof r!="string")throw new M("Tag name must be a string");if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new M("Tag value must be an integer");if(t.value<0||t.value>100)throw new M("Tag value must be between 0-100")}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new M("Tag ttl must be an integer");if(t.ttl<0)throw new M("Tag ttl must be between greater than 0")}}function ch(r,t){let e;return t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:e}}function lh(r){let t=r.toString().split("/")[2],e=it.parse(t,qt);return Xn(e)}function yl(r,t,e){let n=lh(r);return Ts(n,t,e)}function J0(r,t){return{prefix:gl,filters:(r.filters??[]).map(e=>({key:n,value:o})=>e(yl(n,o,t))),orders:(r.orders??[]).map(e=>(n,o)=>e(yl(n.key,n.value,t),yl(o.key,o.value,t)))}}var Rs=class{peerId;datastore;lock;addressFilter;log;maxAddressAge;maxPeerAge;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-store"),this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.lock=ml({name:"peer-store",singleProcess:!0}),this.maxAddressAge=e.maxAddressAge??36e5,this.maxPeerAge=e.maxPeerAge??216e5}async has(t){try{return await this.load(t),!0}catch(e){if(e.name!=="NotFoundError")throw e}return!1}async delete(t){this.peerId.equals(t)||await this.datastore.delete(ao(t))}async load(t){let e=ao(t),n=await this.datastore.get(e),o=_e.decode(n);if(this.#r(t,o))throw await this.datastore.delete(e),new Ge;return Ls(t,o,this.peerId.equals(t)?1/0:this.maxAddressAge)}async save(t,e){let n=await this.#t(t),o=await Ms(t,e,"patch",{addressFilter:this.addressFilter});return this.#e(t,o,n)}async patch(t,e){let n=await this.#t(t),o=await Ms(t,e,"patch",{addressFilter:this.addressFilter,existingPeer:n});return this.#e(t,o,n)}async merge(t,e){let n=await this.#t(t),o=await Ms(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:n});return this.#e(t,o,n)}async*all(t){for await(let{key:e,value:n}of this.datastore.query(J0(t??{},this.maxAddressAge))){let o=lh(e);if(o.equals(this.peerId))continue;let s=_e.decode(n);if(this.#r(o,s)){await this.datastore.delete(e);continue}yield Ls(o,s,this.peerId.equals(o)?1/0:this.maxAddressAge)}}async#t(t){try{let e=ao(t),n=await this.datastore.get(e),o=_e.decode(n);if(this.#r(t,o))throw await this.datastore.delete(e),new Ge;return{peerPB:o,peer:Ts(t,n,this.maxAddressAge)}}catch(e){e.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",e)}}async#e(t,e,n){e.updated=Date.now();let o=_e.encode(e);return await this.datastore.put(ao(t),o),{peer:Ts(t,o,this.maxAddressAge),previous:n?.peer,updated:n==null||!th(e,n.peerPB)}}#r(t,e){if(e.updated==null)return!0;if(this.peerId.equals(t))return!1;let n=e.updated<Date.now()-this.maxPeerAge,o=Date.now()-this.maxAddressAge,s=e.addresses.filter(i=>i.observed!=null&&i.observed>o);return n&&s.length===0}};var wl=class{store;events;peerId;log;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new Rs(t,e)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(t,e){this.log.trace("forEach await read lock");let n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(let o of this.store.all(e))t(o)}finally{this.log.trace("forEach release read lock"),n()}}async all(t){this.log.trace("all await read lock");let e=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await io(this.store.all(t))}finally{this.log.trace("all release read lock"),e()}}async delete(t){this.log.trace("delete await write lock");let e=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(t)}finally{this.log.trace("delete release write lock"),e()}}async has(t){this.log.trace("has await read lock");let e=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(t)}finally{this.log.trace("has release read lock"),e()}}async get(t){this.log.trace("get await read lock");let e=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(t)}finally{this.log.trace("get release read lock"),e()}}async getInfo(t){let e=await this.get(t);return{id:e.id,multiaddrs:e.addresses.map(({multiaddr:n})=>n)}}async save(t,e){this.log.trace("save await write lock");let n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{let o=await this.store.save(t,e);return this.#t(t,o),o.peer}finally{this.log.trace("save release write lock"),n()}}async patch(t,e){this.log.trace("patch await write lock");let n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{let o=await this.store.patch(t,e);return this.#t(t,o),o.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(t,e){this.log.trace("merge await write lock");let n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{let o=await this.store.merge(t,e);return this.#t(t,o),o.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(t,e){let n=await nn.openAndCertify(t,pr.DOMAIN),o=Xn(n.publicKey.toCID());if(e?.equals(o)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",e,o),!1;let s=pr.createFromProtobuf(n.payload),i;try{i=await this.get(o)}catch(a){if(a.name!=="NotFoundError")throw a}if(i?.peerRecordEnvelope!=null){let a=await nn.createFromProtobuf(i.peerRecordEnvelope),c=pr.createFromProtobuf(a.payload);if(c.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:t,addresses:s.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}#t(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))}};function uh(r,t={}){return new wl(r,t)}var Ns=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(t="Not Found"){super(t)}};function ty(r){return r[Symbol.asyncIterator]!=null}function ey(r){if(ty(r))return(async()=>{for await(let t of r);})();for(let t of r);}var bl=ey;function ry(r){let[t,e]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[e](){return this}}}var fh=ry;function ny(r){return r[Symbol.asyncIterator]!=null}function oy(r,t){let e=0;if(ny(r))return async function*(){for await(let c of r)await t(c,e++)&&(yield c)}();let n=fh(r),{value:o,done:s}=n.next();if(s===!0)return function*(){}();let i=t(o,e++);if(typeof i.then=="function")return async function*(){await i&&(yield o);for await(let c of n)await t(c,e++)&&(yield c)}();let a=t;return function*(){i===!0&&(yield o);for(let c of n)a(c,e++)&&(yield c)}()}var yr=oy;function sy(r){return r[Symbol.asyncIterator]!=null}function iy(r,t){return sy(r)?async function*(){yield*(await io(r)).sort(t)}():function*(){yield*io(r).sort(t)}()}var xl=iy;function ay(r){return r[Symbol.asyncIterator]!=null}function cy(r,t){return ay(r)?async function*(){let e=0;if(!(t<1)){for await(let n of r)if(yield n,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(let n of r)if(yield n,e++,e===t)return}}()}var El=cy;var Os=class{put(t,e,n){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(let{key:n,value:o}of t)await this.put(n,o,e),yield n}async*getMany(t,e={}){for await(let n of t)yield{key:n,value:await this.get(n,e)}}async*deleteMany(t,e={}){for await(let n of t)await this.delete(n,e),yield n}batch(){let t=[],e=[];return{put(n,o){t.push({key:n,value:o})},delete(n){e.push(n)},commit:async n=>{await bl(this.putMany(t,n)),t=[],await bl(this.deleteMany(e,n)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let n=this._all(t,e);if(t.prefix!=null){let o=t.prefix;n=yr(n,s=>s.key.toString().startsWith(o))}if(Array.isArray(t.filters)&&(n=t.filters.reduce((o,s)=>yr(o,s),n)),Array.isArray(t.orders)&&(n=t.orders.reduce((o,s)=>xl(o,s),n)),t.offset!=null){let o=0,s=t.offset;n=yr(n,()=>o++>=s)}return t.limit!=null&&(n=El(n,t.limit)),n}queryKeys(t,e){let n=this._allKeys(t,e);if(t.prefix!=null){let o=t.prefix;n=yr(n,s=>s.toString().startsWith(o))}if(Array.isArray(t.filters)&&(n=t.filters.reduce((o,s)=>yr(o,s),n)),Array.isArray(t.orders)&&(n=t.orders.reduce((o,s)=>xl(o,s),n)),t.offset!=null){let o=t.offset,s=0;n=yr(n,()=>s++>=o)}return t.limit!=null&&(n=El(n,t.limit)),n}};var Bs=class extends Os{data;constructor(){super(),this.data=new Map}put(t,e){return this.data.set(t.toString(),e),t}get(t){let e=this.data.get(t.toString());if(e==null)throw new Ns;return e}has(t){return this.data.has(t.toString())}delete(t){this.data.delete(t.toString())}*_all(){for(let[t,e]of this.data.entries())yield{key:new gr(t),value:e}}*_allKeys(){for(let t of this.data.keys())yield new gr(t)}};function co(r,t){let e,n=function(){let o=function(){e=void 0,r()};clearTimeout(e),e=setTimeout(o,t)};return n.start=()=>{},n.stop=()=>{clearTimeout(e)},n}var hh=_o(dh(),1),ly=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],uy=ly.map(r=>new hh.Netmask(r));function vl(r){for(let t of uy)if(t.contains(r))return!0;return!1}function fy(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function dy(r){let t=r.split(":");if(t.length<2)return!1;let e=t[t.length-1].padStart(4,"0"),n=t[t.length-2].padStart(4,"0"),o=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(e.substring(0,2),16)}.${parseInt(e.substring(2),16)}`;return vl(o)}function hy(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function py(r){let t=r.split(":"),e=t[t.length-1];return vl(e)}function my(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Ve(r){return ne(r)?vl(r):fy(r)?dy(r):hy(r)?py(r):tn(r)?my(r):void 0}var gy=r=>r.toString().split("/").slice(1),sn=r=>({match:t=>t.length<1?!1:r(t[0])?t.slice(1):!1,pattern:"fn"}),z=r=>({match:t=>sn(e=>e===r).match(t),pattern:r}),wr=()=>({match:r=>sn(t=>typeof t=="string").match(r),pattern:"{string}"}),an=()=>({match:r=>sn(t=>!isNaN(parseInt(t))).match(r),pattern:"{number}"}),et=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{G.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),uo=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{ha.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),Z=r=>({match:t=>{let e=r.match(t);return e===!1?t:e},pattern:`optional(${r.pattern})`}),Pt=(...r)=>({match:t=>{let e;for(let n of r){let o=n.match(t);o!==!1&&(e==null||o.length<e.length)&&(e=o)}return e??!1},pattern:`or(${r.map(t=>t.pattern).join(", ")})`}),H=(...r)=>({match:t=>{for(let e of r){let n=e.match(t);if(n===!1)return!1;t=n}return t},pattern:`and(${r.map(t=>t.pattern).join(", ")})`});function st(...r){function t(o){let s=gy(o);for(let i of r){let a=i.match(s);if(a===!1)return!1;s=a}return s}function e(o){return t(o)!==!1}function n(o){let s=t(o);return s===!1?!1:s.length===0}return{matchers:r,matches:e,exactMatch:n}}var yy=et(),ph=st(yy),Us=H(z("dns4"),wr()),Ks=H(z("dns6"),wr()),qs=H(z("dnsaddr"),wr()),Al=H(z("dns"),wr()),U6=st(Us,Z(et())),K6=st(Ks,Z(et())),q6=st(qs,Z(et())),z6=st(Pt(Al,qs,Us,Ks),Z(et())),mh=H(z("ip4"),sn(ne)),gh=H(z("ip6"),sn(tn)),_l=Pt(mh,gh),Ce=Pt(_l,Al,Us,Ks,qs),V6=st(Pt(_l,H(Pt(Al,qs,Us,Ks),Z(et())))),Il=st(mh),Cl=st(gh),H6=st(_l),Pl=H(Ce,z("tcp"),an()),fo=H(Ce,z("udp"),an()),ho=st(H(Pl,Z(et()))),$6=st(fo),Tl=H(fo,z("quic"),Z(et())),zs=H(fo,z("quic-v1"),Z(et())),wy=Pt(Tl,zs),G6=st(Tl),yh=st(zs),Sl=Pt(Ce,Pl,fo,Tl,zs),wh=Pt(H(Sl,z("ws"),Z(et()))),br=st(wh),bh=Pt(H(Sl,z("wss"),Z(et())),H(Sl,z("tls"),Z(H(z("sni"),wr())),z("ws"),Z(et()))),po=st(bh),xh=H(fo,z("webrtc-direct"),Z(uo()),Z(uo()),Z(et())),Ll=st(xh),Eh=H(zs,z("webtransport"),Z(uo()),Z(uo()),Z(et())),Dl=st(Eh),Fs=Pt(wh,bh,H(Pl,Z(et())),H(wy,Z(et())),H(Ce,Z(et())),xh,Eh,et()),W6=st(Fs),by=H(Fs,z("p2p-circuit"),et()),mo=st(by),xy=Pt(H(Fs,z("p2p-circuit"),z("webrtc"),Z(et())),H(Fs,z("webrtc"),Z(et())),H(z("webrtc"),Z(et()))),kl=st(xy),Ey=Pt(H(Ce,z("tcp"),an(),z("http"),Z(et())),H(Ce,z("http"),Z(et()))),j6=st(Ey),vy=Pt(H(Ce,z("tcp"),Pt(H(z("443"),z("http")),H(an(),z("https")),H(an(),z("tls"),z("http"))),Z(et())),H(Ce,z("tls"),z("http"),Z(et())),H(Ce,z("https"),Z(et()))),X6=st(vy),Sy=Pt(H(z("memory"),wr(),Z(et()))),Y6=st(Sy);var vh=864e13;var Ay=448,Ml=449,_y=53,Iy=54,Cy=55,Py=56,Vs=class{log;mappings;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(t){let e=this.findHost(t);for(let n of this.mappings.values())if(n.domain===e)return!0;return!1}add(t,e){e.forEach(n=>{this.log("add DNS mapping %s to %s",n,t);let o=Ve(n)===!0;this.mappings.set(n,{domain:t,verified:o,expires:o?vh-Date.now():0,lastVerified:o?vh-Date.now():void 0})})}remove(t){let e=this.findHost(t),n=!1;for(let[o,s]of this.mappings.entries())s.domain===e&&(this.log("removing %s to %s DNS mapping %e",o,s.domain,new Error("where")),this.mappings.delete(o),n=n||s.verified);return n}getAll(t){let e=[];for(let n=0;n<t.length;n++){let s=t[n].multiaddr.stringTuples(),i=s[0][1];if(i!=null)for(let[a,c]of this.mappings.entries()){if(i!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(t.splice(n,1),n--,e.push({multiaddr:j(`/${s.map(u=>[W(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return e}maybeAddSNITuple(t,e){for(let n=0;n<t.length;n++)if(t[n][0]===Ay&&t[n+1]?.[0]!==Ml)return t.splice(n+1,0,[Ml,e]),!0;return!1}confirm(t,e){let n=this.findHost(t),o=!1;for(let[s,i]of this.mappings.entries())i.domain===n&&(this.log("marking %s to %s DNS mapping as verified",s,i.domain),o=i.verified,i.verified=!0,i.expires=Date.now()+e,i.lastVerified=Date.now());return o}unconfirm(t,e){let n=this.findHost(t),o=!1;for(let[s,i]of this.mappings.entries())i.domain===n&&(this.log("removing verification of %s to %s DNS mapping",s,i.domain),o=o||i.verified,i.verified=!1,i.expires=Date.now()+e);return o}findHost(t){for(let e of t.stringTuples())if(e[0]===Ml||e[0]===_y||e[0]===Iy||e[0]===Cy||e[0]===Py)return e[1]}};var Rl=4,Nl=41,Ol=6,Ty=273,Hs=class{log;mappings;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(t){let e=t.stringTuples();for(let n of this.mappings.values())for(let o of n)if(o.externalIp===e[0][1])return!0;return!1}add(t,e,n,o=e,s="tcp"){let i=`${t}-${e}-${s}`,a=this.mappings.get(i)??[],c={internalIp:t,internalPort:e,externalIp:n,externalPort:o,externalFamily:ne(n)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(i,a)}remove(t){let e=t.stringTuples(),n=e[0][1]??"",o=e[1][0]===Ol?"tcp":"udp",s=parseInt(e[1][1]??"0"),i=!1;for(let[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===n&&u.externalPort===s&&u.protocol===o&&(this.log("removing %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,n,s,o),i=i||u.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return i}getAll(t){let e=[];for(let{multiaddr:n}of t){let o=n.stringTuples(),s;if((o[0][0]===Rl||o[0][0]===Nl)&&o[1][0]===Ol?s=`${o[0][1]}-${o[1][1]}-tcp`:(o[0][0]===Rl||o[0][0]===Nl)&&o[1][0]===Ty&&(s=`${o[0][1]}-${o[1][1]}-udp`),s==null)continue;let i=this.mappings.get(s);if(i!=null)for(let a of i)o[0][0]=a.externalFamily===4?Rl:Nl,o[0][1]=a.externalIp,o[1][1]=`${a.externalPort}`,e.push({multiaddr:j(`/${o.map(c=>[W(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return e}confirm(t,e){let o=t.stringTuples()[0][1],s=!1;for(let i of this.mappings.values())for(let a of i)a.externalIp===o&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+e,a.lastVerified=Date.now());return s}unconfirm(t,e){let n=t.stringTuples(),o=n[0][1]??"",s=n[1][0]===Ol?"tcp":"udp",i=parseInt(n[1][1]??"0"),a=!1;for(let c of this.mappings.values())for(let l=0;l<c.length;l++){let u=c[l];u.externalIp===o&&u.externalPort===i&&u.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",u.externalIp,u.externalPort,o,i,s),a=a||u.verified,u.verified=!1,u.expires=Date.now()+e)}return a}};function Sh(r){try{let[[t,e]]=r.stringTuples();if(e==null)return!1;if(t===4)return e.startsWith("169.254.");if(t===41)return e.toLowerCase().startsWith("fe80")}catch{}return!1}function $s(r){try{let[[t]]=r.stringTuples();return t===4||t===41}catch{}return!1}function xr(r){try{if(!$s(r))return!1;let[[,t]]=r.stringTuples();return t==null?!1:Ve(t)??!1}catch{}return!0}var Ly={maxObservedAddresses:10},Gs=class{log;addresses;maxObservedAddresses;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??Ly.maxObservedAddresses}has(t){return this.addresses.has(t.toString())}removePrefixed(t){for(let e of this.addresses.keys())e.toString().startsWith(t)&&this.addresses.delete(e)}add(t){this.addresses.size!==this.maxObservedAddresses&&(xr(t)||Sh(t)||(this.log("adding observed address %a",t),this.addresses.set(t.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([t,e])=>({multiaddr:j(t),verified:e.verified,type:"observed",expires:e.expires,lastVerified:e.lastVerified}))}remove(t){let e=this.addresses.get(t.toString())?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(t.toString()),e}confirm(t,e){let n=t.toString(),o=this.addresses.get(n)??{verified:!1,expires:Date.now()+e,lastVerified:Date.now()},s=o.verified;return o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,o),s}};var Dy=[4,41,53,54,55,56];function Bl(r){try{let[[t]]=r.stringTuples();return Dy.includes(t)}catch{}return!1}var ky={maxObservedAddresses:10},Ws=class{log;addresses;maxObservedAddresses;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=e.maxObservedAddresses??ky.maxObservedAddresses}get(t,e){if(xr(t))return{multiaddr:t,verified:!0,type:"transport",expires:Date.now()+e,lastVerified:Date.now()};let n=this.toKey(t),o=this.addresses.get(n);return o==null&&(o={verified:!Bl(t),expires:0},this.addresses.set(n,o)),{multiaddr:t,verified:o.verified,type:"transport",expires:o.expires,lastVerified:o.lastVerified}}has(t){let e=this.toKey(t);return this.addresses.has(e)}remove(t){let e=this.toKey(t),n=this.addresses.get(e)?.verified??!1;return this.log("removing observed address %a",t),this.addresses.delete(e),n}confirm(t,e){let n=this.toKey(t),o=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},s=o.verified;return o.verified=!0,o.expires=Date.now()+e,o.lastVerified=Date.now(),this.addresses.set(n,o),s}unconfirm(t,e){let n=this.toKey(t),o=this.addresses.get(n)??{verified:!1,expires:0},s=o.verified;return o.verified=!1,o.expires=Date.now()+e,this.addresses.set(n,o),s}toKey(t){if(Bl(t)){let e=t.toOptions();return`${e.host}-${e.port}-${e.transport}`}return t.toString()}};var Ah=6e4,_h={maxObservedAddresses:10,addressVerificationTTL:Ah*10,addressVerificationRetry:Ah*5},My=r=>r;function Fl(r,t){let e=r.getPeerId();return e!=null&&fe(e).equals(t)&&(r=r.decapsulate(j(`/p2p/${t.toString()}`))),r}var js=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(t,e={}){let{listen:n=[],announce:o=[],appendAnnounce:s=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=n.map(i=>i.toString()),this.announce=new Set(o.map(i=>i.toString())),this.appendAnnounce=new Set(s.map(i=>i.toString())),this.observed=new Gs(t,e),this.dnsMappings=new Vs(t,e),this.ipMappings=new Hs(t,e),this.transportAddresses=new Ws(t,e),this.announceFilter=e.announceFilter??My,this.observedAddressFilter=no(1024),this.addressVerificationTTL=e.addressVerificationTTL??_h.addressVerificationTTL,this.addressVerificationRetry=e.addressVerificationRetry??_h.addressVerificationRetry,this._updatePeerStoreAddresses=co(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let t=this.getAddresses().map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>j(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>j(t))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(t=>j(t))}getObservedAddrs(){return this.observed.getAll().map(t=>t.multiaddr)}addObservedAddr(t){let e=t.stringTuples(),n=`${e[0][1]}:${e[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),t=Fl(t,this.components.peerId),!this.ipMappings.has(t)&&(this.dnsMappings.has(t)||this.observed.add(t)))}confirmObservedAddr(t,e){t=Fl(t,this.components.peerId);let n=!0;(e?.type==="transport"||this.transportAddresses.has(t))&&!this.transportAddresses.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="dns-mapping"||this.dnsMappings.has(t))&&!this.dnsMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="ip-mapping"||this.ipMappings.has(t))&&!this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(e?.type==="observed"||this.observed.has(t))&&(this.maybeUpgradeToIPMapping(t)?(this.ipMappings.confirm(t,e?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(t,e?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(t,e){t=Fl(t,this.components.peerId);let n=!1;this.observed.has(t)&&!this.observed.remove(t)&&n&&(n=!1),this.transportAddresses.has(t)&&!this.transportAddresses.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(t)&&!this.dnsMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(t)&&!this.ipMappings.unconfirm(t,e?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let t=new Set,e=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let o=n.multiaddr.toString();return t.has(o)?!1:(t.add(o),!0)}).map(n=>n.multiaddr);return this.announceFilter(e.map(n=>{let o=j(n);return o.protos().pop()?.path===!0||o.getPeerId()===this.components.peerId.toString()?o:o.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let t=this.getAnnounceAddrs();if(t.length>0)return this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(t)}),t.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let e=[];e=e.concat(this.components.transportManager.getAddrs().map(o=>this.transportAddresses.get(o,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(n)}),e=e.concat(n.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),e=e.concat(this.observed.getAll()),e=e.concat(this.ipMappings.getAll(e)),e=e.concat(this.dnsMappings.getAll(e)),e}addDNSMapping(t,e){this.dnsMappings.add(t,e)}removeDNSMapping(t){this.dnsMappings.remove(j(`/dns/${t}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(t,e,n,o=e,s="tcp"){this.ipMappings.add(t,e,n,o,s),this.observed.removePrefixed(`/ip${ne(n)?4:6}/${n}/${s}/${o}`)}removePublicAddressMapping(t,e,n,o=e,s="tcp"){this.ipMappings.remove(j(`/ip${ne(n)?4:6}/${n}/${s}/${o}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(t){if(this.ipMappings.has(t))return!1;let e=t.toOptions();if(e.family===6||e.host==="127.0.0.1"||Ve(e.host)===!0)return!1;let n=this.components.transportManager.getListeners(),o=[s=>br.exactMatch(s)||po.exactMatch(s),s=>ho.exactMatch(s),s=>yh.exactMatch(s)];for(let s of o){if(!s(t))continue;let i=n.filter(l=>l.getAddrs().filter(u=>u.toOptions().family===4&&s(u)).length>0);if(i.length!==1)continue;let a=i[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;let c=a.toOptions();return this.observed.remove(t),this.ipMappings.add(c.host,c.port,e.host,e.port,e.transport),!0}return!1}};var Ih;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(Ih||(Ih={}));var Xs=class extends Error{constructor(t="Missing service"){super(t),this.name="MissingServiceError"}},Ys=class extends Error{constructor(t="Unmet service dependencies"){super(t),this.name="UnmetServiceDependenciesError"}},cn=class extends Error{constructor(t="No content routers available"){super(t),this.name="NoContentRoutersError"}},go=class extends Error{constructor(t="No peer routers available"){super(t),this.name="NoPeerRoutersError"}},Zs=class extends Error{constructor(t="Should not try to find self"){super(t),this.name="QueriedForSelfError"}},Qs=class extends Error{constructor(t="Unhandled protocol error"){super(t),this.name="UnhandledProtocolError"}},Js=class extends Error{constructor(t="Duplicate protocol handler error"){super(t),this.name="DuplicateProtocolHandlerError"}},yo=class extends Error{constructor(t="Dial denied error"){super(t),this.name="DialDeniedError"}},ti=class extends Error{constructor(t="No transport was configured to listen on this address"){super(t),this.name="UnsupportedListenAddressError"}},ei=class extends Error{constructor(t="Configured listen addresses could not be listened on"){super(t),this.name="UnsupportedListenAddressesError"}},ri=class extends Error{constructor(t="No valid addresses"){super(t),this.name="NoValidAddressesError"}},ni=class extends Error{constructor(t="Connection intercepted"){super(t),this.name="ConnectionInterceptedError"}},oi=class extends Error{constructor(t="Connection denied"){super(t),this.name="ConnectionDeniedError"}},Er=class extends Error{constructor(t="Stream is not multiplexed"){super(t),this.name="MuxerUnavailableError"}},vr=class extends Error{constructor(t="Encryption failed"){super(t),this.name="EncryptionFailedError"}},si=class extends Error{constructor(t="Transport unavailable"){super(t),this.name="TransportUnavailableError"}};var Ul=class{components={};_started=!1;constructor(t={}){this.components={};for(let[e,n]of Object.entries(t))this.components[e]=n;this.components.logger==null&&(this.components.logger=Ss())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>No(e)).map(async e=>{await e[t]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},Ny=["metrics","connectionProtector","dns"],Oy=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Ch(r={}){let t=new Ul(r);return new Proxy(t,{get(n,o,s){if(typeof o=="string"&&!Oy.includes(o)){let i=t.components[o];if(i==null&&!Ny.includes(o))throw new Xs(`${o} not set`);return i}return Reflect.get(n,o,s)},set(n,o,s){return typeof o=="string"?t.components[o]=s:Reflect.set(n,o,s),!0}})}function Ph(r){let t={};for(let e of Object.values(r.components))for(let n of By(e))t[n]=!0;for(let e of Object.values(r.components))for(let n of Fy(e))if(t[n]!==!0)throw new Ys(`Service "${Uy(e)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function By(r){return Array.isArray(r?.[wn])?r[wn]:[]}function Fy(r){return Array.isArray(r?.[Zi])?r[Zi]:[]}function Uy(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}var Ky=4,qy=41;function Th(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{if(br.matches(t))return!1;let e=t.stringTuples();return e[0][0]===Ky||e[0][0]===qy?!!Ve(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var Lh=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},zy=new WeakMap;function Vy({clearTimeout:r,setTimeout:t}={}){return(e,{value:n,signal:o}={})=>{if(o?.aborted)return Promise.reject(Lh());let s,i,a,c=r??clearTimeout,l=()=>{c(s),a(Lh())},u=()=>{o&&o.removeEventListener("abort",l)},f=new Promise((d,g)=>{i=()=>{u(),d(n)},a=g,s=(t??setTimeout)(i,e)});return o&&o.addEventListener("abort",l,{once:!0}),zy.set(f,()=>{c(s),s=null,i()}),f}}var Hy=Vy(),Dh=Hy;var ii=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(t="Rate limit exceeded",e){super(t),this.name="RateLimitError",this.remainingPoints=e.remainingPoints,this.msBeforeNext=e.msBeforeNext,this.consumedPoints=e.consumedPoints,this.isFirstInDuration=e.isFirstInDuration}},ai=class extends Error{static name="QueueFullError";constructor(t="The queue was full"){super(t),this.name="QueueFullError"}};var ci=class{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(t={}){this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new Kl}async consume(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,e,s);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+e&&(i=this.memoryStorage.set(o,i.consumedPoints,this.blockDuration)),new ii("Rate limit exceeded",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let a=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=i.consumedPoints*this.execEvenlyMinDelayMs),await Dh(a)}return i}penalty(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,e,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(t,e=1,n={}){let o=this.getKey(t),s=this._getKeySecDuration(n),i=this.memoryStorage.incrby(o,-e,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(t,e){let n=e*1e3,o=this.points+1;return this.memoryStorage.set(this.getKey(t),o,e),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:o,isFirstInDuration:!1}}set(t,e,n=0){let o=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,n),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:e,isFirstInDuration:!1}}get(t){let e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return t?.customDuration!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}},Kl=class{storage;constructor(){this.storage=new Map}incrby(t,e,n){let o=this.storage.get(t);if(o!=null){let s=o.expiresAt!=null?o.expiresAt.getTime()-new Date().getTime():-1;return o.expiresAt==null||s>0?(o.value+=e,{remainingPoints:0,msBeforeNext:s,consumedPoints:o.value,isFirstInDuration:!1}):this.set(t,e,n)}return this.set(t,e,n)}set(t,e,n){let o=n*1e3,s=this.storage.get(t);s!=null&&clearTimeout(s.timeoutId);let i={value:e,expiresAt:o>0?new Date(Date.now()+o):void 0};return this.storage.set(t,i),o>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(t)},o),i.timeoutId.unref!=null&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:i.value,isFirstInDuration:!0}}get(t){let e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){let e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}};function li(r){if(Co(r))return{peerId:r,multiaddrs:[]};let t=Array.isArray(r)?r:[r],e;if(t.length>0){let n=t[0].getPeerId();e=n==null?void 0:fe(n),t.forEach(o=>{if(!Ke(o))throw new Te("Invalid multiaddr");let s=o.getPeerId();if(s==null){if(e!=null)throw new M("Multiaddrs must all have the same peer id or have no peer id")}else{let i=fe(s);if(e?.equals(i)!==!0)throw new M("Multiaddrs must all have the same peer id or have no peer id")}})}return t=t.filter(n=>!ph.exactMatch(n)),{peerId:e,multiaddrs:t}}var $y=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function kh(r,t){let e=r?.streams?.map(o=>o.protocol)??[],n=t?.closableProtocols??$y;if(!(e.filter(o=>o!=null&&!n.includes(o)).length>0))try{await r?.close(t)}catch(o){r?.abort(o)}}var Mh="last-dial-failure",Rh="last-dial-success";var ui=100,fi=50;async function Nh(r,t){let e=!1;for(let o of rn.keys())if(e=r.protoNames().includes(o),e)break;if(!e)return[r];let n=await r.resolve(t);return t.log("resolved %s to",r,n.map(o=>o.toString())),n}function wo(r){try{let t;if(typeof r=="string"?t=j(r):t=r,!t.protoNames().includes("ipcidr")){let n=t.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(n)}return Yc(t)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}var Gy={maxConnections:ui,allow:[]},di=class{maxConnections;connectionManager;peerStore;allow;events;log;constructor(t,e={}){this.maxConnections=e.maxConnections??Gy.maxConnections,this.allow=(e.allow??[]).map(n=>wo(n)),this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(t=>{this.log.error("error while pruning connections %e",t)})}async _maybePruneConnections(){let t=this.connectionManager.getConnections(),e=t.length;if(this.log("checking max connections limit %d/%d",e,this.maxConnections),e<=this.maxConnections)return;let n=new Ae;for(let a of t){let c=a.remotePeer;if(!n.has(c)){n.set(c,0);try{let l=await this.peerStore.get(c);n.set(c,[...l.tags.values()].reduce((u,f)=>u+f.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}let o=this.sortConnections(t,n),s=Math.max(e-this.maxConnections,0),i=[];for(let a of o)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>l.contains(a.remoteAddr.nodeAddress().address))||i.push(a),i.length===s)break;await Promise.all(i.map(async a=>{await kh(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:i})}sortConnections(t,e){return t.sort((n,o)=>{let s=n.timeline.open,i=o.timeline.open;return s<i?1:s>i?-1:0}).sort((n,o)=>n.direction==="outbound"&&o.direction==="inbound"?1:n.direction==="inbound"&&o.direction==="outbound"?-1:0).sort((n,o)=>n.streams.length>o.streams.length?1:n.streams.length<o.streams.length?-1:0).sort((n,o)=>{let s=e.get(n.remotePeer)??0,i=e.get(o.remotePeer)??0;return s>i?1:s<i?-1:0})}};function lt(){let r={};return r.promise=new Promise((t,e)=>{r.resolve=t,r.reject=e}),r}var hi=class{buffer;mask;top;btm;next;constructor(t){if(!(t>0)||(t-1&t)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){let t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}},ln=class{size;hwm;head;tail;constructor(t={}){this.hwm=t.splitLimit??16,this.head=new hi(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return t?.byteLength!=null?t.byteLength:1}push(t){if(t?.value!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){let e=this.head;this.head=e.next=new hi(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){let e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return t?.value!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}};var ql=class extends Error{type;code;constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}};function Oh(r={}){return Wy(e=>{let n=e.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Wy(r,t){t=t??{};let e=t.onEnd,n=new ln,o,s,i,a=lt(),c=async()=>{try{return n.isEmpty()?i?{done:!0}:await new Promise((w,v)=>{s=C=>{s=null,n.push(C);try{w(r(n))}catch(x){v(x)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=lt()})}},l=w=>s!=null?s(w):(n.push(w),o),u=w=>(n=new ln,s!=null?s({error:w}):(n.push({error:w}),o)),f=w=>{if(i)return o;if(t?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},d=w=>i?o:(i=!0,w!=null?u(w):l({done:!0})),g=()=>(n=new ln,d(),{done:!0}),p=w=>(d(w),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:g,throw:p,push:f,end:d,get readableLength(){return n.size},onEmpty:async w=>{let v=w?.signal;if(v?.throwIfAborted(),n.isEmpty())return;let C,x;v!=null&&(C=new Promise((h,b)=>{x=()=>{b(new ql)},v.addEventListener("abort",x)}));try{await Promise.race([a.promise,C])}finally{x!=null&&v!=null&&v?.removeEventListener("abort",x)}}},e==null)return o;let m=o;return o={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(w){return m.throw(w),e!=null&&(e(w),e=void 0),{done:!0}},return(){return m.return(),e!=null&&(e(),e=void 0),{done:!0}},push:f,end(w){return m.end(w),e!=null&&(e(w),e=void 0),o},get readableLength(){return m.readableLength},onEmpty:w=>m.onEmpty(w)},o}var zl=class extends Error{type;code;constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=e??"ABORT_ERR"}};async function un(r,t,e,n){let o=new zl(n?.errorMessage,n?.errorCode);return e?.aborted===!0?Promise.reject(o):new Promise((s,i)=>{function a(){e?.removeEventListener("abort",u),r.removeEventListener(t,c),n?.errorEvent!=null&&r.removeEventListener(n.errorEvent,l)}let c=f=>{try{if(n?.filter?.(f)===!1)return}catch(d){a(),i(d);return}a(),s(f)},l=f=>{a(),i(f.detail)},u=()=>{a(),i(o)};e?.addEventListener("abort",u),r.addEventListener(t,c),n?.errorEvent!=null&&r.addEventListener(n.errorEvent,l)})}var pi=class extends Error{type;code;constructor(t,e,n){super(t??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=e??"ABORT_ERR"}};async function se(r,t,e){if(t==null)return r;if(t.aborted)return r.catch(()=>{}),Promise.reject(new pi(e?.errorMessage,e?.errorCode,e?.errorName));let n,o=new pi(e?.errorMessage,e?.errorCode,e?.errorName);try{return await Promise.race([r,new Promise((s,i)=>{n=()=>{i(o)},t.addEventListener("abort",n)})])}finally{n!=null&&t.removeEventListener("abort",n)}}var mi=class{deferred;signal;constructor(t){this.signal=t,this.deferred=lt(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Xt)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function jy(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var gi=class{id;fn;options;recipients;status;timeline;controller;constructor(t,e){this.id=jy(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,n)=>e&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Xt),this.cleanup())}async join(t={}){let e=new mi(t.signal);return this.recipients.push(e),t.signal?.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let t=await se(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{t.cleanup(),t.signal?.removeEventListener("abort",this.onAbort)})}};var dn=class extends he{concurrency;maxSize;queue;pending;sort;constructor(t={}){super(),this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&t.metrics?.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=t.sort,this.queue=[],this.emitEmpty=co(this.emitEmpty.bind(this),1),this.emitIdle=co(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let t;for(let e of this.queue)if(e.status==="queued"){t=e;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let e=0;e<this.queue.length;e++)if(this.queue[e]===t){this.queue.splice(e,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,e){if(e?.signal?.throwIfAborted(),this.size===this.maxSize)throw new ai;let n=new gi(t,e);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(e).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Xt)}),this.clear()}async onEmpty(t){this.size!==0&&await un(this,"empty",t?.signal)}async onSizeLessThan(t,e){this.size<t||await un(this,"next",e?.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await un(this,"idle",t?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){t?.signal?.throwIfAborted();let e=Oh({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),e.end(c)},o=c=>{c.detail!=null&&e.push(c.detail)},s=c=>{n(c.detail)},i=()=>{n()},a=()=>{n(new Xt("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("error",s),this.addEventListener("idle",i),t?.signal?.addEventListener("abort",a);try{yield*e}finally{this.removeEventListener("completed",o),this.removeEventListener("error",s),this.removeEventListener("idle",i),t?.signal?.removeEventListener("abort",a),n()}}};var yi=class extends dn{constructor(t={}){super({...t,sort:(e,n)=>e.options.priority>n.options.priority?-1:e.options.priority<n.options.priority?1:0})}};function Pe(r){let t=new globalThis.AbortController;function e(){t.abort();for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",e)}for(let s of r){if(s?.aborted===!0){e();break}s?.addEventListener!=null&&s.addEventListener("abort",e)}function n(){for(let s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",e)}let o=t.signal;return o.clear=n,o}function Bh(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Vl(r){if(!$s(r))return!1;let{address:t}=r.nodeAddress();return Bh(t)}function Xy(r,t){let e=ho.exactMatch(r.multiaddr),n=ho.exactMatch(t.multiaddr);if(e&&!n)return-1;if(!e&&n)return 1;let o=po.exactMatch(r.multiaddr),s=po.exactMatch(t.multiaddr);if(o&&!s)return-1;if(!o&&s)return 1;let i=br.exactMatch(r.multiaddr),a=br.exactMatch(t.multiaddr);if(i&&!a)return-1;if(!i&&a)return 1;let c=kl.exactMatch(r.multiaddr),l=kl.exactMatch(t.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let u=Ll.exactMatch(r.multiaddr),f=Ll.exactMatch(t.multiaddr);if(u&&!f)return-1;if(!u&&f)return 1;let d=Dl.exactMatch(r.multiaddr),g=Dl.exactMatch(t.multiaddr);return d&&!g?-1:!d&&g?1:0}function Yy(r,t){let e=Vl(r.multiaddr),n=Vl(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function Zy(r,t){let e=xr(r.multiaddr),n=xr(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function Qy(r,t){return r.isCertified&&!t.isCertified?-1:!r.isCertified&&t.isCertified?1:0}function Jy(r,t){let e=mo.exactMatch(r.multiaddr),n=mo.exactMatch(t.multiaddr);return e&&!n?1:!e&&n?-1:0}function Fh(r){return r.sort(Xy).sort(Qy).sort(Jy).sort(Zy).sort(Yy)}var wi={maxParallelDials:fi,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:lr}},bi=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(t,e={}){this.addressSorter=e.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??wi.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??wi.maxDialQueueLength,this.dialTimeout=e.dialTimeout??wi.dialTimeout,this.connections=e.connections??new Ae,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.shutDownController=new AbortController,this.shutDownController.signal;for(let[n,o]of Object.entries(e.resolvers??{}))rn.set(n,o);this.queue=new yi({concurrency:e.maxParallelDials??wi.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==Xt.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){let{peerId:n,multiaddrs:o}=li(t),s=Array.from(this.connections.values()).flat().find(a=>e.force===!0?!1:a.remotePeer.equals(n)?!0:o.find(c=>c.equals(a.remoteAddr)));if(s?.status==="open")return this.log("already connected to %a",s.remoteAddr),e.onProgress?.(new dt("dial-queue:already-connected")),s;let i=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;let c=a.options.multiaddrs;if(c==null)return!1;for(let l of o)if(c.has(l.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(let a of o)i.options.multiaddrs.add(a.toString());return e.onProgress?.(new dt("dial-queue:already-in-dial-queue")),i.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new Lr("Dial queue is full");return this.log("creating dial target for %p",n,o.map(a=>a.toString())),e.onProgress?.(new dt("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new dt("dial-queue:start-dial"));let c=Pe([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:e.priority??Wl,multiaddrs:new Set(o.map(a=>a.toString())),signal:e.signal??AbortSignal.timeout(this.dialTimeout),onProgress:e.onProgress})}async dialPeer(t,e){let n=t.peerId,o=t.multiaddrs,s=new Set,i=t.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);i||o.size>0;){c++,i=!1;let u=[],f=new Set(t.multiaddrs);o.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);let d=await this.calculateMultiaddrs(n,f,{...t,signal:e});for(let g of d){if(s.has(g.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",g.multiaddr,n);continue}u.push(g)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(g=>g.multiaddr.toString())),t?.onProgress?.(new dt("dial-queue:calculated-addresses",u));for(let g of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,t.peerId),new Lr("Peer had more than maxPeerAddrsToDial");a++;try{let p=await this.components.transportManager.dial(g.multiaddr,{...t,signal:e});this.log("dial to %a succeeded",g.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[Rh]:L(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p",n,m)}return p}catch(p){if(this.log.error("dial failed to %a",g.multiaddr,p),s.add(g.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[Mh]:L(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p",n,m)}if(e.aborted)throw new ko(p.message);l.push(p)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(t,e=new Set,n={}){let o=[...e].map(f=>({multiaddr:j(f),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new Lr("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(t)===!0)throw new yo("The dial request is blocked by gater.allowDialPeer");if(o.length===0){this.log("loading multiaddrs for %p",t);try{let f=await this.components.peerStore.get(t);o.push(...f.addresses),this.log("loaded multiaddrs for %p",t,o.map(({multiaddr:d})=>d.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(o.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{let f=await this.components.peerRouting.findPeer(t,n);this.log("found multiaddrs for %p in the peer routing",t,o.map(({multiaddr:d})=>d.toString())),o.push(...f.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",t):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",t,f)}}}let s=(await Promise.all(o.map(async f=>{let d=await Nh(f.multiaddr,{dns:this.components.dns,...n,log:this.log});return d.length===1&&d[0].equals(f.multiaddr)?f:d.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(t!=null){let f=`/p2p/${t.toString()}`;s=s.map(d=>d.multiaddr.protos().pop()?.path===!0?d:d.multiaddr.getPeerId()==null?{multiaddr:d.multiaddr.encapsulate(f),isCertified:d.isCertified}:d)}let i=s.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;let d=f.multiaddr.getPeerId();return t!=null&&d!=null?t.equals(d):!0}),a=new Map;for(let f of i){let d=f.multiaddr.toString(),g=a.get(d);if(g!=null){g.isCertified=g.isCertified||f.isCertified||!1;continue}a.set(d,f)}let c=[...a.values()];if(c.length===0)throw new ri("The dial request has no valid addresses");let l=[];for(let f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);let u=this.addressSorter==null?Fh(l):l.sort(this.addressSorter);if(u.length===0)throw new yo("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",t??"unknown peer",s.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",u.map(({multiaddr:f})=>f.toString())),u}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{let n=await this.calculateMultiaddrs(void 0,new Set(t.map(o=>o.toString())),e);return e.runOnLimitedConnection===!1?n.find(o=>!mo.matches(o.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}};var xi=class extends dn{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}};var $h=_o(Vh(),1);var ew=Object.prototype.toString,rw=r=>ew.call(r)==="[object Error]",nw=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function jl(r){return r&&rw(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:nw.has(r.message):!1}var Xl=class extends Error{constructor(t){super(),t instanceof Error?(this.originalError=t,{message:t}=t):(this.originalError=new Error(t),this.originalError.stack=this.stack),this.name="AbortError",this.message=t}},Hh=(r,t,e)=>{let n=e.retries-(t-1);return r.attemptNumber=t,r.retriesLeft=n,r};async function Yl(r,t){return new Promise((e,n)=>{t={...t},t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.retries??=10;let o=$h.default.operation(t),s=()=>{o.stop(),n(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",s,{once:!0});let i=()=>{t.signal?.removeEventListener("abort",s),o.stop()};o.attempt(async a=>{try{let c=await r(a);i(),e(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof Xl)throw c.originalError;if(c instanceof TypeError&&!jl(c))throw c;if(Hh(c,a,t),await t.shouldRetry(c)||(o.stop(),n(c)),await t.onFailedAttempt(c),!o.retry(c))throw o.mainError()}catch(l){Hh(l,a,t),i(),n(l)}}})})}var Ei=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.queue=new xi({concurrency:e.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:t.metrics}),this.started=!1,this.retries=e.retries??5,this.backoffFactor=e.backoffFactor,this.retryInterval=e.retryInterval,this.events=t.events,t.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(o=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,o)})})}async maybeReconnect(t){if(!this.started)return;let e=await this.peerStore.get(t);Gh(e)&&(this.queue.has(t)||this.queue.add(async n=>{await Yl(async o=>{if(this.started)try{await this.connectionManager.openConnection(t,{signal:n?.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",t,o,this.retries,s),s}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:t}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",t,n);let o={};[...e.tags.keys()].forEach(s=>{s.startsWith(Yi)&&(o[s]=void 0)}),await this.peerStore.merge(t,{tags:o}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:t})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",t,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let t=await this.peerStore.all({filters:[e=>Gh(e)]});await Promise.all(t.map(async e=>{await this.connectionManager.openConnection(e.id).catch(n=>{this.log.error(n)})}))}).catch(t=>{this.log.error(t)})}stop(){this.started=!1,this.queue.abort()}};function Gh(r){for(let t of r.tags.keys())if(t.startsWith(Yi))return!0;return!1}var Wl=50,Zl={maxConnections:ui,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},vi=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(t,e={}){if(this.maxConnections=e.maxConnections??Zl.maxConnections,this.maxConnections<1)throw new M("Connection Manager maxConnections must be greater than 0");this.connections=new Ae,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(e.allow??[]).map(n=>wo(n)),this.deny=(e.deny??[]).map(n=>wo(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??Zl.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new ci({points:e.inboundConnectionThreshold??Zl.inboundConnectionThreshold,duration:1}),this.connectionPruner=new di({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{maxConnections:this.maxConnections,allow:e.allow?.map(n=>j(n))}),this.dialQueue=new bi(t,{addressSorter:e.addressSorter,maxParallelDials:e.maxParallelDials??fi,maxDialQueueLength:e.maxDialQueueLength??500,maxPeerAddrsToDial:e.maxPeerAddrsToDial??25,dialTimeout:e.dialTimeout??1e4,resolvers:e.resolvers??{dnsaddr:lr},connections:this.connections}),this.reconnectQueue=new Ei({events:t.events,peerStore:t.peerStore,logger:t.logger,connectionManager:this},{retries:e.reconnectRetries,retryInterval:e.reconnectRetryInterval,backoffFactor:e.reconnectBackoffFactor,maxParallelReconnects:e.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let t={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let e of this.connections.values())for(let n of e)t[n.direction]++;return t}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let t={};for(let e of this.connections.values())for(let n of e)for(let o of n.streams){let s=`${o.direction} ${o.protocol??"unnegotiated"}`;t[s]=(t[s]??0)+1}return t}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let t={};for(let n of this.connections.values())for(let o of n){let s={};for(let i of o.streams){let a=`${i.direction} ${i.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(let[i,a]of Object.entries(s))t[i]=t[i]??[],t[i].push(a)}let e={};for(let[n,o]of Object.entries(t)){o=o.sort((i,a)=>i-a);let s=Math.floor(o.length*.9);e[n]=o[s]}return e}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await uu(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await fu(this.reconnectQueue,this.dialQueue,this.connectionPruner);let t=[];for(let e of this.connections.values())for(let n of e)t.push((async()=>{try{await n.close()}catch(o){this.log.error(o)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){let{detail:e}=t;if(!this.started){await e.close();return}if(e.status!=="open")return;let n=e.remotePeer,o=!this.connections.has(n),s=this.connections.get(n)??[];s.push(e),this.connections.set(n,s),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){let{detail:e}=t,n=e.remotePeer,s=(this.connections.get(n)??[]).filter(i=>i.id!==e.id);this.connections.set(n,s),s.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(let n of this.connections.values())e=e.concat(n);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){if(!this.started)throw new de("Not started");this.outboundPendingConnections++;try{e.signal?.throwIfAborted();let{peerId:n}=li(t);if(this.peerId.equals(n))throw new Tr("Can not dial self");if(n!=null&&e.force!==!0){this.log("dial %p",n);let a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),e.onProgress?.(new dt("dial-queue:already-connected")),a}let o=await this.dialQueue.dial(t,{...e,priority:e.priority??Wl});if(o.status!=="open")throw new Pr("Remote closed connection during opening");let s=this.connections.get(o.remotePeer);s==null&&(s=[],this.connections.set(o.remotePeer,s));let i=!1;for(let a of s)if(a.id===o.id&&(i=!0),e.force!==!0&&a.id!==o.id&&a.remoteAddr.equals(o.remoteAddr))return o.abort(new Te("Duplicate multiaddr connection")),a;return i||s.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(t,e={}){let n=this.connections.get(t)??[];await Promise.all(n.map(async o=>{try{await o.close(e)}catch(s){o.abort(s)}}))}async acceptIncomingConnection(t){if(this.deny.some(o=>o.contains(t.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(o=>o.contains(t.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){let o=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(o,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,o),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(n=>j(n))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}};var hn=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(t){this.timeSpan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timeSpan)}push(t,e=Date.now()){if(this.previousTime!=null){let n=this.alpha(e,this.previousTime),o=t-this.movingAverage,s=n*o;this.movingAverage=n*t+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+o*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*o}else this.movingAverage=t;this.previousTime=e}};var iw=1.2,aw=2,cw=5e3,Si=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;constructor(t={}){this.success=new hn(t.interval??5e3),this.failure=new hn(t.interval??5e3),this.next=new hn(t.interval??5e3),this.failureMultiplier=t.failureMultiplier??aw,this.timeoutMultiplier=t.timeoutMultiplier??iw,this.minTimeout=t.minTimeout??cw,t.metricName!=null&&(this.metric=t.metrics?.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){let e=Math.max(Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(e),o=Pe([t.signal,n]);return o.start=Date.now(),o.timeout=e,o}cleanUp(t){let e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}};var Ql=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=lt(),this.haveNext=lt()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=lt(),t}async throw(t){return this.ended=!0,this.error=t,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){let t={done:!0,value:void 0};return this.ended=!0,this.nextResult=t,this.haveNext.resolve(),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=lt(),await se(this.readNext.promise,e?.signal,e)}};function Ai(){return new Ql}var _i=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Ii(r,t){let e=Ai();r.sink(e).catch(async i=>{await e.end(i)}),r.sink=async i=>{for await(let a of i)await e.push(a);await e.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());let o=new Y;return{read:async i=>{if(i?.signal?.throwIfAborted(),i?.bytes==null){let{done:c,value:l}=await se(n.next(),i?.signal);return c===!0?null:l}for(;o.byteLength<i.bytes;){let{value:c,done:l}=await se(n.next(),i?.signal);if(l===!0)throw new _i("unexpected end of input");o.append(c)}let a=o.sublist(0,i.bytes);return o.consume(i.bytes),a},write:async(i,a)=>{a?.signal?.throwIfAborted(),i instanceof Uint8Array?await e.push(i,a):await e.push(i.subarray(),a)},unwrap:()=>{if(o.byteLength>0){let i=r.source;r.source=async function*(){t?.yieldBytes===!1?yield o:yield*o,yield*i}()}return r}}}var lw=1e4,uw="1.0.0",fw="ping",dw="ipfs",Wh=32,hw=!0,Ci=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(t,e={}){this.components=t,this.protocol=`/${e.protocolPrefix??dw}/${fw}/${uw}`,this.log=t.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=e.pingInterval??lw,this.abortConnectionOnPingFailure=e.abortConnectionOnPingFailure??hw,this.timeout=new Si({...e.pingTimeout??{},metrics:t.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[wn]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(t=>{Promise.resolve().then(async()=>{let e=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),o=await t.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),s=Ii(o);e=Date.now(),await Promise.all([s.write($r(Wh),{signal:n}),s.read({bytes:Wh,signal:n})]),t.rtt=Date.now()-e,await s.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;t.rtt=(Date.now()-e)/2}}).catch(e=>{this.log.error("error during heartbeat",e),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),t.abort(e)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};function pw(r){return r[Symbol.asyncIterator]!=null}async function mw(r,t,e){try{await Promise.all(r.map(async n=>{for await(let o of n)await t.push(o,{signal:e}),e.throwIfAborted()})),await t.end(void 0,{signal:e})}catch(n){await t.end(n,{signal:e}).catch(()=>{})}}async function*gw(r){let t=new AbortController,e=Ai();mw(r,e,t.signal).catch(()=>{});try{yield*e}finally{t.abort()}}function*yw(r){for(let t of r)yield*t}function ww(...r){let t=[];for(let e of r)pw(e)||t.push(e);return t.length===r.length?yw(t):gw(r)}var bo=ww;var Pi=class{routers;started;components;constructor(t,e){this.routers=e.routers??[],this.started=!1,this.components=t,this.findProviders=t.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()}),getAttributesFromYieldedValue:(n,o)=>({...o,providers:[...Array.isArray(o.providers)?o.providers:[],n.id.toString()]})})??this.findProviders,this.provide=t.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.provide,this.cancelReprovide=t.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.cancelReprovide,this.put=t.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:B(n,"base36")})})??this.put,this.get=t.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:B(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new cn("No content routers available");let n=this,o=new fr;for await(let s of bo(...n.routers.filter(i=>i.findProviders instanceof Function).map(i=>i.findProviders(t,e))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!o.has(s.id)&&(o.add(s.id),yield s))}async provide(t,e={}){if(this.routers.length===0)throw new cn("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(t,e)}))}async cancelReprovide(t,e={}){if(this.routers.length===0)throw new cn("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(t,e)}))}async put(t,e,n){if(!this.isStarted())throw new de;await Promise.all(this.routers.filter(o=>o.put instanceof Function).map(async o=>{await o.put(t,e,n)}))}async get(t,e){if(!this.isStarted())throw new de;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(t,e)))}};var Ti=globalThis.CustomEvent??Event;async function*Jl(r,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);let n=t.ordered??!1,o=new EventTarget,s=[],i=lt(),a=lt(),c=!1,l,u=!1;o.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let p of r){if(s.length===e&&(i=lt(),await i.promise),u)break;let m={done:!1};s.push(m),p().then(w=>{m.done=!0,m.ok=!0,m.value=w,o.dispatchEvent(new Ti("task-complete"))},w=>{m.done=!0,m.err=w,o.dispatchEvent(new Ti("task-complete"))})}c=!0,o.dispatchEvent(new Ti("task-complete"))}catch(p){l=p,o.dispatchEvent(new Ti("task-complete"))}});function f(){return n?s[0]?.done:!!s.find(p=>p.done)}function*d(){for(;s.length>0&&s[0].done;){let p=s[0];if(s.shift(),p.ok)yield p.value;else throw u=!0,i.resolve(),p.err;i.resolve()}}function*g(){for(;f();)for(let p=0;p<s.length;p++)if(s[p].done){let m=s[p];if(s.splice(p,1),p--,m.ok)yield m.value;else throw u=!0,i.resolve(),m.err;i.resolve()}}for(;;){if(f()||(a=lt(),await a.promise),l!=null||(n?yield*d():yield*g(),l!=null))throw l;if(c&&s.length===0)break}}var Li=class{log;peerId;peerStore;routers;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[],this.findPeer=t.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,peer:n.toString()})})??this.findPeer,this.getClosestPeers=t.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,key:B(n,"base36")}),getAttributesFromYieldedValue:(n,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(t,e){if(this.routers.length===0)throw new go("No peer routers available");if(t.toString()===this.peerId.toString())throw new Zs("Should not try to find self");let n=this,o=bo(...this.routers.filter(s=>s.findPeer instanceof Function).map(s=>async function*(){try{yield await s.findPeer(t,e)}catch(i){n.log.error(i)}}()));for await(let s of o)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),s;throw new Ge}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new go("No peer routers available");let n=this,o=no(1024);for await(let s of Jl(async function*(){let i=bo(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(t,e)));for await(let a of i)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...e,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!o.has(s.id.toMultihash().bytes)&&(o.add(s.id.toMultihash().bytes),yield s))}};var Di=class extends he{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(t){super(),this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){this.walking||this.startWalk(),this.walkers++;let e=Pe([this.shutdownController.signal,t?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=lt(),yield(await un(this,"walk:peer",e,{errorEvent:"walk:error"})).detail}finally{e.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let t=Pe([this.walkController.signal,this.shutdownController.signal]);let e=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=$r(32),s=Date.now();for await(let i of this.peerRouting.getClosestPeers(o,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",i.id,Date.now()-s,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:i}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await se(this.needNext.promise,t)),s=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,n)}catch(o){this.log.error("random walk errored",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-e),this.walking=!1})}};var tu=32,eu=64,ki=class{log;topologies;handlers;components;constructor(t){this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){let e=this.handlers.get(t);if(e==null)throw new Qs(`No handler registered for protocol ${t}`);return e}getTopologies(t){let e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,n){if(this.handlers.has(t)&&n?.force!==!0)throw new Js(`Handler already registered for protocol ${t}`);let o=cs.bind({ignoreUndefined:!0})({maxInboundStreams:tu,maxOutboundStreams:eu},n);this.handlers.set(t,{handler:e,options:o}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]})}async unhandle(t){(Array.isArray(t)?t:[t]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(t,e){if(e==null)throw new M("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,o=this.topologies.get(t);return o==null&&(o=new Map,this.topologies.set(t,o)),o.set(n,e),n}unregister(t){for(let[e,n]of this.topologies.entries())n.has(t)&&(n.delete(t),n.size===0&&this.topologies.delete(e))}_onDisconnect(t){let e=t.detail;this.components.peerStore.get(e).then(n=>{for(let o of n.protocols){let s=this.topologies.get(o);if(s!=null)for(let i of s.values())i.filter?.has(e)!==!1&&(i.filter?.remove(e),i.onDisconnect?.(e))}}).catch(n=>{n.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",e,n)})}_onPeerUpdate(t){let{peer:e,previous:n}=t.detail,o=(n?.protocols??[]).filter(s=>!e.protocols.includes(s));for(let s of o){let i=this.topologies.get(s);if(i!=null)for(let a of i.values())a.filter?.has(e.id)!==!1&&(a.filter?.remove(e.id),a.onDisconnect?.(e.id))}}_onPeerIdentify(t){let e=t.detail.protocols,n=t.detail.connection,o=t.detail.peerId;for(let s of e){let i=this.topologies.get(s);if(i!=null)for(let a of i.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(o)!==!0&&(a.filter?.add(o),a.onConnect?.(o,n))}}};var ru=class extends Map{metric;constructor(t){super();let{name:e,metrics:n}=t;this.metric=n.registerMetric(e),this.updateComponentMetric()}set(t,e){return super.set(t,e),this.updateComponentMetric(),this}delete(t){let e=super.delete(t);return this.updateComponentMetric(),e}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function jh(r){let{name:t,metrics:e}=r,n;return e!=null?n=new ru({name:t,metrics:e}):n=new Map,n}var Mi=class{log;components;transports;listeners;faultTolerance;started;constructor(t,e={}){this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=new Map,this.listeners=jh({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??$e.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(t){let e=t[Symbol.toStringTag];if(e==null)throw new M("Transport must have a valid tag");if(this.transports.has(e))throw new M(`There is already a transport with the tag ${e}`);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){let t=[];for(let[e,n]of this.listeners)for(this.log("closing listeners for %s",e);n.length>0;){let o=n.pop();o!=null&&t.push(o.close())}await Promise.all(t),this.log("all listeners closed");for(let e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){let n=this.dialTransportForMultiaddr(t);if(n==null)throw new si(`No transport available for address ${String(t)}`);return e?.onProgress?.(new dt("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(t,{...e,upgrader:this.components.upgrader})}getAddrs(){let t=[];for(let e of this.listeners.values())for(let n of e)t=[...t,...n.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(let e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(let e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new de("Not started");if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let e={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};t.forEach(s=>{e.errors.set(s.toString(),new ti)});let n=[];for(let[s,i]of this.transports.entries()){let a=i.listenFilter(t);for(let c of a){this.log("creating listener for %s on %a",s,c);let l=i.createListener({upgrader:this.components.upgrader}),u=this.listeners.get(s)??[];u==null&&(u=[],this.listeners.set(s,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let f=u.findIndex(d=>d===l);u.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),Il.matches(c)?e.ipv4.attempts++:Cl.matches(c)&&e.ipv6.attempts++,n.push(l.listen(c).then(()=>{e.errors.delete(c.toString()),Il.matches(c)&&e.ipv4.success++,Cl.matches(c)&&e.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,f),e.errors.set(c.toString(),f),f}))}}let o=await Promise.allSettled(n);if(!(o.length>0&&o.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(e)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===$e.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new ei(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...e.errors.entries()].map(([s,i])=>`
  ${s}: ${`${i.stack??i}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(t){if(t.ipv4.attempts===0||t.ipv6.attempts===0)return!1;let e=t.ipv4.attempts===t.ipv4.success,n=t.ipv6.success===0;return e&&n}async remove(t){let e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);let n=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){let o=e.pop();o!=null&&n.push(o.close())}await Promise.all(n),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){let t=[];for(let e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}};var Et="/multistream/1.0.0";var Ri=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Ni=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Oi=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function xo(r,t={}){let e=Ii(r,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=mt(t.maxDataLength));let n=t?.lengthDecoder??te,o=t?.lengthEncoder??_t;return{read:async i=>{let a=-1,c=new Y;for(;;){c.append(await e.read({...i,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new Ri("Invalid message length");if(t?.maxLengthLength!=null&&c.byteLength>t.maxLengthLength)throw new Oi("message length length too long");if(a>-1)break}if(t?.maxDataLength!=null&&a>t.maxDataLength)throw new Ni("message length too long");return e.read({...i,bytes:a})},write:async(i,a)=>{await e.write(new Y(o(i.byteLength),i),a)},writeV:async(i,a)=>{let c=new Y(...i.flatMap(l=>[o(l.byteLength),l]));await e.write(c,a)},unwrap:()=>e.unwrap()}}var bw=L(`
`);async function Ar(r,t,e){await r.write(t,e)}async function Xh(r,t,e){await r.writeV(t,e)}async function xw(r,t){let e=await r.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==bw[0])throw t.log.error("Invalid mss message - missing newline",e),new Do("Missing newline");return e.sublist(0,-1)}async function He(r,t){let e=await xw(r,t);return B(e.subarray())}async function Eo(r,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return Ew(r,t[0],e);let n=xo(r,{...e,maxDataLength:1024}),o=t.shift();if(o==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',Et,o);let s=L(`${Et}
`),i=L(`${o}
`);await Xh(n,[s,i],e),e.log.trace("select: reading multistream-select header");let a=await He(n,e);if(e.log.trace('select: read "%s"',a),a===Et&&(e.log.trace("select: reading protocol response"),a=await He(n,e),e.log.trace('select: read "%s"',a)),a===o)return{stream:n.unwrap(),protocol:o};for(let c of t){e.log.trace('select: write "%s"',c),await Ar(n,L(`${c}
`),e),e.log.trace("select: reading protocol response");let l=await He(n,e);if(e.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new yn("protocol selection failed")}function Ew(r,t,e){let n=r.sink.bind(r),o=r.source,s=!1,i=!1,a=lt(),c=!1,l=!1,u=lt(),f=!1,d=!1,g=lt(),p=xo({sink:n,source:o},{...e,maxDataLength:1024});r.sink=async C=>{let{sink:x}=p.unwrap();await x(async function*(){let h=!1;for await(let b of C){if(l&&await u.promise,c)yield b;else{l=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Et,t,b.byteLength);let P=`${t}
`;yield new Y(Uint8Array.from([19]),L(`${Et}
`),_t(P.length),L(P),b).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Et,t,b.byteLength),c=!0,l=!1,u.resolve(),m().catch(T=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,T)})}h=!0}h||await m()}())};async function m(){if(i){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}i=!0;try{c||(e.log.trace("optimistic: doing send protocol for %s stream",t),await w()),f||(e.log.trace("optimistic: doing read protocol for %s stream",t),await v())}finally{i=!1,s=!0,a.resolve()}}async function w(){if(l){await u.promise;return}l=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',Et,t),await p.writeV([L(`${Et}
`),L(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',Et,t)}finally{c=!0,l=!1,u.resolve()}}async function v(){if(d){await g.promise;return}d=!0;try{e.log.trace("optimistic: reading multistream select header");let C=await He(p,e);if(e.log.trace('optimistic: read multistream select header "%s"',C),C===Et&&(C=await He(p,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',C,t),C!==t)throw new yn("protocol selection failed")}finally{f=!0,d=!1,g.resolve()}}if(r.source=async function*(){await m(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),r.closeRead!=null){let C=r.closeRead.bind(r);r.closeRead=async x=>{s||await m().catch(h=>{e.log.error("could not negotiate protocol before close read",h)}),await C(x)}}if(r.closeWrite!=null){let C=r.closeWrite.bind(r);r.closeWrite=async x=>{s||await m().catch(h=>{e.log.error("could not negotiate protocol before close write",h)}),await C(x)}}if(r.close!=null){let C=r.close.bind(r);r.close=async x=>{let h=[];l&&h.push(u.promise),d&&h.push(g.promise),h.length>0?await se(Promise.all(h),x?.signal):(s=!0,i=!1,a.resolve()),await C(x)}}return{stream:r,protocol:t}}var Bi=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},pn=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Fi=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},vo=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Ui(r){return r[Symbol.asyncIterator]!=null}function Zh(r,t){if(r.byteLength>t)throw new pn("Message length too long")}var qi=r=>{let t=mt(r),e=St(t);return _t(r,e),qi.bytes=t,e};qi.bytes=0;function zi(r,t){t=t??{};let e=t.lengthEncoder??qi,n=t?.maxDataLength??4194304;function*o(s){Zh(s,n);let i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return Ui(r)?async function*(){for await(let s of r)yield*o(s)}():function*(){for(let s of r)yield*o(s)}()}zi.single=(r,t)=>{t=t??{};let e=t.lengthEncoder??qi,n=t?.maxDataLength??4194304;return Zh(r,n),new Y(e(r.byteLength),r)};var _r;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(_r||(_r={}));var su=r=>{let t=te(r);return su.bytes=mt(t),t};su.bytes=0;function ou(r,t){let e=new Y,n=_r.LENGTH,o=-1,s=t?.lengthDecoder??su,i=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*c(){for(;e.byteLength>0;){if(n===_r.LENGTH)try{if(o=s(e),o<0)throw new Bi("Invalid message length");if(o>a)throw new pn("Message length too long");let l=s.bytes;e.consume(l),t?.onLength!=null&&t.onLength(o),n=_r.DATA}catch(l){if(l instanceof RangeError){if(e.byteLength>i)throw new Fi("Message length length too long");break}throw l}if(n===_r.DATA){if(e.byteLength<o)break;let l=e.sublist(0,o);e.consume(o),t?.onData!=null&&t.onData(l),yield l,n=_r.LENGTH}}}return Ui(r)?async function*(){for await(let l of r)e.append(l),yield*c();if(e.byteLength>0)throw new vo("Unexpected end of input")}():function*(){for(let l of r)e.append(l),yield*c();if(e.byteLength>0)throw new vo("Unexpected end of input")}()}ou.fromReader=(r,t)=>{let e=1,n=async function*(){for(;;)try{let{done:s,value:i}=await r.next(e);if(s===!0)return;i!=null&&(yield i)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{e=1}}();return ou(n,{...t??{},onLength:s=>{e=s}})};async function So(r,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);let n=xo(r,{...e,maxDataLength:1024,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");let o=await He(n,e);if(e.log.trace('handle: read "%s"',o),o===Et){e.log.trace('handle: respond with "%s" for "%s"',Et,o),await Ar(n,L(`${Et}
`),e),e.log.trace('handle: responded with "%s" for "%s"',Et,o);continue}if(t.includes(o))return e.log.trace('handle: respond with "%s" for "%s"',o,o),await Ar(n,L(`${o}
`),e),e.log.trace('handle: responded with "%s" for "%s"',o,o),{stream:n.unwrap(),protocol:o};if(o==="ls"){let s=new Y(...t.map(i=>zi.single(L(`${i}
`))),L(`
`));e.log.trace('handle: respond with "%s" for %s',t,o),await Ar(n,s,e),e.log.trace('handle: responded with "%s" for %s',t,o);continue}e.log.trace('handle: respond with "na" for "%s"',o),await Ar(n,L(`na
`),e),e.log('handle: responded with "na" for "%s"',o)}}var Aw=500,iu=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(t){let{remoteAddr:e,remotePeer:n,newStream:o,close:s,abort:i,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=n,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.limits=t.limits,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=o,this._close=s,this._abort=i,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[lu]=!0;get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new Po("the connection is being closed");if(this.status==="closed")throw new Pr("the connection is closed");if(Array.isArray(t)||(t=[t]),this.limits!=null&&e?.runOnLimitedConnection!==!0)throw new Dr("Cannot open protocol stream on limited connection");let n=await this._newStream(t,e);return n.direction="outbound",n}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){let e=AbortSignal.timeout(Aw);t={...t,signal:e}}try{this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this._abort(t),this.status="closed",this.timeline.close=Date.now())}};function Qh(r){return new iu(r)}function Iw(r,t){try{let{options:e}=t.getHandler(r);return e.maxInboundStreams}catch(e){if(e.name!=="UnhandledProtocolError")throw e}return tu}function Cw(r,t,e={}){try{let{options:n}=t.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return e.maxOutboundStreams??eu}function Jh(r,t,e){let n=0;return e.streams.forEach(o=>{o.direction===t&&o.protocol===r&&n++}),n}var Vi=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(t,e){this.components=t,this.connectionEncrypters=new Map,e.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=new Map,e.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=e.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=e.outboundStreamProtocolNegotiationTimeout??1e4,this.events=t.events,this.metrics={dials:t.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:t.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(t,...e){let n=this.components.connectionGater[t];if(n==null)return;if(await n.apply(this.components.connectionGater,e)===!0)throw new ni(`The multiaddr connection is blocked by gater.${t}`)}createInboundAbortSignal(t){let e=Pe([AbortSignal.timeout(this.inboundUpgradeTimeout),t]);return e}async upgradeInbound(t,e){let n=!1,o=this.createInboundAbortSignal(e.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await this.components.connectionManager.acceptIncomingConnection(t),!n)throw new oi("Connection denied");await this.shouldBlockConnection("denyInboundConnection",t),await this._performUpgrade(t,"inbound",{...e,signal:o})}catch(s){throw this.metrics.errors?.increment({inbound:!0}),s}finally{o.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){try{this.metrics.dials?.increment({outbound:!0});let n=t.remoteAddr.getPeerId(),o;n!=null&&(o=fe(n),await this.shouldBlockConnection("denyOutboundConnection",o,t));let s="outbound";return e.initiator===!1&&(s="inbound"),await this._performUpgrade(t,s,e)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),n}}async _performUpgrade(t,e,n){let o,s,i,a,c;this.components.metrics?.trackMultiaddrConnection(t),t.log.trace("starting the %s connection upgrade",e);let l=t;if(n?.skipProtection!==!0){let u=this.components.connectionProtector;u!=null&&(t.log("protecting the %s connection",e),l=await u.protect(t,n))}try{if(o=l,n?.skipEncryption!==!0){n?.onProgress?.(new dt(`upgrader:encrypt-${e}-connection`)),{conn:o,remotePeer:s,protocol:c,streamMuxer:a}=await(e==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));let u={...l,...o};await this.shouldBlockConnection(e==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,u)}else{let u=t.remoteAddr.getPeerId();if(u==null)throw new Te(`${e} connection that skipped encryption must have a peer id`);let f=fe(u);c="native",s=f}if(s.equals(this.components.peerId)){let u=new Tr("Can not dial self");throw t.abort(u),u}if(i=o,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new dt(`upgrader:multiplex-${e}-connection`));let u=await(e==="inbound"?this._multiplexInbound({...l,...o},this.streamMuxers,n):this._multiplexOutbound({...l,...o},this.streamMuxers,n));a=u.muxerFactory,i=u.stream}}catch(u){throw t.log.error("failed to upgrade inbound connection %s %a - %e",e==="inbound"?"from":"to",t.remoteAddr,u),u}return await this.shouldBlockConnection(e==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,t),t.log("successfully upgraded %s connection",e),this._createConnection({cryptoProtocol:c,direction:e,maConn:t,upgradedConn:i,muxerFactory:a,remotePeer:s,limits:n?.limits})}_createConnection(t){let{cryptoProtocol:e,direction:n,maConn:o,upgradedConn:s,remotePeer:i,muxerFactory:a,limits:c}=t,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:p=>{f!=null&&Promise.resolve().then(async()=>{let m=this.components.registrar.getProtocols(),w=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);let{stream:v,protocol:C}=await So(p,m,{signal:w,log:p.log,yieldBytes:!1});if(f==null)return;f.log("incoming stream opened on %s",C);let x=Iw(C,this.components.registrar);if(Jh(C,"inbound",f)===x){let b=new Mo(`Too many inbound protocol streams for protocol "${C}" - limit ${x}`);throw p.abort(b),b}p.source=v.source,p.sink=v.sink,p.protocol=C,v.closeWrite!=null&&(p.closeWrite=v.closeWrite),v.closeRead!=null&&(p.closeRead=v.closeRead),v.close!=null&&(p.close=v.close),await this.components.peerStore.merge(i,{protocols:[C]}),this.components.metrics?.trackProtocolStream(p,f),this._onStream({connection:f,stream:p,protocol:C})}).catch(async m=>{f.log.error("error handling incoming stream id %s - %e",p.id,m),p.timeline.close==null&&await p.close()})}}),u=async(p,m={})=>{if(l==null)throw new Er("Connection is not multiplexed");f.log.trace("starting new stream for protocols %s",p);let w=await l.newStream();f.log.trace("started new stream %s for protocols %s",w.id,p);try{if(m.signal==null){w.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p);let b=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);m={...m,signal:b}}w.log.trace("selecting protocol from protocols %s",p);let{stream:v,protocol:C}=await Eo(w,p,{...m,log:w.log,yieldBytes:!0});w.log.trace("selected protocol %s",C);let x=Cw(C,this.components.registrar,m),h=Jh(C,"outbound",f);if(h>=x){let b=new Ro(`Too many outbound protocol streams for protocol "${C}" - ${h}/${x}`);throw w.abort(b),b}return await this.components.peerStore.merge(i,{protocols:[C]}),w.source=v.source,w.sink=v.sink,w.protocol=C,v.closeWrite!=null&&(w.closeWrite=v.closeWrite),v.closeRead!=null&&(w.closeRead=v.closeRead),v.close!=null&&(w.close=v.close),this.components.metrics?.trackProtocolStream(w,f),w}catch(v){throw f.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",t.maConn.remoteAddr,p,v),w.timeline.close==null&&w.abort(v),v}},Promise.all([l.sink(s.source),s.sink(l.source)]).catch(p=>{f.log.error("error piping data through muxer - %e",p)}));let d=o.timeline;o.timeline=new Proxy(d,{set:(...p)=>(p[1]==="close"&&p[2]!=null&&d.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(m){f.log.error("error closing connection after timeline close %e",m)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(m=>{f.log.error("error thrown while dispatching connection:close event %e",m)}),Reflect.set(...p))}),o.timeline.upgraded=Date.now();let g=()=>{throw new Er("Connection is not multiplexed")};return f=Qh({remoteAddr:o.remoteAddr,remotePeer:i,status:"open",direction:n,timeline:o.timeline,multiplexer:l?.protocol,encryption:e,limits:c,logger:this.components.logger,newStream:u??g,getStreams:()=>l?.streams??[],close:async p=>{await l?.close(p),await o.close(p)},abort:p=>{o.abort(p),l?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f.__maConnTimeline=d,f}_onStream(t){let{connection:e,stream:n,protocol:o}=t,{handler:s,options:i}=this.components.registrar.getHandler(o);if(e.limits!=null&&i.runOnLimitedConnection!==!0)throw new Dr("Cannot open protocol stream on limited connection");s({connection:e,stream:n})}async _encryptInbound(t,e){let n=Array.from(this.connectionEncrypters.keys());try{let{stream:o,protocol:s}=await So(t,n,{...e,log:t.log}),i=this.connectionEncrypters.get(s);if(i==null)throw new vr(`no crypto module found for ${s}`);return t.log("encrypting inbound connection to %a using %s",t.remoteAddr,s),{...await i.secureInbound(o,e),protocol:s}}catch(o){throw t.log.error("encrypting inbound connection from %a failed",t.remoteAddr,o),new vr(o.message)}}async _encryptOutbound(t,e){let n=Array.from(this.connectionEncrypters.keys());try{t.log.trace("selecting encrypter from %s",n);let{stream:o,protocol:s}=await Eo(t,n,{...e,log:t.log,yieldBytes:!0}),i=this.connectionEncrypters.get(s);if(i==null)throw new vr(`no crypto module found for ${s}`);return t.log("encrypting outbound connection to %a using %s",t.remoteAddr,s),{...await i.secureOutbound(o,e),protocol:s}}catch(o){throw t.log.error("encrypting outbound connection to %a failed",t.remoteAddr,o),new vr(o.message)}}async _multiplexOutbound(t,e,n){let o=Array.from(e.keys());t.log("outbound selecting muxer %s",o);try{t.log.trace("selecting stream muxer from %s",o);let{stream:s,protocol:i}=await Eo(t,o,{...n,log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",i);let a=e.get(i);return{stream:s,muxerFactory:a}}catch(s){throw t.log.error("error multiplexing outbound connection",s),new Er(String(s))}}async _multiplexInbound(t,e,n){let o=Array.from(e.keys());t.log("inbound handling muxers %s",o);try{let{stream:s,protocol:i}=await So(t,o,{...n,log:t.log}),a=e.get(i);return{stream:s,muxerFactory:a}}catch(s){throw t.log.error("error multiplexing inbound connection",s),new Er(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};var Hi="2.8.7",$i="js-libp2p";function ep(r,t){return`${r??$i}/${t??Hi} browser/${globalThis.navigator.userAgent}`}var Gi=class extends he{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(t){super(),this.status="stopped";let e=new he,n=e.dispatchEvent.bind(e);e.dispatchEvent=l=>{let u=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||f},this.peerId=t.peerId,this.logger=t.logger??Ss(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=t.nodeInfo?.name??$i,s=t.nodeInfo?.version??Hi,i=this.components=Ch({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:o,version:s,userAgent:t.nodeInfo?.userAgent??ep(o,s)},logger:this.logger,events:e,datastore:t.datastore??new Bs,connectionGater:Th(t.connectionGater),dns:t.dns});this.peerStore=this.configureComponent("peerStore",uh(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),i.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};i.events.safeDispatchEvent("peer:discovery",{detail:u})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(i)),this.components.upgrader=new Vi(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(t.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:t.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:t.connectionManager?.inboundStreamProtocolNegotiationTimeout??t.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:t.connectionManager?.outboundStreamProtocolNegotiationTimeout??t.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new Mi(this.components,t.transportManager)),this.configureComponent("connectionManager",new vi(this.components,t.connectionManager)),t.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new Ci(this.components,t.connectionMonitor)),this.configureComponent("registrar",new ki(this.components)),this.configureComponent("addressManager",new js(this.components,t.addresses));let a=(t.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Li(this.components,{routers:a}));let c=(t.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Pi(this.components,{routers:c})),this.configureComponent("randomWalk",new Di(this.components)),(t.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",d=>{this.#t(d)})}),t.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),t.services!=null)for(let l of Object.keys(t.services)){let u=t.services[l],f=u(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[Wi]!=null&&(this.log("registering service %s for content routing",l),c.push(f[Wi])),f[Xi]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[Xi])),f[ji]!=null&&(this.log("registering service %s for peer discovery",l),f[ji].addEventListener?.("peer",d=>{this.#t(d)}))}Ph(i)}configureComponent(t,e){return e==null&&this.log.error("component %s was null or undefined",t),this.components[t]=e,e}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(t){throw this.log.error("An error occurred starting libp2p",t),this.status="started",await this.stop(),t}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let t=new fr;for(let e of this.components.connectionManager.getConnections())t.add(e.remotePeer);return Array.from(t)}async dial(t,e={}){return this.components.connectionManager.openConnection(t,{priority:75,...e})}async dialProtocol(t,e,n={}){if(e==null)throw new M("no protocols were provided to open a stream");if(e=Array.isArray(e)?e:[e],e.length===0)throw new M("no protocols were provided to open a stream");return(await this.dial(t,n)).newStream(e,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,e={}){Ke(t)&&(t=fe(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,e)}async getPublicKey(t,e={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{let i=await this.peerStore.get(t);if(i.id.publicKey!=null)return i.id.publicKey}catch(i){if(i.name!=="NotFoundError")throw i}let n=Tt([L("/pk/"),t.toMultihash().bytes]),o=await this.contentRouting.get(n,e),s=Wr(o);return await this.peerStore.patch(t,{publicKey:s}),s}async handle(t,e,n){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async o=>{await this.components.registrar.handle(o,e,n)}))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async e=>{await this.components.registrar.unhandle(e)}))}async register(t,e){return this.components.registrar.register(t,e)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,e={}){return this.components.connectionManager.isDialable(t,e)}#t(t){let{detail:e}=t;if(e.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(e.id,{multiaddrs:e.multiaddrs}).catch(n=>{this.log.error(n)})}};async function Pw(r={}){r.privateKey??=await ld("Ed25519");let t=new Gi({...await Kd(r),peerId:hd(r.privateKey)});return r.start!==!1&&await t.start(),t}return fp(Tw);})();
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
@noble/curves/esm/abstract/modular.js:
@noble/curves/esm/abstract/curve.js:
@noble/curves/esm/abstract/edwards.js:
@noble/curves/esm/ed25519.js:
@noble/curves/esm/abstract/weierstrass.js:
@noble/curves/esm/_shortw_utils.js:
@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
return Libp2P}));
//# sourceMappingURL=index.min.js.map
